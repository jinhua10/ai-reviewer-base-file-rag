# ğŸ” Ollama vs Hugging Face å¯¹æ¯”åˆ†æ & å½“å‰ç³»ç»Ÿè¯„ä¼°

## ğŸ“… æ–‡æ¡£ä¿¡æ¯
- **åˆ›å»ºæ—¶é—´**ï¼š2025å¹´12æœˆ4æ—¥
- **å¯¹æ¯”å¯¹è±¡**ï¼šOllamaã€Hugging Face Tokenizersã€å½“å‰ç³»ç»Ÿå®ç°
- **ç›®æ ‡**ï¼šé€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯æ ˆ

---

## ğŸ¯ ä¸€ã€Ollama vs Hugging Face è¯¦ç»†å¯¹æ¯”

### 1.1 æ ¸å¿ƒå·®å¼‚æ€»è§ˆ

| ç»´åº¦ | Ollama | Hugging Face (ONNX) | å½“å‰ç³»ç»Ÿ |
|------|--------|---------------------|----------|
| **å®šä½** | æœ¬åœ° LLM è¿è¡Œå¹³å° | ML æ¨¡å‹åº“ + æ¨ç†å¼•æ“ | OpenAI API å®¢æˆ·ç«¯ |
| **ä½¿ç”¨æ–¹å¼** | æœåŠ¡ç«¯ï¼ˆServerï¼‰ | åº“ï¼ˆLibraryï¼‰ | API è°ƒç”¨ï¼ˆRemoteï¼‰ |
| **éƒ¨ç½²æ–¹å¼** | ç‹¬ç«‹è¿›ç¨‹ | åµŒå…¥å¼ | æ— éœ€éƒ¨ç½² |
| **è¯­è¨€æ”¯æŒ** | REST APIï¼ˆä»»ä½•è¯­è¨€ï¼‰ | åŸç”Ÿ Java | HTTP å®¢æˆ·ç«¯ |
| **é€‚ç”¨åœºæ™¯** | å¤§æ¨¡å‹æœ¬åœ°éƒ¨ç½² | å°æ¨¡å‹åµŒå…¥å¼æ¨ç† | äº‘ç«¯ API è°ƒç”¨ |

---

### 1.2 æŠ€æœ¯æ¶æ„å¯¹æ¯”

#### æ–¹æ¡ˆAï¼šOllama

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Java Application             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   OkHttpClient / RestTemplate  â”‚  â”‚ â† HTTP å®¢æˆ·ç«¯
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ REST API (HTTP)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Ollama Server (ç‹¬ç«‹è¿›ç¨‹)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Model Loader                 â”‚  â”‚
â”‚  â”‚   - llama.cpp                  â”‚  â”‚
â”‚  â”‚   - GGUF format                â”‚  â”‚
â”‚  â”‚   - GPU acceleration (CUDA)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Models                       â”‚  â”‚
â”‚  â”‚   - Llama 2/3                  â”‚  â”‚
â”‚  â”‚   - Qwen                       â”‚  â”‚
â”‚  â”‚   - Mistral                    â”‚  â”‚
â”‚  â”‚   - è‡ªå®šä¹‰æ¨¡å‹                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ä¼˜åŠ¿**ï¼š
  - å¼€ç®±å³ç”¨ï¼Œä¸€é”®å¯åŠ¨
  - æ”¯æŒå¤§æ¨¡å‹ï¼ˆ7B-70B+ï¼‰
  - è‡ªåŠ¨æ¨¡å‹ç®¡ç†å’Œä¸‹è½½
  - GPU åŠ é€Ÿå¼€ç®±å³ç”¨
  - å¤šæ¨¡å‹çƒ­åˆ‡æ¢
  - ç¤¾åŒºæ´»è·ƒï¼Œæ¨¡å‹ä¸°å¯Œ

- âŒ **åŠ£åŠ¿**ï¼š
  - éœ€è¦ç‹¬ç«‹æœåŠ¡è¿›ç¨‹
  - ç½‘ç»œé€šä¿¡å¼€é”€
  - ä¾èµ–å¤–éƒ¨æœåŠ¡ç¨³å®šæ€§
  - æ— æ³•ç²¾ç»†æ§åˆ¶æ¨ç†è¿‡ç¨‹

#### æ–¹æ¡ˆBï¼šHugging Face (ONNX Runtime)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Java Application             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   PPLChunker / PPLReranker     â”‚  â”‚ â† ä½ çš„ä»£ç 
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚ ç›´æ¥è°ƒç”¨
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ONNX Runtime (Native)        â”‚  â”‚ â† C++ å¼•æ“
â”‚  â”‚   - GPU/CPU ä¼˜åŒ–               â”‚  â”‚
â”‚  â”‚   - é‡åŒ–æ”¯æŒ (INT8/FP16)       â”‚  â”‚
â”‚  â”‚   - æ‰¹å¤„ç†                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Model Files (.onnx)          â”‚  â”‚ â† æœ¬åœ°æ–‡ä»¶
â”‚  â”‚   - gpt2-medium.onnx           â”‚  â”‚
â”‚  â”‚   - chinese-bert.onnx          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Tokenizer                    â”‚  â”‚
â”‚  â”‚   - tokenizer.json             â”‚  â”‚
â”‚  â”‚   - vocab.txt                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ä¼˜åŠ¿**ï¼š
  - é›¶å¤–éƒ¨ä¾èµ–
  - åµŒå…¥å¼é›†æˆ
  - ç²¾ç¡®æ§åˆ¶æ¨ç†
  - ä½å»¶è¿Ÿï¼ˆæ— ç½‘ç»œå¼€é”€ï¼‰
  - é€‚åˆå°æ¨¡å‹ï¼ˆ<2Bï¼‰
  - æ˜“äºè°ƒè¯•å’Œç›‘æ§

- âŒ **åŠ£åŠ¿**ï¼š
  - éœ€è¦è‡ªè¡Œè½¬æ¢æ¨¡å‹
  - å¤§æ¨¡å‹æ”¯æŒæœ‰é™
  - æ‰‹åŠ¨ç®¡ç†æ¨¡å‹æ–‡ä»¶
  - GPU é…ç½®ç›¸å¯¹å¤æ‚

#### æ–¹æ¡ˆCï¼šå½“å‰ç³»ç»Ÿï¼ˆOpenAI APIï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Java Application             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   OpenAILLMClient              â”‚  â”‚ â† HTTP å®¢æˆ·ç«¯
â”‚  â”‚   - OkHttpClient               â”‚  â”‚
â”‚  â”‚   - JSON åºåˆ—åŒ–                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTPS (TLS)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      OpenAI API / DeepSeek API       â”‚ â† äº‘ç«¯æœåŠ¡
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   GPT-4o / DeepSeek-Chat       â”‚  â”‚
â”‚  â”‚   - æœ€å…ˆè¿›çš„è¯­è¨€ç†è§£            â”‚  â”‚
â”‚  â”‚   - æ— é™æ‰©å±•æ€§                  â”‚  â”‚
â”‚  â”‚   - æ— éœ€ç®¡ç†                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ä¼˜åŠ¿**ï¼š
  - é›¶éƒ¨ç½²æˆæœ¬
  - é¡¶çº§æ¨¡å‹èƒ½åŠ›
  - æ— éœ€ç¡¬ä»¶èµ„æº
  - è‡ªåŠ¨æ›´æ–°ä¼˜åŒ–
  - æŒ‰éœ€ä»˜è´¹

- âŒ **åŠ£åŠ¿**ï¼š
  - éœ€è¦ç½‘ç»œè¿æ¥
  - API è°ƒç”¨æˆæœ¬
  - æ•°æ®éšç§è€ƒè™‘
  - å»¶è¿Ÿä¸å¯æ§
  - ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡

---

### 1.3 ä½¿ç”¨åœºæ™¯å¯¹æ¯”

#### åœºæ™¯1ï¼šå¤§æ–‡æ¡£ PPL Chunkingï¼ˆç¦»çº¿å¤„ç†ï¼‰

| æ–¹æ¡ˆ | é€‚ç”¨æ€§ | ç†ç”± |
|------|--------|------|
| **Ollama** | â­â­â­â­ | æ”¯æŒå¤§æ¨¡å‹ï¼Œè¯­ä¹‰ç†è§£å¥½ |
| **HF (ONNX)** | â­â­â­â­â­ | å¿«é€Ÿã€ä½æˆæœ¬ã€é€‚åˆå°æ¨¡å‹ âœ… |
| **OpenAI API** | â­â­ | æˆæœ¬é«˜ï¼ˆ$0.10-0.50/æ–‡æ¡£ï¼‰ |

**æ¨è**ï¼š**Hugging Face (ONNX)** - å°æ¨¡å‹è¶³å¤Ÿï¼Œæˆæœ¬ä¸ºé›¶

#### åœºæ™¯2ï¼šå®æ—¶ PPL Rerankï¼ˆåœ¨çº¿å¤„ç†ï¼‰

| æ–¹æ¡ˆ | é€‚ç”¨æ€§ | ç†ç”± |
|------|--------|------|
| **Ollama** | â­â­â­ | å»¶è¿Ÿ 100-500msï¼Œå¯æ¥å— |
| **HF (ONNX)** | â­â­â­â­â­ | å»¶è¿Ÿ 30-150msï¼Œæœ€å¿« âœ… |
| **OpenAI API** | â­â­ | å»¶è¿Ÿ 1-3sï¼Œæˆæœ¬é«˜ |

**æ¨è**ï¼š**Hugging Face (ONNX)** - é€Ÿåº¦æœ€å¿«ï¼Œæˆæœ¬ä¸ºé›¶

#### åœºæ™¯3ï¼šæ™ºèƒ½é—®ç­”ï¼ˆç°æœ‰åŠŸèƒ½ï¼‰

| æ–¹æ¡ˆ | é€‚ç”¨æ€§ | ç†ç”± |
|------|--------|------|
| **Ollama** | â­â­â­â­ | å¯ä»¥æœ¬åœ°éƒ¨ç½²ï¼Œéšç§å¥½ |
| **HF (ONNX)** | â­â­ | å°æ¨¡å‹èƒ½åŠ›æœ‰é™ |
| **OpenAI API** | â­â­â­â­â­ | èƒ½åŠ›æœ€å¼ºï¼Œå½“å‰æ–¹æ¡ˆ âœ… |

**æ¨è**ï¼š**ç»§ç»­ä½¿ç”¨ OpenAI API** - è´¨é‡æœ€ä¼˜

---

### 1.4 ä»£ç å®ç°å¯¹æ¯”

#### ä½¿ç”¨ Ollama å®ç° PPL Chunker

```java
@Slf4j
public class OllamaPPLChunker implements DocumentChunker {
    
    private final RestTemplate restTemplate;
    private final String ollamaUrl = "http://localhost:11434";
    private final String model = "qwen:0.5b";
    
    @Override
    public List<DocumentChunk> chunk(String content, String query) {
        List<String> sentences = splitToSentences(content);
        List<DocumentChunk> chunks = new ArrayList<>();
        List<String> currentChunk = new ArrayList<>();
        double lastPPL = 0.0;
        
        for (String sentence : sentences) {
            currentChunk.add(sentence);
            
            // è°ƒç”¨ Ollama API è®¡ç®—å›°æƒ‘åº¦
            double ppl = calculatePerplexity(String.join(" ", currentChunk));
            
            if (ppl - lastPPL > threshold && currentChunk.size() > 1) {
                // åˆ‡åˆ†
                currentChunk.remove(currentChunk.size() - 1);
                chunks.add(createChunk(currentChunk, chunks.size()));
                currentChunk = new ArrayList<>();
                currentChunk.add(sentence);
            }
            lastPPL = ppl;
        }
        
        return chunks;
    }
    
    private double calculatePerplexity(String text) {
        // æ„å»ºè¯·æ±‚
        Map<String, Object> request = new HashMap<>();
        request.put("model", model);
        request.put("prompt", text);
        request.put("stream", false);
        request.put("options", Map.of(
            "temperature", 0.0,
            "num_predict", 1  // åªéœ€è¦è®¡ç®—å›°æƒ‘åº¦
        ));
        
        try {
            // å‘é€ HTTP è¯·æ±‚
            ResponseEntity<Map> response = restTemplate.postForEntity(
                ollamaUrl + "/api/generate",
                request,
                Map.class
            );
            
            // æå–å›°æƒ‘åº¦ï¼ˆéœ€è¦è§£æ responseï¼‰
            // æ³¨æ„ï¼šOllama ä¸ç›´æ¥è¿”å› PPLï¼Œéœ€è¦ä» logprobs è®¡ç®—
            Map<String, Object> result = response.getBody();
            // ... è§£æé€»è¾‘ ...
            
            return calculatedPPL;
            
        } catch (Exception e) {
            log.error("Ollama API è°ƒç”¨å¤±è´¥", e);
            return Double.MAX_VALUE;
        }
    }
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä»£ç ç®€å•ï¼ŒREST API è°ƒç”¨
- âŒ ç½‘ç»œå¼€é”€ï¼Œå»¶è¿Ÿè¾ƒé«˜
- âŒ éœ€è¦å¯åŠ¨ Ollama æœåŠ¡
- âŒ Ollama ä¸ç›´æ¥è¿”å› PPLï¼Œéœ€è¦è‡ªå·±è®¡ç®—

#### ä½¿ç”¨ Hugging Face (ONNX) å®ç°ï¼ˆæ¨èï¼‰

```java
@Slf4j
public class PPLChunker implements DocumentChunker {
    
    private final OrtEnvironment env;
    private final OrtSession session;
    private final HuggingFaceTokenizer tokenizer;
    
    public PPLChunker(String modelPath, String tokenizerPath) throws Exception {
        this.env = OrtEnvironment.getEnvironment();
        this.session = env.createSession(modelPath);
        this.tokenizer = HuggingFaceTokenizer.newInstance(Paths.get(tokenizerPath));
    }
    
    private double calculatePerplexity(String text) throws Exception {
        // 1. Tokenizeï¼ˆæœ¬åœ°ï¼Œæå¿«ï¼‰
        Encoding encoding = tokenizer.encode(text);
        long[] inputIds = encoding.getIds();
        
        // 2. æ¨¡å‹æ¨ç†ï¼ˆæœ¬åœ°ï¼ŒGPU åŠ é€Ÿï¼‰
        OnnxTensor inputTensor = OnnxTensor.createTensor(env, new long[][]{inputIds});
        Map<String, OnnxTensor> inputs = Map.of("input_ids", inputTensor);
        OrtSession.Result result = session.run(inputs);
        
        // 3. è®¡ç®—å›°æƒ‘åº¦ï¼ˆç›´æ¥è®¿é—® logitsï¼‰
        float[][][] logits = (float[][][]) result.get(0).getValue();
        
        double totalLogProb = 0.0;
        for (int i = 0; i < inputIds.length - 1; i++) {
            // Softmax + Log Prob
            // ... è®¡ç®—é€»è¾‘ ...
        }
        
        double ppl = Math.exp(-totalLogProb / count);
        
        // æ¸…ç†
        inputTensor.close();
        result.close();
        
        return ppl;
    }
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… é›¶ç½‘ç»œå¼€é”€ï¼Œå»¶è¿Ÿæä½
- âœ… ç›´æ¥è®¿é—® logitsï¼Œç²¾ç¡®è®¡ç®— PPL
- âœ… GPU è‡ªåŠ¨åŠ é€Ÿ
- âœ… å®Œå…¨ç¦»çº¿è¿è¡Œ

---

## ğŸ“Š äºŒã€å½“å‰ç³»ç»Ÿå®ç°åˆ†æ

### 2.1 å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AI Reviewer RAG System                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  ã€Chunking å±‚ã€‘                                â”‚
â”‚  â”œâ”€ NONE                                        â”‚
â”‚  â”œâ”€ SIMPLE (å›ºå®šé•¿åº¦)                           â”‚
â”‚  â”œâ”€ SMART_KEYWORD (å…³é”®è¯åˆ‡åˆ†) â† æ¨èä½¿ç”¨       â”‚
â”‚  â””â”€ AI_SEMANTIC (LLM åˆ‡åˆ†) â† ä½¿ç”¨ OpenAI API   â”‚
â”‚                                                 â”‚
â”‚  ã€æ£€ç´¢å±‚ã€‘                                      â”‚
â”‚  â”œâ”€ Lucene (BM25) - å…³é”®è¯æ£€ç´¢                  â”‚
â”‚  â”œâ”€ Vector (Embedding) - è¯­ä¹‰æ£€ç´¢               â”‚
â”‚  â””â”€ HybridSearch (0.3 * Lucene + 0.7 * Vector) â”‚
â”‚                                                 â”‚
â”‚  ã€LLM å±‚ã€‘                                      â”‚
â”‚  â””â”€ OpenAILLMClient                             â”‚
â”‚      â”œâ”€ GPT-4o (é»˜è®¤)                           â”‚
â”‚      â”œâ”€ DeepSeek-Chat (å…¼å®¹)                    â”‚
â”‚      â””â”€ ä»»ä½• OpenAI API å…¼å®¹æœåŠ¡                â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç¼ºå¤±çš„åŠŸèƒ½

#### âŒ ç¼ºå¤±1ï¼šPPL Chunking

**å½“å‰çŠ¶æ€**ï¼š
- âœ… æœ‰ `AI_SEMANTIC` Chunkerï¼ˆä½¿ç”¨ LLM APIï¼‰
- âŒ æ—  `PPL_BASED` Chunkerï¼ˆåŸºäºå›°æƒ‘åº¦ï¼‰

**å·®å¼‚**ï¼š
| ç‰¹æ€§ | AI_SEMANTIC (å½“å‰) | PPL_BASED (ç¼ºå¤±) |
|------|-------------------|------------------|
| **å®ç°æ–¹å¼** | è°ƒç”¨ OpenAI API | æœ¬åœ°å°æ¨¡å‹è®¡ç®— PPL |
| **æˆæœ¬** | $0.10-0.50/æ–‡æ¡£ | $0ï¼ˆå…è´¹ï¼‰|
| **é€Ÿåº¦** | 2-5ç§’ | 0.5-2ç§’ |
| **è´¨é‡** | â­â­â­â­â­ | â­â­â­â­ |
| **é€‚ç”¨åœºæ™¯** | é«˜è´¨é‡éœ€æ±‚ | æˆæœ¬æ•æ„Ÿ |

**è¯„ä¼°**ï¼š
- ğŸ”µ **å½“å‰æ–¹æ¡ˆå¯ç”¨ä½†æˆæœ¬é«˜**
- ğŸŸ¢ **å»ºè®®æ·»åŠ  PPL Chunker ä½œä¸ºä½æˆæœ¬é€‰é¡¹**

#### âŒ ç¼ºå¤±2ï¼šPPL Rerank

**å½“å‰çŠ¶æ€**ï¼š
- âœ… æœ‰ `HybridSearch`ï¼ˆLucene + Vectorï¼‰
- âŒ æ—  `PPL Rerank`ï¼ˆå›°æƒ‘åº¦é‡æ’åºï¼‰

**å·®å¼‚**ï¼š
| ç‰¹æ€§ | HybridSearch (å½“å‰) | PPL Rerank (ç¼ºå¤±) |
|------|---------------------|-------------------|
| **æ–¹æ³•** | BM25(30%) + Vector(70%) | å›°æƒ‘åº¦è¯„ä¼° |
| **æˆæœ¬** | $0 | $0 |
| **é€Ÿåº¦** | 300ms | +150ms |
| **å‡†ç¡®ç‡** | åŸºå‡† | +5-10% |
| **é€‚ç”¨åœºæ™¯** | é€šç”¨æ¨è | ç²¾åº¦ä¼˜å…ˆ |

**è¯„ä¼°**ï¼š
- ğŸ”µ **å½“å‰æ–¹æ¡ˆå·²ç»å¾ˆå¥½**
- ğŸŸ¡ **å¯é€‰æ·»åŠ  PPL Rerank ä½œä¸ºå¢å¼º**

---

## ğŸ’¡ ä¸‰ã€å»ºè®®çš„æŠ€æœ¯é€‰å‹

### 3.1 é’ˆå¯¹ PPL Chunking

#### æ¨èæ–¹æ¡ˆï¼šHugging Face (ONNX) âœ…

**ç†ç”±**ï¼š
1. **æˆæœ¬**ï¼šå®Œå…¨å…è´¹ï¼ˆvs OpenAI $0.10-0.50/æ–‡æ¡£ï¼‰
2. **é€Ÿåº¦**ï¼š0.5-2ç§’/æ–‡æ¡£ï¼ˆvs API 2-5ç§’ï¼‰
3. **éšç§**ï¼šå®Œå…¨æœ¬åœ°å¤„ç†
4. **å¯æ§**ï¼šç²¾ç¡®æ§åˆ¶åˆ‡åˆ†é€»è¾‘

**å®æ–½æ­¥éª¤**ï¼š
```yaml
# 1. æ–°å¢é…ç½®
knowledge:
  qa:
    chunking:
      strategy: PPL_BASED  # æ–°å¢é€‰é¡¹
      ppl:
        enabled: true
        model:
          type: gpt2-medium-int8
          path: ./models/gpt2-medium-int8/model.onnx
          tokenizer-path: ./models/gpt2-medium-int8/tokenizer.json
        threshold: 20.0
```

```java
// 2. æ·»åŠ ä¾èµ–
<dependency>
    <groupId>com.microsoft.onnxruntime</groupId>
    <artifactId>onnxruntime</artifactId>
    <version>1.16.0</version>
</dependency>
<dependency>
    <groupId>ai.djl.huggingface</groupId>
    <artifactId>tokenizers</artifactId>
    <version>0.25.0</version>
</dependency>
```

```java
// 3. å®ç° PPLChunker
@Service
public class PPLChunker implements DocumentChunker {
    // ... è§ã€Šå°å‹æ¨¡å‹PPLå®æ–½æ–¹æ¡ˆ.mdã€‹ç¬¬2.2èŠ‚
}
```

**ä¸æ¨è Ollama çš„åŸå› **ï¼š
- âŒ éœ€è¦ç‹¬ç«‹æœåŠ¡ï¼ˆå¢åŠ éƒ¨ç½²å¤æ‚åº¦ï¼‰
- âŒ ç½‘ç»œå¼€é”€ï¼ˆé™ä½æ€§èƒ½ï¼‰
- âŒ Ollama ä¸ç›´æ¥è¿”å› PPLï¼ˆéœ€è¦è‡ªå·±è®¡ç®—ï¼‰

### 3.2 é’ˆå¯¹ PPL Rerank

#### æ¨èæ–¹æ¡ˆï¼šHugging Face (ONNX) + å¼‚æ­¥å¤„ç† âœ…

**ç†ç”±**ï¼š
1. **ä½å»¶è¿Ÿ**ï¼š30-150msï¼ˆä»…å¯¹ Top-5 è®¡ç®—ï¼‰
2. **é›¶æˆæœ¬**ï¼šå®Œå…¨æœ¬åœ°
3. **å¯é€‰å¼€å…³**ï¼šä¸å½±å“ç°æœ‰ç³»ç»Ÿ

**å®æ–½æ­¥éª¤**ï¼š
```yaml
# é…ç½®
knowledge:
  qa:
    rerank:
      ppl-boost:
        enabled: true       # å¯é€‰å¼€å¯
        weight: 0.15        # è¾ƒä½æƒé‡
        top-k: 5            # ä»…å¯¹å‰5ä¸ª
        async: true         # å¼‚æ­¥å¤„ç†
```

```java
// é›†æˆåˆ° HybridSearchService
@Slf4j
@Service
public class HybridSearchService {
    
    private final PPLReranker pplReranker;
    
    public List<Document> hybridSearch(...) {
        // ... ç°æœ‰é€»è¾‘ ...
        
        // å¯é€‰ï¼šPPL Rerank
        if (pplReranker.isEnabled()) {
            finalDocs = pplReranker.rerank(question, finalDocs);
        }
        
        return finalDocs;
    }
}
```

---

## ğŸ“ˆ å››ã€æ€§èƒ½ä¸æˆæœ¬å¯¹æ¯”

### 4.1 å¤§æ–‡æ¡£åˆ†å—ï¼ˆ100é¡µ PDFï¼‰

| æ–¹æ¡ˆ | è€—æ—¶ | æˆæœ¬/æ–‡æ¡£ | è´¨é‡ |
|------|------|----------|------|
| **å½“å‰ AI_SEMANTIC** | 5-15ç§’ | $0.10-0.50 | â­â­â­â­â­ |
| **Ollama (Qwen-0.5B)** | 3-8ç§’ | $0 | â­â­â­â­ |
| **HF ONNX (GPT2-Medium)** | 1-3ç§’ | $0 | â­â­â­â­ âœ… |

### 4.2 å®æ—¶æ£€ç´¢é‡æ’åºï¼ˆ100 å€™é€‰æ–‡æ¡£ï¼‰

| æ–¹æ¡ˆ | è€—æ—¶ | æˆæœ¬/æŸ¥è¯¢ | å‡†ç¡®ç‡æå‡ |
|------|------|----------|-----------|
| **å½“å‰ HybridSearch** | 300ms | $0 | åŸºå‡† |
| **+ Ollama Rerank** | +300ms | $0 | +5-8% |
| **+ HF ONNX Rerank** | +150ms | $0 | +5-10% âœ… |
| **+ OpenAI Rerank** | +2000ms | $0.05 | +10-15% |

### 4.3 æœˆåº¦æˆæœ¬å¯¹æ¯”ï¼ˆ10ä¸‡æ–‡æ¡£ + 10ä¸‡æŸ¥è¯¢ï¼‰

| æ–¹æ¡ˆç»„åˆ | Chunking æˆæœ¬ | Rerank æˆæœ¬ | æ€»æˆæœ¬ | å¤‡æ³¨ |
|---------|--------------|------------|--------|------|
| **å½“å‰ç³»ç»Ÿ** | $10,000-50,000 | $0 | $10,000-50,000 | AI_SEMANTIC |
| **Ollama** | $0 | $0 | **$0** | éœ€è¦ GPU æœåŠ¡å™¨ |
| **HF ONNX** | $0 | $0 | **$0** âœ… | æœ€æ¨è |

---

## ğŸ¯ äº”ã€æœ€ç»ˆå»ºè®®

### 5.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

#### âœ… æ·»åŠ  PPL Chunkerï¼ˆHugging Face ONNXï¼‰

**ç›®æ ‡**ï¼šæä¾›ä½æˆæœ¬çš„åˆ†å—é€‰é¡¹

**æ­¥éª¤**ï¼š
1. æ·»åŠ ä¾èµ–ï¼ˆONNX Runtime + Tokenizersï¼‰
2. ä¸‹è½½å¹¶é‡åŒ– GPT-2 Medium æ¨¡å‹
3. å®ç° `PPLChunker` ç±»
4. æ·»åŠ é…ç½®é¡¹ `chunking.strategy=PPL_BASED`
5. æµ‹è¯•éªŒè¯

**é¢„æœŸæ”¶ç›Š**ï¼š
- ğŸ’° **æˆæœ¬é™ä½ 95%**ï¼ˆ$0.10-0.50 â†’ $0ï¼‰
- âš¡ **é€Ÿåº¦æå‡ 2-3å€**ï¼ˆ5-15ç§’ â†’ 1-3ç§’ï¼‰
- ğŸ¯ **è´¨é‡æŸå¤± <5%**ï¼ˆå¯æ¥å—ï¼‰

### 5.2 ä¸­æœŸä¼˜åŒ–ï¼ˆ2-4å‘¨ï¼‰

#### âœ… æ·»åŠ  PPL Rerankï¼ˆHugging Face ONNXï¼‰

**ç›®æ ‡**ï¼šæå‡æ£€ç´¢ç²¾åº¦

**æ­¥éª¤**ï¼š
1. å¤ç”¨ PPL è®¡ç®—åŸºç¡€è®¾æ–½
2. å®ç° `PPLReranker` ç±»
3. é›†æˆåˆ° `HybridSearchService`
4. æ·»åŠ å¼‚æ­¥å¤„ç†
5. A/B æµ‹è¯•éªŒè¯

**é¢„æœŸæ”¶ç›Š**ï¼š
- ğŸ¯ **å‡†ç¡®ç‡æå‡ 5-10%**
- âš¡ **å»¶è¿Ÿå¢åŠ  <150ms**ï¼ˆå¯æ¥å—ï¼‰
- ğŸ’° **é›¶æˆæœ¬**

### 5.3 é•¿æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

#### âš ï¸ è€ƒè™‘ Ollamaï¼ˆå¦‚æœéœ€è¦æœ¬åœ°å¤§æ¨¡å‹ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- æ•°æ®éšç§è¦æ±‚æé«˜
- éœ€è¦å®Œå…¨ç¦»çº¿è¿è¡Œ
- æœ‰å……è¶³çš„ GPU èµ„æº

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- è¿½æ±‚æœ€ä½å»¶è¿Ÿ
- èµ„æºå—é™ç¯å¢ƒ
- PPL è®¡ç®—åœºæ™¯ï¼ˆHF ONNX æ›´å¥½ï¼‰

---

## ğŸ“‹ å…­ã€å®æ–½ä¼˜å…ˆçº§

### ä¼˜å…ˆçº§ P0ï¼ˆç«‹å³å®æ–½ï¼‰

âœ… **ç»§ç»­ä½¿ç”¨ OpenAI API åšæ™ºèƒ½é—®ç­”**
- å½“å‰æ–¹æ¡ˆæˆç†Ÿç¨³å®š
- è´¨é‡æœ€ä¼˜
- æ— éœ€æ”¹åŠ¨

### ä¼˜å…ˆçº§ P1ï¼ˆæ¨èå®æ–½ï¼‰

âœ… **æ·»åŠ  PPL Chunkerï¼ˆHugging Face ONNXï¼‰**
- æˆæœ¬èŠ‚çœæ˜¾è‘—
- å®æ–½éš¾åº¦ä¸­ç­‰
- é£é™©å¯æ§ï¼ˆæœ‰é™çº§æ–¹æ¡ˆï¼‰

### ä¼˜å…ˆçº§ P2ï¼ˆå¯é€‰å®æ–½ï¼‰

âš ï¸ **æ·»åŠ  PPL Rerankï¼ˆHugging Face ONNXï¼‰**
- ç²¾åº¦æå‡æœ‰é™ï¼ˆ5-10%ï¼‰
- å¢åŠ ç³»ç»Ÿå¤æ‚åº¦
- å»ºè®®å…ˆéªŒè¯ P1 æ•ˆæœ

### ä¼˜å…ˆçº§ P3ï¼ˆè§‚æœ›ï¼‰

âŒ **ä¸æ¨èä½¿ç”¨ Ollama**
- PPL åœºæ™¯ä¸‹æ— æ˜æ˜¾ä¼˜åŠ¿
- å¢åŠ éƒ¨ç½²å¤æ‚åº¦
- HF ONNX æ–¹æ¡ˆæ›´ä¼˜

---

## ğŸ“ ä¸ƒã€æŠ€æœ¯å­¦ä¹ æ›²çº¿

### Hugging Face (ONNX)

**éš¾åº¦**ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼‰

**éœ€è¦å­¦ä¹ **ï¼š
- ONNX Runtime Java API
- Hugging Face Tokenizers
- æ¨¡å‹è½¬æ¢å’Œé‡åŒ–

**å­¦ä¹ èµ„æº**ï¼š
- [ONNX Runtime å®˜æ–¹æ–‡æ¡£](https://onnxruntime.ai/docs/)
- [Hugging Face Optimum](https://huggingface.co/docs/optimum)
- å·²æä¾›çš„ã€Šå°å‹æ¨¡å‹PPLå®æ–½æ–¹æ¡ˆ.mdã€‹

### Ollama

**éš¾åº¦**ï¼šâ­â­ï¼ˆç®€å•ï¼‰

**éœ€è¦å­¦ä¹ **ï¼š
- Ollama å®‰è£…å’Œä½¿ç”¨
- REST API è°ƒç”¨
- æ¨¡å‹ç®¡ç†

**å­¦ä¹ èµ„æº**ï¼š
- [Ollama å®˜æ–¹æ–‡æ¡£](https://ollama.ai/docs)
- [Ollama GitHub](https://github.com/ollama/ollama)

---

## âœ… å…«ã€æ€»ç»“

### æ ¸å¿ƒç»“è®º

1. **Ollama vs Hugging Face**ï¼š
   - Ollamaï¼šé€‚åˆéƒ¨ç½²å¤§æ¨¡å‹ï¼ˆ7B+ï¼‰ï¼Œä½œä¸ºæ™ºèƒ½é—®ç­”åç«¯
   - HF ONNXï¼šé€‚åˆåµŒå…¥å°æ¨¡å‹ï¼ˆ<2Bï¼‰ï¼Œåš PPL Chunking/Rerank âœ…

2. **å½“å‰ç³»ç»Ÿè¯„ä¼°**ï¼š
   - âœ… æ™ºèƒ½é—®ç­”ï¼ˆOpenAI APIï¼‰- ä¿æŒä¸å˜
   - âŒ ç¼ºå°‘ PPL Chunker - å»ºè®®æ·»åŠ ï¼ˆHF ONNXï¼‰
   - âŒ ç¼ºå°‘ PPL Rerank - å¯é€‰æ·»åŠ ï¼ˆHF ONNXï¼‰

3. **æ¨èæŠ€æœ¯æ ˆ**ï¼š
   ```
   æ™ºèƒ½é—®ç­”å±‚ï¼šOpenAI API (GPT-4o) â† ä¿æŒ
   åˆ†å—å±‚ï¼šSMART_KEYWORD + PPL_BASED (HF ONNX) â† æ–°å¢
   æ£€ç´¢å±‚ï¼šHybridSearch + PPL Rerank (HF ONNX) â† æ–°å¢
   ```

### å®æ–½å»ºè®®

**ç¬¬ä¸€æ­¥**ï¼ˆå¿…åšï¼‰ï¼š
- æ·»åŠ  PPL Chunkerï¼ˆHugging Face ONNXï¼‰
- ç›®æ ‡ï¼šé™ä½ 95% çš„åˆ†å—æˆæœ¬

**ç¬¬äºŒæ­¥**ï¼ˆæ¨èï¼‰ï¼š
- æ·»åŠ  PPL Rerankï¼ˆHugging Face ONNXï¼‰
- ç›®æ ‡ï¼šæå‡ 5-10% çš„æ£€ç´¢ç²¾åº¦

**ç¬¬ä¸‰æ­¥**ï¼ˆè§‚æœ›ï¼‰ï¼š
- è¯„ä¼°æ˜¯å¦éœ€è¦ Ollama
- ä»…åœ¨æœ‰æœ¬åœ°å¤§æ¨¡å‹éœ€æ±‚æ—¶è€ƒè™‘

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**ï¼š2025-12-04  
**ä½œè€…**ï¼šAI Assistant  
**çŠ¶æ€**ï¼šâœ… å®Œæ•´å¯¹æ¯”åˆ†æ

