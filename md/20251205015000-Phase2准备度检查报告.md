# âœ… Phase 2 å‡†å¤‡åº¦æ£€æŸ¥æŠ¥å‘Š

## ğŸ“… æ£€æŸ¥æ—¶é—´
2025-12-05 01:50:00

## ğŸ¯ æ£€æŸ¥ç›®çš„
è¯„ä¼°å½“å‰ä»£ç å’Œé…ç½®çŠ¶æ€ï¼Œç¡®è®¤æ˜¯å¦å¯ä»¥å¼€å§‹ Phase 2ï¼ˆONNX æœåŠ¡å®ç°ï¼‰

---

## âœ… Phase 1 å®Œæˆæƒ…å†µæ£€æŸ¥

### 1. æ ¸å¿ƒæ¥å£ä¸æšä¸¾ âœ…

#### âœ… PPLProviderType.java
- **ä½ç½®**: `src/main/java/top/yumbo/ai/rag/ppl/PPLProviderType.java`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **åŠŸèƒ½**: å®šä¹‰äº† ONNXã€Ollamaã€OpenAI ä¸‰ç§æä¾›å•†ç±»å‹

#### âœ… PPLException.java
- **ä½ç½®**: `src/main/java/top/yumbo/ai/rag/ppl/PPLException.java`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **åŠŸèƒ½**: ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œæ”¯æŒæä¾›å•†ç±»å‹å’Œé”™è¯¯ç 

#### âœ… PPLMetrics.java
- **ä½ç½®**: `src/main/java/top/yumbo/ai/rag/ppl/PPLMetrics.java`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **åŠŸèƒ½**: æ€§èƒ½æŒ‡æ ‡æ”¶é›†ï¼ˆè°ƒç”¨æ¬¡æ•°ã€æˆåŠŸç‡ã€å»¶è¿Ÿã€ç¼“å­˜å‘½ä¸­ç‡ç­‰ï¼‰

#### âœ… PPLService.java
- **ä½ç½®**: `src/main/java/top/yumbo/ai/rag/ppl/PPLService.java`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **åŠŸèƒ½**: æ ¸å¿ƒæœåŠ¡æ¥å£ï¼Œå®šä¹‰äº†ï¼š
  - `calculatePerplexity(String text)` - PPL è®¡ç®—
  - `chunk(...)` - PPL Chunking
  - `rerank(...)` - PPL Rerank
  - é»˜è®¤æ–¹æ³•å’Œå¥åº·æ£€æŸ¥

### 2. é…ç½®æ¨¡å‹ âœ…

#### âœ… ChunkConfig.java
- **ä½ç½®**: `src/main/java/top/yumbo/ai/rag/ppl/config/ChunkConfig.java`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **åŠŸèƒ½**: Chunking é…ç½®ï¼ˆé˜ˆå€¼ã€å—å¤§å°ã€é‡å ç­‰ï¼‰

#### âœ… RerankConfig.java
- **ä½ç½®**: `src/main/java/top/yumbo/ai/rag/ppl/config/RerankConfig.java`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **åŠŸèƒ½**: Rerank é…ç½®ï¼ˆæƒé‡ã€Top-Kã€å¼‚æ­¥ç­‰ï¼‰

#### âœ… PPLConfig.java
- **ä½ç½®**: `src/main/java/top/yumbo/ai/rag/ppl/config/PPLConfig.java`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **åŠŸèƒ½**: ç»Ÿä¸€é…ç½®ï¼Œæ”¯æŒ Spring Boot `@ConfigurationProperties`

### 3. é—¨é¢å®ç° âœ…

#### âœ… PPLServiceFacade.java
- **ä½ç½®**: `src/main/java/top/yumbo/ai/rag/ppl/PPLServiceFacade.java`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **åŠŸèƒ½**: 
  - ç®¡ç†å¤šç§æä¾›å•†
  - åŠ¨æ€åˆ‡æ¢
  - é™çº§ç­–ç•¥
  - ç»Ÿä¸€ç›‘æ§å’Œæ—¥å¿—

### 4. ONNX æœåŠ¡éª¨æ¶ âœ…

#### âœ… PPLOnnxService.java
- **ä½ç½®**: `src/main/java/top/yumbo/ai/rag/ppl/onnx/PPLOnnxService.java`
- **çŠ¶æ€**: âœ… å·²åˆ›å»ºï¼ˆéª¨æ¶ï¼‰
- **åŠŸèƒ½**: 
  - âœ… åŸºç¡€ç»“æ„å®Œæˆ
  - âœ… Spring Boot é›†æˆå®Œæˆ
  - â³ æ ¸å¿ƒåŠŸèƒ½å¾…å®ç°ï¼ˆPhase 2ï¼‰

### 5. é…ç½®æ–‡ä»¶ âœ…

#### âœ… application.yml
- **ä½ç½®**: `src/main/resources/application.yml`
- **çŠ¶æ€**: âœ… å·²é…ç½®
- **å†…å®¹**:
  ```yaml
  knowledge:
    qa:
      ppl:
        default-provider: onnx
        enable-fallback: true
        fallback-order: [onnx, ollama, openai]
        
        onnx:
          enabled: true
          model-path: ./models/qwen2.5-0.5b-instruct/model.onnx
          tokenizer-path: ./models/qwen2.5-0.5b-instruct/tokenizer.json
          max-batch-size: 8
          use-cache: true
          cache-size: 10000
          cache-ttl: 3600
        
        ollama:
          enabled: true
          base-url: http://localhost:11434
          model: qwen2.5:0.5b
        
        chunking:
          ppl-threshold: 20.0
          max-chunk-size: 2000
          min-chunk-size: 200
        
        reranking:
          enabled: false
          weight: 0.15
          top-k: 5
  ```

---

## ğŸ“¦ ä¾èµ–æ£€æŸ¥

### 1. å·²æœ‰ä¾èµ– âœ…

#### âœ… ONNX Runtime
```xml
<dependency>
    <groupId>com.microsoft.onnxruntime</groupId>
    <artifactId>onnxruntime</artifactId>
    <version>1.16.3</version>
</dependency>
```
- **çŠ¶æ€**: âœ… å·²æ·»åŠ ï¼ˆç‰ˆæœ¬ 1.16.3ï¼‰
- **ç”¨é€”**: ONNX æ¨¡å‹æ¨ç†

#### âœ… Caffeine Cache
```xml
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
</dependency>
```
- **çŠ¶æ€**: âœ… å·²æ·»åŠ ï¼ˆSpring Boot ç®¡ç†ç‰ˆæœ¬ï¼‰
- **ç”¨é€”**: ç¼“å­˜ PPL è®¡ç®—ç»“æœ

### 2. ç¼ºå¤±ä¾èµ– âŒ

#### âŒ Hugging Face Tokenizers
```xml
<dependency>
    <groupId>ai.djl.huggingface</groupId>
    <artifactId>tokenizers</artifactId>
    <version>0.25.0</version>
</dependency>
```
- **çŠ¶æ€**: âŒ æœªæ·»åŠ 
- **ç”¨é€”**: Tokenizationï¼ˆæ–‡æœ¬è½¬ Token IDï¼‰
- **é‡è¦æ€§**: ğŸ”´ **å¿…éœ€** - PPL è®¡ç®—çš„å‰ç½®æ­¥éª¤

---

## ğŸ¯ Phase 2 ä»»åŠ¡æ¸…å•

### 1. æ·»åŠ ç¼ºå¤±ä¾èµ– â³

- [ ] æ·»åŠ  `ai.djl.huggingface:tokenizers:0.25.0`
- [ ] éªŒè¯ä¾èµ–å…¼å®¹æ€§

### 2. å®ç° PPL è®¡ç®— â³

#### éœ€è¦å®ç°çš„æ–¹æ³•
```java
@Override
public double calculatePerplexity(String text) throws PPLException {
    // 1. Tokenize: æ–‡æœ¬ -> Token IDs
    // 2. æ¨¡å‹æ¨ç†: Token IDs -> Logits
    // 3. è®¡ç®— PPL: Logits -> Perplexity Score
}
```

#### æŠ€æœ¯ç»†èŠ‚
- **Tokenization**: ä½¿ç”¨ Hugging Face Tokenizers
- **æ¨¡å‹æ¨ç†**: ä½¿ç”¨ ONNX Runtime
- **PPL è®¡ç®—**: åŸºäº Cross-Entropy Loss

### 3. å®ç° PPL Chunking â³

#### éœ€è¦å®ç°çš„æ–¹æ³•
```java
@Override
public List<DocumentChunk> chunk(String content, String query, ChunkConfig config) {
    // 1. ç²—åˆ†å—: æŒ‰å¥å­æˆ–æ®µè½åˆ‡åˆ†
    // 2. PPL è®¡ç®—: ä¸ºæ¯ä¸ªå€™é€‰åˆ‡åˆ†ç‚¹è®¡ç®— PPL å˜åŒ–
    // 3. ç²¾ç»†åˆ‡åˆ†: åœ¨ PPL å˜åŒ–å¤§çš„åœ°æ–¹åˆ‡åˆ†
    // 4. åå¤„ç†: åˆå¹¶è¿‡å°çš„å—ï¼Œé™åˆ¶å—å¤§å°
}
```

#### ç®—æ³•æµç¨‹
```
è¾“å…¥æ–‡æœ¬
   â†“
åˆ†å¥ (Sentence Segmentation)
   â†“
è®¡ç®—æ¯ä¸ªå¥å­çš„ PPL
   â†“
æ£€æµ‹ PPL çªå˜ç‚¹ (PPL > threshold)
   â†“
åœ¨çªå˜ç‚¹åˆ‡åˆ†
   â†“
åå¤„ç†ï¼ˆåˆå¹¶ã€é™åˆ¶å¤§å°ï¼‰
   â†“
è¾“å‡ºåˆ‡åˆ†ç»“æœ
```

### 4. å®ç° PPL Rerank â³

#### éœ€è¦å®ç°çš„æ–¹æ³•
```java
@Override
public List<Document> rerank(List<Document> documents, String query, RerankConfig config) {
    // 1. é€‰æ‹© Top-K æ–‡æ¡£
    // 2. ä¸ºæ¯ä¸ªæ–‡æ¡£è®¡ç®— PPL åˆ†æ•°
    // 3. æ··åˆè¯„åˆ†: (1-weight) * åŸå§‹åˆ†æ•° + weight * PPLåˆ†æ•°
    // 4. é‡æ–°æ’åº
}
```

#### è¯„åˆ†å…¬å¼
```
PPL Score = 1 / (1 + perplexity(document))
Final Score = (1 - Î±) * original_score + Î± * ppl_score
```

### 5. æ·»åŠ ç¼“å­˜å±‚ â³

#### Caffeine ç¼“å­˜é…ç½®
```java
private final Cache<String, Double> pplCache = Caffeine.newBuilder()
    .maximumSize(config.getOnnx().getCacheSize())
    .expireAfterWrite(Duration.ofSeconds(config.getOnnx().getCacheTtl()))
    .recordStats()
    .build();
```

#### ç¼“å­˜ç­–ç•¥
- ç¼“å­˜é”®: æ–‡æœ¬å†…å®¹çš„ Hash
- ç¼“å­˜å€¼: PPL åˆ†æ•°
- è¿‡æœŸç­–ç•¥: TTL + LRU
- ç»Ÿè®¡: å‘½ä¸­ç‡ã€ç¼“å­˜å¤§å°

### 6. æ€§èƒ½ä¼˜åŒ– â³

- [ ] æ‰¹é‡æ¨ç†ï¼ˆBatch Inferenceï¼‰
- [ ] å¼‚æ­¥å¤„ç†ï¼ˆAsync Processingï¼‰
- [ ] ç»“æœç¼“å­˜ï¼ˆResult Cachingï¼‰
- [ ] è¿æ¥æ± ç®¡ç†ï¼ˆConnection Poolingï¼‰

---

## ğŸ“Š å‡†å¤‡åº¦è¯„åˆ†

| é¡¹ç›® | çŠ¶æ€ | å®Œæˆåº¦ | è¯„åˆ† |
|------|------|--------|------|
| **æ ¸å¿ƒæ¥å£** | âœ… å®Œæˆ | 100% | â­â­â­â­â­ |
| **é…ç½®æ¨¡å‹** | âœ… å®Œæˆ | 100% | â­â­â­â­â­ |
| **é—¨é¢å®ç°** | âœ… å®Œæˆ | 100% | â­â­â­â­â­ |
| **ONNX éª¨æ¶** | âœ… å®Œæˆ | 30% | â­â­â­ |
| **é…ç½®æ–‡ä»¶** | âœ… å®Œæˆ | 100% | â­â­â­â­â­ |
| **ä¾èµ–ç®¡ç†** | âš ï¸ ç¼ºå¤± | 80% | â­â­â­â­ |
| **æ¨¡å‹æ–‡ä»¶** | âœ… å·²ä¸‹è½½ | 100% | â­â­â­â­â­ |

**æ€»ä½“è¯„åˆ†**: â­â­â­â­ (4.6/5)

---

## âœ… å¯ä»¥å¼€å§‹ Phase 2

### ä¸ºä»€ä¹ˆå¯ä»¥å¼€å§‹ï¼Ÿ

1. âœ… **æ¶æ„å®Œæ•´** - Phase 1 çš„æ‰€æœ‰ç»„ä»¶éƒ½å·²å®ç°
2. âœ… **é…ç½®é½å…¨** - application.yml é…ç½®å®Œæ•´
3. âœ… **æ¥å£æ¸…æ™°** - æ ¸å¿ƒæ¥å£å®šä¹‰æ˜ç¡®
4. âœ… **éª¨æ¶å°±ç»ª** - PPLOnnxService éª¨æ¶å·²æ­å»º
5. âœ… **æ¨¡å‹å·²å¤‡** - Qwen ONNX æ¨¡å‹å·²ä¸‹è½½
6. âš ï¸ **ä¾èµ–åŸºæœ¬æ»¡è¶³** - ä»…ç¼º Tokenizersï¼ˆæ˜“æ·»åŠ ï¼‰

### éœ€è¦å…ˆåšçš„å‡†å¤‡å·¥ä½œ

#### 1. æ·»åŠ  Tokenizers ä¾èµ– â³

**pom.xml**:
```xml
<!-- Hugging Face Tokenizers - ç”¨äºæ–‡æœ¬åˆ†è¯ -->
<dependency>
    <groupId>ai.djl.huggingface</groupId>
    <artifactId>tokenizers</artifactId>
    <version>0.25.0</version>
</dependency>
```

#### 2. éªŒè¯æ¨¡å‹æ–‡ä»¶ âœ…

å·²ä¸‹è½½çš„æ¨¡å‹ï¼š
```
models/
â”œâ”€â”€ qwen2.5-1.5b-instruct/
â”‚   â”œâ”€â”€ model.onnx          (1.3 MB) âœ…
â”‚   â”œâ”€â”€ model.onnx_data     (7.1 GB) âœ…
â”‚   â”œâ”€â”€ tokenizer.json      (11.4 MB) âœ…
â”‚   â””â”€â”€ config.json         âœ…
â”‚
â””â”€â”€ bge-m3/
    â”œâ”€â”€ model.onnx          (0.5 MB) âœ…
    â”œâ”€â”€ model.onnx_data     (2.16 GB) âœ…
    â””â”€â”€ tokenizer.json      âœ…
```

---

## ğŸš€ Phase 2 å®æ–½å»ºè®®

### å®æ–½é¡ºåºï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1: ç¯å¢ƒå‡†å¤‡ï¼ˆ30åˆ†é’Ÿï¼‰
1. âœ… æ·»åŠ  Tokenizers ä¾èµ–
2. âœ… éªŒè¯ ONNX Runtime å¯ç”¨
3. âœ… éªŒè¯æ¨¡å‹æ–‡ä»¶è·¯å¾„

#### æ­¥éª¤ 2: PPL è®¡ç®—ï¼ˆ2-3å°æ—¶ï¼‰
1. å®ç° Tokenizer åŠ è½½
2. å®ç° ONNX æ¨¡å‹åŠ è½½
3. å®ç° PPL è®¡ç®—é€»è¾‘
4. æ·»åŠ ç¼“å­˜æ”¯æŒ
5. å•å…ƒæµ‹è¯•

#### æ­¥éª¤ 3: PPL Chunkingï¼ˆ3-4å°æ—¶ï¼‰
1. å®ç°åˆ†å¥é€»è¾‘
2. å®ç° PPL å˜åŒ–æ£€æµ‹
3. å®ç°ç²¾ç»†åˆ‡åˆ†
4. æ·»åŠ åå¤„ç†é€»è¾‘
5. é›†æˆæµ‹è¯•

#### æ­¥éª¤ 4: PPL Rerankï¼ˆ2-3å°æ—¶ï¼‰
1. å®ç° Top-K é€‰æ‹©
2. å®ç°æ··åˆè¯„åˆ†
3. å®ç°é‡æ’åº
4. æ€§èƒ½ä¼˜åŒ–
5. é›†æˆæµ‹è¯•

#### æ­¥éª¤ 5: æ€§èƒ½ä¼˜åŒ–ï¼ˆ2-3å°æ—¶ï¼‰
1. æ‰¹é‡ï¿½ï¿½ç†
2. å¼‚æ­¥å¤„ç†
3. ç¼“å­˜ä¼˜åŒ–
4. ç›‘æ§å®Œå–„

#### æ­¥éª¤ 6: æµ‹è¯•å’Œæ–‡æ¡£ï¼ˆ2-3å°æ—¶ï¼‰
1. ç«¯åˆ°ç«¯æµ‹è¯•
2. æ€§èƒ½æµ‹è¯•
3. æ–‡æ¡£æ›´æ–°
4. ä½¿ç”¨ç¤ºä¾‹

**é¢„è®¡æ€»æ—¶é—´**: 12-16 å°æ—¶

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åš

1. **æ·»åŠ  Tokenizers ä¾èµ–**
   ```bash
   # ç¼–è¾‘ pom.xmlï¼Œæ·»åŠ ä¾èµ–
   # è¿è¡Œ mvn clean install
   ```

2. **åˆ›å»ºæµ‹è¯•ç”¨ä¾‹**
   ```java
   @Test
   void testCalculatePerplexity() {
       String text = "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¥å­ã€‚";
       double ppl = pplService.calculatePerplexity(text);
       assertTrue(ppl > 0 && ppl < 1000);
   }
   ```

3. **å®ç°åŸºç¡€ PPL è®¡ç®—**
   - åŠ è½½ Tokenizer
   - åŠ è½½ ONNX æ¨¡å‹
   - å®ç°æ¨ç†é€»è¾‘

### ä¸­æœŸä»»åŠ¡

4. **å®ç° Chunking é€»è¾‘**
5. **å®ç° Rerank é€»è¾‘**
6. **æ·»åŠ ç¼“å­˜å’Œä¼˜åŒ–**

### é•¿æœŸä»»åŠ¡

7. **æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–**
8. **æ–‡æ¡£å®Œå–„**
9. **é›†æˆåˆ°ä¸»æµç¨‹**

---

## ğŸ¯ ç»“è®º

### âœ… **å¯ä»¥å¼€å§‹ Phase 2ï¼**

**ç†ç”±**ï¼š
1. âœ… Phase 1 åŸºç¡€æ¶æ„å®Œæ•´
2. âœ… é…ç½®æ–‡ä»¶é½å…¨
3. âœ… æ¥å£å®šä¹‰æ¸…æ™°
4. âœ… éª¨æ¶ä»£ç å°±ç»ª
5. âœ… æ¨¡å‹æ–‡ä»¶å·²ä¸‹è½½
6. âš ï¸ ä»…ç¼ºå°‘ 1 ä¸ªä¾èµ–ï¼ˆTokenizersï¼‰

**å»ºè®®**ï¼š
- å…ˆæ·»åŠ  Tokenizers ä¾èµ–
- ä» PPL è®¡ç®—å¼€å§‹å®ç°
- é€æ­¥å®Œæˆ Chunking å’Œ Rerank
- æŒç»­æµ‹è¯•å’Œä¼˜åŒ–

---

**æ£€æŸ¥å®Œæˆæ—¶é—´**: 2025-12-05 01:50:00  
**çŠ¶æ€**: âœ… **Phase 1 å®Œæˆï¼ŒPhase 2 å‡†å¤‡å°±ç»ªï¼**  
**å»ºè®®**: ç«‹å³å¼€å§‹ Phase 2 å®æ–½

