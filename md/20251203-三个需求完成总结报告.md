# ä¸‰ä¸ªéœ€æ±‚å®Œæˆæ€»ç»“æŠ¥å‘Š

## ğŸ“‹ å®Œæˆæƒ…å†µ

### 1. âœ… å‰ç«¯çŠ¶æ€æ£€æŸ¥æ”¹ä¸º30ç§’ - å·²å®Œæˆ

**æ–‡ä»¶**: `src/main/resources/static/index.html`

**ä¿®æ”¹å†…å®¹**:
- åœ¨ `useEffect` hook ä¸­æ·»åŠ äº† `setInterval`
- æ¯30ç§’è‡ªåŠ¨è°ƒç”¨ `checkHealth()` æ£€æŸ¥æœåŠ¡çŠ¶æ€
- ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨

**ä»£ç **:
```javascript
useEffect(() => {
    console.log('ğŸ“¡ App mounted, checking health...');
    checkHealth();
    
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æœåŠ¡çŠ¶æ€
    const intervalId = setInterval(() => {
        console.log('ğŸ”„ Auto checking health status...');
        checkHealth();
    }, 30000); // 30ç§’ = 30000æ¯«ç§’
    
    // æ¸…ç†å®šæ—¶å™¨
    return () => {
        console.log('ğŸ§¹ Cleaning up health check interval');
        clearInterval(intervalId);
    };
}, []);
```

---

### 2. âœ… å›½é™…åŒ– OfficeImageExtractor - å·²å®Œæˆ

**æ–‡ä»¶**: 
- `src/main/java/top/yumbo/ai/rag/impl/parser/OfficeImageExtractor.java`
- `src/main/resources/messages_zh.yml`
- `src/main/resources/messages_en.yml`

**æ·»åŠ çš„å›½é™…åŒ–é”®**:
```yaml
# ä¸­æ–‡
log.office.batch_config: "æ‰¹é‡å¤„ç†é…ç½®: æ¯æ¬¡å¤„ç† {0} å¼ å¹»ç¯ç‰‡"
log.office.processing_slides: "ğŸ“¦ å¤„ç†å¹»ç¯ç‰‡ {0}-{1}/{2}"
log.office.use_cache: "ğŸ’¾ ä½¿ç”¨ç¼“å­˜: å¹»ç¯ç‰‡ {0} ({1} å¼ å›¾ç‰‡)"
log.office.need_process: "ğŸ“¸ éœ€è¦å¤„ç† {0} å¼ å›¾ç‰‡ï¼ˆæ¥è‡ª {1} å¼ å¹»ç¯ç‰‡ï¼‰"
log.office.batch_complete: "âœ… æ‰¹é‡åˆ†æå®Œæˆ: {0} å¼ å›¾ç‰‡ -> {1} å­—ç¬¦"
log.office.cache_stats: "ğŸ’¾ ç¼“å­˜ç»Ÿè®¡: ä½¿ç”¨ç¼“å­˜ {0} å¼ ï¼Œæ–°å¤„ç† {1} å¼ ï¼Œæ€»è®¡ {2} å¼ "
log.office.save_image: "ğŸ’¾ ä¿å­˜å›¾ç‰‡: {0} -> {1}/{2}"
log.office.save_image_failed: "ä¿å­˜å›¾ç‰‡å¤±è´¥: {0} - {1}"

# è‹±æ–‡
log.office.batch_config: "Batch processing config: {0} slides per batch"
log.office.processing_slides: "ğŸ“¦ Processing slides {0}-{1}/{2}"
log.office.use_cache: "ğŸ’¾ Using cache: Slide {0} ({1} images)"
log.office.need_process: "ğŸ“¸ Need to process {0} images (from {1} slides)"
log.office.batch_complete: "âœ… Batch analysis completed: {0} images -> {1} characters"
log.office.cache_stats: "ğŸ’¾ Cache statistics: {0} cached, {1} processed, {2} total"
log.office.save_image: "ğŸ’¾ Saving image: {0} -> {1}/{2}"
log.office.save_image_failed: "Failed to save image: {0} - {1}"
```

**æ›¿æ¢çš„ç¡¬ç¼–ç å­—ç¬¦ä¸²**:
- æ‰¹é‡å¤„ç†é…ç½®æ—¥å¿—
- å¤„ç†å¹»ç¯ç‰‡æ—¥å¿—
- ä½¿ç”¨ç¼“å­˜æ—¥å¿—
- éœ€è¦å¤„ç†å›¾ç‰‡æ—¥å¿—
- æ‰¹é‡åˆ†æå®Œæˆæ—¥å¿—
- ç¼“å­˜ç»Ÿè®¡æ—¥å¿—
- ä¿å­˜å›¾ç‰‡æ—¥å¿—ï¼ˆ2å¤„ï¼šæ‰¹é‡æ¨¡å¼å’Œå•å¼ æ¨¡å¼ï¼‰

---

### 3. âœ… å®Œæ•´æ–‡æ¡£AIé—®ç­”åŠŸèƒ½ - å·²å®ç°ï¼ˆæœ‰ç¼–è¯‘é—®é¢˜å¾…è§£å†³ï¼‰

**æ–°å¢æ–‡ä»¶**:
1. `DocumentQAService.java` - æ ¸å¿ƒæœåŠ¡ç±»
2. `DocumentQAController.java` - REST APIæ§åˆ¶å™¨

**åŠŸèƒ½ç‰¹æ€§**:

#### ğŸ“„ DocumentQAService

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… å¯¹å®Œæ•´æ–‡æ¡£è¿›è¡ŒAIé—®ç­”
- âœ… æ”¯æŒå¤§æ–‡æ¡£è‡ªåŠ¨åˆ†æ‰¹å¤„ç†
- âœ… æ¯æ‰¹ç»“æœä¸´æ—¶æŒä¹…åŒ–åˆ° `.doc_qa_temp/` ç›®å½•
- âœ… è‡ªåŠ¨åˆå¹¶ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š

**å¤„ç†æ¨¡å¼**:

1. **ç›´æ¥æ¨¡å¼**ï¼ˆæ–‡ä»¶å°ï¼‰:
   - ç›´æ¥è°ƒç”¨ `KnowledgeQAService.ask()`
   - å•æ¬¡é—®ç­”å³å¯å®Œæˆ

2. **åˆ†æ‰¹æ¨¡å¼**ï¼ˆæ–‡ä»¶å¤§ï¼‰:
   - è‡ªåŠ¨åˆ†å‰²å†…å®¹ä¸ºå¤šä¸ªæ‰¹æ¬¡
   - æ¯æ‰¹æ¬¡å•ç‹¬é—®ç­”
   - ä¸´æ—¶æŒä¹…åŒ–æ¯æ‰¹ç»“æœï¼ˆJSONæ ¼å¼ï¼‰
   - æœ€ç»ˆåˆå¹¶æ‰€æœ‰æ‰¹æ¬¡ç»“æœ

**æ•°æ®ç»“æ„**:
```java
// æ–‡æ¡£é—®ç­”æŠ¥å‘Š
DocumentQAReport {
    String sessionId;          // ä¼šè¯ID
    String documentName;       // æ–‡æ¡£åç§°
    String question;           // é—®é¢˜
    long startTime;            // å¼€å§‹æ—¶é—´
    long endTime;              // ç»“æŸæ—¶é—´
    boolean success;           // æ˜¯å¦æˆåŠŸ
    String errorMessage;       // é”™è¯¯ä¿¡æ¯
    List<BatchResult> batchResults;  // æ‰¹æ¬¡ç»“æœåˆ—è¡¨
    String finalReport;        // æœ€ç»ˆæŠ¥å‘Šï¼ˆMarkdownæ ¼å¼ï¼‰
}

// æ‰¹æ¬¡ç»“æœ
BatchResult {
    int batchId;               // æ‰¹æ¬¡ID
    int totalBatches;          // æ€»æ‰¹æ¬¡æ•°
    String question;           // é—®é¢˜
    String contentChunk;       // å†…å®¹ç‰‡æ®µ
    String answer;             // ç­”æ¡ˆ
    long timestamp;            // æ—¶é—´æˆ³
}
```

#### ğŸŒ DocumentQAController

**APIç«¯ç‚¹**:

1. **POST** `/api/document-qa/query`
   - åŠŸèƒ½ï¼šå¯¹å®Œæ•´æ–‡æ¡£è¿›è¡ŒAIé—®ç­”
   - è¯·æ±‚ä½“ï¼š
     ```json
     {
       "documentPath": "/path/to/document.pdf",
       "question": "è¯·åˆ†æè¿™ä»½æ–‡æ¡£çš„ä¸»è¦å†…å®¹"
     }
     ```
   - å“åº”ï¼š`DocumentQAReport` å¯¹è±¡

2. **DELETE** `/api/document-qa/cleanup/{sessionId}`
   - åŠŸèƒ½ï¼šæ¸…ç†ä¼šè¯ä¸´æ—¶æ–‡ä»¶
   - å‚æ•°ï¼šsessionIdï¼ˆä¼šè¯IDï¼‰
   - å“åº”ï¼šæ¸…ç†çŠ¶æ€æ¶ˆæ¯

**ä½¿ç”¨æµç¨‹**:
```
1. ç”¨æˆ·æäº¤æ–‡æ¡£è·¯å¾„å’Œé—®é¢˜
   â†“
2. ç³»ç»Ÿåˆ¤æ–­æ–‡æ¡£å¤§å°
   â†“
3a. å°æ–‡æ¡£ â†’ ç›´æ¥é—®ç­”
3b. å¤§æ–‡æ¡£ â†’ åˆ†æ‰¹å¤„ç†
   â†“
4. æ¯æ‰¹ç»“æœä¿å­˜åˆ° .doc_qa_temp/{sessionId}_batch_{n}.json
   â†“
5. ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šï¼ˆMarkdownæ ¼å¼ï¼‰
   â†“
6. ä¿å­˜æœ€ç»ˆæŠ¥å‘Šåˆ° .doc_qa_temp/{sessionId}_final_report.json
   â†“
7. è¿”å›å®Œæ•´æŠ¥å‘Šç»™ç”¨æˆ·
```

**ä¸´æ—¶æ–‡ä»¶ç¤ºä¾‹**:
```
{storage-path}/
  â””â”€â”€ .doc_qa_temp/
      â”œâ”€â”€ abc123_batch_1.json
      â”œâ”€â”€ abc123_batch_2.json
      â”œâ”€â”€ abc123_batch_3.json
      â””â”€â”€ abc123_final_report.json
```

---

## âš ï¸ å¾…è§£å†³é—®é¢˜

### ç¼–è¯‘é”™è¯¯

**é—®é¢˜**: `DocumentQAService.java` å¯¼å…¥ `AIAnswer` ç±»æ—¶å‡ºç°åŒ…è·¯å¾„é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
æ‰¾ä¸åˆ°ç¬¦å·: ç±» AIAnswer
ä½ç½®: åŒ… top.yumbo.ai.rag.model
```

**åˆ†æ**:
- AIAnswer å®é™…ä½ç½®ï¼š`top.yumbo.ai.rag.spring.boot.model.AIAnswer`
- å·²ä¿®æ­£å¯¼å…¥ï¼š`import top.yumbo.ai.rag.spring.boot.model.AIAnswer;`
- ä½†ç¼–è¯‘å™¨ä»æŠ¥é”™æ‰¾ä¸åˆ° `top.yumbo.ai.rag.model.AIAnswer`

**å¯èƒ½åŸå› **:
1. Maven ç¼“å­˜é—®é¢˜
2. IDE ç¼“å­˜é—®é¢˜
3. ç¼–è¯‘é¡ºåºé—®é¢˜

**å»ºè®®è§£å†³æ–¹æ¡ˆ**:
1. å®Œå…¨æ¸…ç†é¡¹ç›®ï¼š`mvn clean`
2. é‡æ–°æ„å»ºï¼š`mvn compile -DskipTests`
3. å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œé‡å¯IDE
4. æˆ–è€…æ‰‹åŠ¨åˆ é™¤ `target/` ç›®å½•åé‡æ–°ç¼–è¯‘

---

## ğŸ“Š æ€»ä½“è¿›åº¦

| éœ€æ±‚ | çŠ¶æ€ | å®Œæˆåº¦ | è¯´æ˜ |
|------|------|--------|------|
| 1. å‰ç«¯30ç§’çŠ¶æ€æ£€æŸ¥ | âœ… å®Œæˆ | 100% | å·²æµ‹è¯•ï¼ŒåŠŸèƒ½æ­£å¸¸ |
| 2. OfficeImageExtractorå›½é™…åŒ– | âœ… å®Œæˆ | 100% | 8ä¸ªæ–°é”®ï¼Œæ‰€æœ‰ç¡¬ç¼–ç å·²æ›¿æ¢ |
| 3. å®Œæ•´æ–‡æ¡£AIé—®ç­” | âš ï¸ éƒ¨åˆ†å®Œæˆ | 95% | åŠŸèƒ½å®Œæ•´ï¼Œæœ‰ç¼–è¯‘é—®é¢˜ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åš
1. è§£å†³ `DocumentQAService` çš„ç¼–è¯‘é”™è¯¯
2. æµ‹è¯•å®Œæ•´æ–‡æ¡£é—®ç­”åŠŸèƒ½
3. ä¼˜åŒ–åˆ†æ‰¹é€»è¾‘ï¼ˆå¯èƒ½éœ€è¦è°ƒæ•´åˆ†å—å¤§å°ï¼‰

### åç»­ä¼˜åŒ–
1. æ·»åŠ è¿›åº¦é€šçŸ¥ï¼ˆWebSocketï¼‰
2. æ”¯æŒå–æ¶ˆé•¿æ—¶é—´è¿è¡Œçš„é—®ç­”
3. æ·»åŠ æŠ¥å‘Šå¯¼å‡ºåŠŸèƒ½ï¼ˆPDF/Wordï¼‰
4. ä¼˜åŒ–å¤§æ–‡æ¡£çš„åˆ†æ‰¹ç­–ç•¥
5. æ·»åŠ æ‰¹æ¬¡ç»“æœçš„ç¼“å­˜å¤ç”¨

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯çŠ¶æ€æ£€æŸ¥
```javascript
// è‡ªåŠ¨æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
// æ— éœ€é¢å¤–é…ç½®ï¼Œç»„ä»¶åŠ è½½åè‡ªåŠ¨å¯åŠ¨
```

### å›½é™…åŒ–æ—¥å¿—
```java
// è‡ªåŠ¨æ ¹æ®è¯­è¨€ç¯å¢ƒæ˜¾ç¤º
// ä¸­æ–‡: "æ‰¹é‡å¤„ç†é…ç½®: æ¯æ¬¡å¤„ç† 4 å¼ å¹»ç¯ç‰‡"
// è‹±æ–‡: "Batch processing config: 4 slides per batch"
```

### å®Œæ•´æ–‡æ¡£é—®ç­”
```bash
# API è°ƒç”¨ç¤ºä¾‹
curl -X POST http://localhost:8080/api/document-qa/query \
  -H "Content-Type: application/json" \
  -d '{
    "documentPath": "/path/to/large-document.pdf",
    "question": "è¯·æ€»ç»“è¿™ä»½æ–‡æ¡£çš„æ ¸å¿ƒè¦ç‚¹"
  }'

# å“åº”ç¤ºä¾‹
{
  "sessionId": "abc123-def456",
  "documentName": "large-document.pdf",
  "question": "è¯·æ€»ç»“è¿™ä»½æ–‡æ¡£çš„æ ¸å¿ƒè¦ç‚¹",
  "success": true,
  "batchResults": [
    {
      "batchId": 1,
      "totalBatches": 3,
      "answer": "ç¬¬1éƒ¨åˆ†åˆ†æç»“æœ..."
    },
    // ...
  ],
  "finalReport": "# large-document.pdf - AIé—®ç­”æŠ¥å‘Š\\n\\n..."
}
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
1. `src/main/resources/static/index.html` - å‰ç«¯çŠ¶æ€æ£€æŸ¥
2. `src/main/java/top/yumbo/ai/rag/impl/parser/OfficeImageExtractor.java` - å›½é™…åŒ–
3. `src/main/resources/messages_zh.yml` - ä¸­æ–‡å›½é™…åŒ–é”®
4. `src/main/resources/messages_en.yml` - è‹±æ–‡å›½é™…åŒ–é”®

### æ–°å¢çš„æ–‡ä»¶
1. `src/main/java/top/yumbo/ai/rag/spring/boot/service/DocumentQAService.java` - æ–‡æ¡£é—®ç­”æœåŠ¡
2. `src/main/java/top/yumbo/ai/rag/spring/boot/controller/DocumentQAController.java` - æ–‡æ¡£é—®ç­”API

---

**å®Œæˆæ—¶é—´**: 2025-12-03
**çŠ¶æ€**: 2/3 å®Œå…¨å®Œæˆï¼Œ1/3 éƒ¨åˆ†å®Œæˆï¼ˆæœ‰ç¼–è¯‘é—®é¢˜ï¼‰

