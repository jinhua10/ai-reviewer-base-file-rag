# ğŸ“š PPL Chunking å’Œ PPL Rerank æŠ€æœ¯åˆ†æä¸é¡¹ç›®å¯¹æ¯”

## ğŸ“… æ–‡æ¡£ä¿¡æ¯
- **åˆ›å»ºæ—¶é—´**ï¼š2025å¹´12æœˆ4æ—¥
- **åˆ†æå¯¹è±¡**ï¼šAI Reviewer Base File RAG é¡¹ç›®
- **åˆ†æå†…å®¹**ï¼šPPL æŠ€æœ¯ä¸ç°æœ‰å®ç°çš„å¯¹æ¯”

---

## ğŸ¯ ä¸€ã€PPL Chunking è¯¦è§£

### 1.1 ä»€ä¹ˆæ˜¯ PPL Chunkingï¼Ÿ

**PPL (Perplexity) Chunking** æ˜¯ä¸€ç§åŸºäºè¯­è¨€æ¨¡å‹å›°æƒ‘åº¦çš„æ™ºèƒ½æ–‡æ¡£åˆ†å—æŠ€æœ¯ã€‚

#### æ ¸å¿ƒæ¦‚å¿µ

**å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰**ï¼š
- è¡¡é‡è¯­è¨€æ¨¡å‹å¯¹æ–‡æœ¬çš„"æƒŠè®¶ç¨‹åº¦"
- å…¬å¼ï¼š`PPL = exp(-1/N * Î£log P(wi|context))`
- å›°æƒ‘åº¦è¶Šä½ = æ–‡æœ¬è¶Šç¬¦åˆé¢„æœŸ = è¯­ä¹‰è¿è´¯æ€§è¶Šå¥½
- å›°æƒ‘åº¦è¶Šé«˜ = æ–‡æœ¬è¶Šå‡ºä¹æ„æ–™ = å¯èƒ½æ˜¯ä¸»é¢˜è½¬æ¢ç‚¹

#### å·¥ä½œåŸç†

```
åŸå§‹æ–‡æœ¬ï¼š
"èŠ‚çº¦ç”¨æ°´æ˜¯ç¯ä¿çš„é‡è¦å†…å®¹ã€‚[PPL=10.2] 
æ°´èµ„æºæ—¥ç›Šç¨€ç¼ºã€‚[PPL=11.5]
æˆ‘ä»¬åº”è¯¥ä»æ—¥å¸¸åšèµ·ã€‚[PPL=12.1]
----------------------------- â† PPL çªç„¶å‡é«˜åˆ° 35.8ï¼ˆä¸»é¢˜åˆ‡æ¢ï¼ï¼‰
ç»æµå‘å±•éœ€è¦å¯æŒç»­ã€‚[PPL=35.8]
ç»¿è‰²GDPæˆä¸ºæ–°æŒ‡æ ‡ã€‚[PPL=28.3]"

åˆ‡åˆ†ç»“æœï¼š
Chunk 1: "èŠ‚çº¦ç”¨æ°´æ˜¯ç¯ä¿çš„é‡è¦å†…å®¹ã€‚æ°´èµ„æºæ—¥ç›Šç¨€ç¼ºã€‚æˆ‘ä»¬åº”è¯¥ä»æ—¥å¸¸åšèµ·ã€‚"
Chunk 2: "ç»æµå‘å±•éœ€è¦å¯æŒç»­ã€‚ç»¿è‰²GDPæˆä¸ºæ–°æŒ‡æ ‡ã€‚"
```

### 1.2 PPL Chunking çš„ä¼˜åŠ¿

| ç‰¹æ€§ | ä¼ ç»Ÿå›ºå®šé•¿åº¦åˆ‡åˆ† | æ»‘åŠ¨çª—å£åˆ‡åˆ† | PPL Chunking |
|------|----------------|-------------|--------------|
| **è¯­ä¹‰å®Œæ•´æ€§** | âŒ å¯èƒ½åœ¨å¥ä¸­åˆ‡æ–­ | âš ï¸ éƒ¨åˆ†ä¿ç•™ | âœ… å®Œå…¨ä¿ç•™ |
| **ä¸»é¢˜è¯†åˆ«** | âŒ æ— æ³•è¯†åˆ« | âŒ æ— æ³•è¯†åˆ« | âœ… è‡ªåŠ¨è¯†åˆ« |
| **è‡ªé€‚åº”æ€§** | âŒ å›ºå®šå¤§å° | âš ï¸ å›ºå®šçª—å£ | âœ… æ ¹æ®å†…å®¹è°ƒæ•´ |
| **ä¸Šä¸‹æ–‡è¿è´¯** | âŒ å¼± | âš ï¸ ä¸­ç­‰ | âœ… å¼º |
| **è®¡ç®—æˆæœ¬** | âœ… ä½ | âœ… ä½ | âŒ é«˜ï¼ˆéœ€è¦ LMï¼‰ |
| **å¤„ç†é€Ÿåº¦** | âœ… å¿« | âœ… å¿« | âŒ æ…¢ |

### 1.3 PPL Chunking ç®—æ³•æµç¨‹

```python
def ppl_chunking(text, model, threshold=20.0):
    sentences = split_into_sentences(text)
    chunks = []
    current_chunk = []
    
    for i, sentence in enumerate(sentences):
        # è®¡ç®—åŠ å…¥å½“å‰å¥å­åçš„å›°æƒ‘åº¦
        temp_chunk = current_chunk + [sentence]
        ppl = calculate_perplexity(model, temp_chunk)
        
        # å¦‚æœå›°æƒ‘åº¦çªç„¶å‡é«˜ï¼ˆä¸»é¢˜å˜åŒ–ï¼‰ï¼Œåˆ‡åˆ†
        if ppl > threshold and len(current_chunk) > 0:
            chunks.append(' '.join(current_chunk))
            current_chunk = [sentence]
        else:
            current_chunk.append(sentence)
    
    # æ·»åŠ æœ€åä¸€ä¸ª chunk
    if current_chunk:
        chunks.append(' '.join(current_chunk))
    
    return chunks
```

### 1.4 é€‚ç”¨åœºæ™¯

âœ… **é€‚åˆä½¿ç”¨ PPL Chunking**ï¼š
- é•¿æ–‡æ¡£éœ€è¦ç²¾ç¡®çš„ä¸»é¢˜åˆ†å‰²
- å¯¹æ£€ç´¢è´¨é‡è¦æ±‚é«˜
- æœ‰å……è¶³çš„è®¡ç®—èµ„æº
- æ–‡æ¡£ç»“æ„å¤æ‚ï¼Œä¸»é¢˜å¤šå˜

âŒ **ä¸é€‚åˆä½¿ç”¨ PPL Chunking**ï¼š
- å®æ—¶æ€§è¦æ±‚é«˜
- è®¡ç®—èµ„æºæœ‰é™
- æ–‡æ¡£ç»“æ„ç®€å•ï¼Œä¸»é¢˜å•ä¸€
- æˆæœ¬æ•æ„Ÿçš„åº”ç”¨

---

## ğŸ”„ äºŒã€PPL Rerank è¯¦è§£

### 2.1 ä»€ä¹ˆæ˜¯ PPL Rerankï¼Ÿ

**PPL Rerank** æ˜¯ä¸€ç§åŸºäºå›°æƒ‘åº¦çš„æ£€ç´¢ç»“æœé‡æ’åºæ–¹æ³•ã€‚

#### æ ¸å¿ƒæ€æƒ³

åœ¨åˆå§‹æ£€ç´¢åï¼Œä½¿ç”¨è¯­è¨€æ¨¡å‹è¯„ä¼°"é—®é¢˜+å€™é€‰ç­”æ¡ˆ"çš„ç»„åˆå›°æƒ‘åº¦ï¼Œå›°æƒ‘åº¦è¶Šä½è¡¨ç¤ºè¯¥ç­”æ¡ˆè¶Šç›¸å…³ã€‚

### 2.2 å·¥ä½œæµç¨‹

```
æ­¥éª¤1ï¼šåˆå§‹æ£€ç´¢ï¼ˆBM25/å‘é‡æ£€ç´¢ï¼‰
Question: "å¦‚ä½•èŠ‚çº¦ç”¨æ°´ï¼Ÿ"
Retrieved: [Doc1, Doc2, Doc3, Doc4, Doc5]

æ­¥éª¤2ï¼šè®¡ç®— PPL Score
for each doc in retrieved:
    combined_text = f"{question}\n{doc.content}"
    ppl_score = calculate_perplexity(model, combined_text)
    doc.ppl_score = ppl_score

æ­¥éª¤3ï¼šæŒ‰ PPL å‡åºæ’åºï¼ˆè¶Šä½è¶Šå¥½ï¼‰
Doc2: PPL = 8.7  â† æœ€ç›¸å…³
Doc4: PPL = 11.3
Doc1: PPL = 15.2
Doc5: PPL = 18.9
Doc3: PPL = 22.1

æ­¥éª¤4ï¼šè¿”å› Top-K
Return: [Doc2, Doc4, Doc1]
```

### 2.3 ä¸å…¶ä»– Rerank æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | åŸç† | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€Ÿåº¦ |
|------|------|------|------|------|
| **BM25 Rerank** | è¯é¢‘ç»Ÿè®¡ | å¿«é€Ÿã€å¯è§£é‡Š | æ— è¯­ä¹‰ç†è§£ | âš¡âš¡âš¡ |
| **å‘é‡ç›¸ä¼¼åº¦ Rerank** | ä½™å¼¦ç›¸ä¼¼åº¦ | è¯­ä¹‰åŒ¹é… | ä¾èµ–åµŒå…¥è´¨é‡ | âš¡âš¡ |
| **Cross-Encoder Rerank** | åŒå¡”æ¨¡å‹ | ç²¾ç¡®äº¤äº’ | æˆæœ¬é«˜ | âš¡ |
| **PPL Rerank** | å›°æƒ‘åº¦è¯„ä¼° | è‡ªç„¶æµç•…åº¦ | éœ€è¦ LM | âš¡ |
| **LLM Judge Rerank** | LLM æ‰“åˆ† | æœ€ç²¾ç¡® | æˆæœ¬æé«˜ | ğŸŒ |

### 2.4 PPL Rerank ç®—æ³•å®ç°

```python
def ppl_rerank(question, candidates, model, top_k=3):
    """
    ä½¿ç”¨å›°æƒ‘åº¦é‡æ’åºæ£€ç´¢ç»“æœ
    """
    scored_docs = []
    
    for doc in candidates:
        # æ„å»ºé—®ç­”å¯¹
        combined_text = f"é—®é¢˜ï¼š{question}\nç­”æ¡ˆï¼š{doc.content}"
        
        # è®¡ç®—å›°æƒ‘åº¦
        ppl = calculate_perplexity(model, combined_text)
        
        # å­˜å‚¨åˆ†æ•°ï¼ˆå›°æƒ‘åº¦è¶Šä½è¶Šå¥½ï¼‰
        scored_docs.append({
            'doc': doc,
            'ppl': ppl,
            'score': 1.0 / ppl  # è½¬æ¢ä¸ºåˆ†æ•°å½¢å¼
        })
    
    # æŒ‰å›°æƒ‘åº¦å‡åºæ’åº
    scored_docs.sort(key=lambda x: x['ppl'])
    
    # è¿”å› Top-K
    return [item['doc'] for item in scored_docs[:top_k]]
```

### 2.5 æ··åˆ Rerank ç­–ç•¥

å®é™…åº”ç”¨ä¸­ï¼Œå¸¸ç»“åˆå¤šç§æ–¹æ³•ï¼š

```python
def hybrid_rerank(question, candidates, weights):
    """
    æ··åˆå¤šç§ rerank æ–¹æ³•
    """
    for doc in candidates:
        # 1. BM25 åˆ†æ•°
        bm25_score = bm25.score(question, doc)
        
        # 2. å‘é‡ç›¸ä¼¼åº¦
        vec_score = cosine_similarity(
            embed(question), 
            embed(doc.content)
        )
        
        # 3. PPL åˆ†æ•°
        ppl = calculate_perplexity(model, f"{question}\n{doc.content}")
        ppl_score = 1.0 / ppl
        
        # 4. åŠ æƒç»„åˆ
        doc.final_score = (
            weights['bm25'] * bm25_score +
            weights['vector'] * vec_score +
            weights['ppl'] * ppl_score
        )
    
    # æ’åºè¿”å›
    return sorted(candidates, key=lambda x: x.final_score, reverse=True)
```

---

## ğŸ” ä¸‰ã€å½“å‰é¡¹ç›®çš„å®ç°åˆ†æ

### 3.1 é¡¹ç›®ä¸­çš„ Chunking ç­–ç•¥

å½“å‰é¡¹ç›®æ”¯æŒ **4 ç§åˆ‡åˆ†ç­–ç•¥**ï¼š

#### 1. NONEï¼ˆä¸åˆ‡åˆ†ï¼‰
```java
// ChunkingStrategy.java
NONE("ä¸åˆ‡åˆ† (No chunking)")
```
- âœ… ä¼˜ç‚¹ï¼šæ€§èƒ½æœ€å¥½ï¼Œæˆæœ¬æœ€ä½
- âŒ ç¼ºç‚¹ï¼šå¯èƒ½ä¸¢å¤±é•¿æ–‡æ¡£å†…å®¹

#### 2. SIMPLEï¼ˆç®€å•åˆ‡åˆ†ï¼‰
```java
SIMPLE("ç®€å•åˆ‡åˆ† (Simple chunking)")
// å®ç°ï¼šSimpleDocumentChunker.java
// æŒ‰å›ºå®šé•¿åº¦åˆ‡åˆ†ï¼Œç±»ä¼¼æ»‘åŠ¨çª—å£
```
- âœ… ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œé€Ÿåº¦å¿«
- âŒ ç¼ºç‚¹ï¼šå¯èƒ½åœ¨å¥å­ä¸­é—´åˆ‡æ–­

#### 3. SMART_KEYWORDï¼ˆæ™ºèƒ½å…³é”®è¯åˆ‡åˆ†ï¼‰
```java
SMART_KEYWORD("æ™ºèƒ½å…³é”®è¯åˆ‡åˆ† (Smart keyword chunking)")
// å®ç°ï¼šSmartKeywordChunker.java
// æå–å…³é”®è¯ï¼Œä¼˜å…ˆä¿ç•™åŒ…å«å…³é”®è¯çš„æ®µè½
```
- âœ… ä¼˜ç‚¹ï¼šå¹³è¡¡æ•ˆæœå’Œæˆæœ¬ï¼ˆæ¨èï¼‰
- âš ï¸ ç‰¹ç‚¹ï¼šåŸºäºå…³é”®è¯è€Œéè¯­ä¹‰

#### 4. AI_SEMANTICï¼ˆAI è¯­ä¹‰åˆ‡åˆ†ï¼‰
```java
AI_SEMANTIC("AI è¯­ä¹‰åˆ‡åˆ† (AI semantic chunking)")
// å®ç°ï¼šAiSemanticChunker.java
// ä½¿ç”¨ LLM è¿›è¡Œæ™ºèƒ½è¯­ä¹‰åˆ‡åˆ†
```
- âœ… ä¼˜ç‚¹ï¼šæ•ˆæœæœ€å¥½ï¼Œç†è§£è¯­ä¹‰
- âŒ ç¼ºç‚¹ï¼šæˆæœ¬é«˜ï¼Œé€Ÿåº¦æ…¢

### 3.2 å½“å‰å®ç° vs PPL Chunking

| ç‰¹æ€§ | å½“å‰ AI_SEMANTIC | PPL Chunking |
|------|-----------------|--------------|
| **è¯­ä¹‰ç†è§£** | âœ… ä½¿ç”¨ LLM åˆ†æ | âœ… ä½¿ç”¨å›°æƒ‘åº¦ |
| **ä¸»é¢˜è¯†åˆ«** | âœ… LLM åˆ¤æ–­ | âœ… PPL å³°å€¼ |
| **å®ç°æ–¹å¼** | LLM API è°ƒç”¨ | æœ¬åœ° LM è®¡ç®— |
| **æˆæœ¬** | é«˜ï¼ˆAPI è´¹ç”¨ï¼‰ | ä¸­ï¼ˆæœ¬åœ°æ¨¡å‹ï¼‰ |
| **å¯è§£é‡Šæ€§** | å¼ºï¼ˆLLM è¾“å‡ºï¼‰ | å¼±ï¼ˆå›°æƒ‘åº¦å€¼ï¼‰ |
| **çµæ´»æ€§** | é«˜ï¼ˆå¯å®šåˆ¶ promptï¼‰ | ä½ï¼ˆå›ºå®šç®—æ³•ï¼‰ |

**ç»“è®º**ï¼š
- å½“å‰çš„ `AI_SEMANTIC` ç­–ç•¥ç±»ä¼¼äº PPL Chunking çš„å¢å¼ºç‰ˆ
- ä½¿ç”¨ LLM çš„è¯­ä¹‰ç†è§£èƒ½åŠ›ï¼Œè€Œéç®€å•çš„å›°æƒ‘åº¦è®¡ç®—
- æ›´åŠ æ™ºèƒ½ä½†æˆæœ¬æ›´é«˜

### 3.3 é¡¹ç›®ä¸­çš„ Rerank å®ç°

#### æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰ç­–ç•¥

é¡¹ç›®ä½¿ç”¨ **HybridSearchService** å®ç°äº†æ··åˆæ£€ç´¢å’Œ Rerankï¼š

```java
// HybridSearchService.java - æ ¸å¿ƒé€»è¾‘

// 1. Lucene å…³é”®è¯æ£€ç´¢ï¼ˆç²—ç­›ï¼‰
SearchResult luceneResult = rag.search(keywords);

// 2. å‘é‡è¯­ä¹‰æ£€ç´¢ï¼ˆç²¾æ’ï¼‰
List<VectorSearchResult> vectorResults = vectorIndexEngine.search(
    embeddingEngine.embed(question), topK
);

// 3. æ··åˆè¯„åˆ†ï¼ˆåŠ æƒèåˆï¼‰
Map<String, Double> hybridScores = new HashMap<>();

// Lucene ç»“æœï¼ˆæƒé‡ 0.3ï¼‰
for (int i = 0; i < luceneDocs.size(); i++) {
    String docId = luceneDocs.get(i).getId();
    double normalizedScore = 1.0 - (i * 1.0 / luceneDocs.size());
    hybridScores.put(docId, 0.3 * normalizedScore);
}

// å‘é‡ç»“æœï¼ˆæƒé‡ 0.7ï¼‰
for (VectorSearchResult result : vectorResults) {
    String docId = result.getDocId();
    double currentScore = hybridScores.getOrDefault(docId, 0.0);
    hybridScores.put(docId, currentScore + 0.7 * result.getSimilarity());
}

// 4. æŒ‰æ··åˆåˆ†æ•°æ’åº
List<Document> finalDocs = hybridScores.entrySet().stream()
    .sorted((a, b) -> Double.compare(b.getValue(), a.getValue()))
    .filter(entry -> entry.getValue() >= minScore)
    .limit(topK)
    .map(entry -> rag.getDocument(entry.getKey()))
    .collect(Collectors.toList());
```

#### Rerank ç­–ç•¥å¯¹æ¯”

| ç‰¹æ€§ | é¡¹ç›®çš„ Hybrid Search | PPL Rerank |
|------|---------------------|-----------|
| **æ–¹æ³•** | Lucene(30%) + Vector(70%) | å›°æƒ‘åº¦è¯„ä¼° |
| **è¯­ä¹‰ç†è§£** | âœ… å‘é‡åµŒå…¥ | âœ… è¯­è¨€æ¨¡å‹ |
| **é€Ÿåº¦** | âš¡âš¡ å¿« | âš¡ ä¸­ç­‰ |
| **æˆæœ¬** | ğŸ’° ä½ï¼ˆæœ¬åœ°è®¡ç®—ï¼‰ | ğŸ’°ğŸ’° ä¸­ï¼ˆéœ€è¦ LMï¼‰ |
| **å¯è§£é‡Šæ€§** | âœ… åˆ†æ•°å¯è§ | âš ï¸ å›°æƒ‘åº¦æŠ½è±¡ |
| **å‡†ç¡®æ€§** | âœ… é«˜ï¼ˆåŒé‡éªŒè¯ï¼‰ | âœ… é«˜ï¼ˆæµç•…åº¦ï¼‰ |

**ç»“è®º**ï¼š
- é¡¹ç›®é‡‡ç”¨çš„ **Hybrid Search** æ˜¯ä¸€ç§æ›´å®ç”¨çš„ Rerank æ–¹æ¡ˆ
- ç»“åˆäº†è¯æ³•åŒ¹é…ï¼ˆBM25ï¼‰å’Œè¯­ä¹‰åŒ¹é…ï¼ˆVectorï¼‰
- æ¯”å•çº¯çš„ PPL Rerank æ›´åŠ å…¨é¢å’Œé«˜æ•ˆ

---

## ğŸ“Š å››ã€æ€§èƒ½ä¸æˆæœ¬å¯¹æ¯”

### 4.1 Chunking æ€§èƒ½å¯¹æ¯”

| æ–¹æ³• | å¤„ç†é€Ÿåº¦ | å†…å­˜å ç”¨ | API æˆæœ¬ | è´¨é‡è¯„åˆ† | æ¨èåœºæ™¯ |
|------|---------|---------|---------|---------|----------|
| **å›ºå®šé•¿åº¦** | âš¡âš¡âš¡ 100ms | ä½ | $0 | â­â­ | å®æ—¶ç³»ç»Ÿ |
| **æ»‘åŠ¨çª—å£** | âš¡âš¡âš¡ 150ms | ä¸­ | $0 | â­â­â­ | é€šç”¨åœºæ™¯ |
| **å…³é”®è¯åˆ‡åˆ†** | âš¡âš¡ 500ms | ä¸­ | $0 | â­â­â­â­ | å¹³è¡¡æ–¹æ¡ˆ |
| **PPL Chunking** | âš¡ 2-5s | é«˜ | $0.01-0.05 | â­â­â­â­ | ç¦»çº¿å¤„ç† |
| **AI Semantic** | ğŸŒ 5-15s | é«˜ | $0.10-0.50 | â­â­â­â­â­ | é«˜è´¨é‡éœ€æ±‚ |

### 4.2 Rerank æ€§èƒ½å¯¹æ¯”

| æ–¹æ³• | å¤„ç†æ—¶é—´ (100 docs) | API æˆæœ¬ | å‡†ç¡®ç‡æå‡ | æ¨èåœºæ™¯ |
|------|-------------------|----------|-----------|----------|
| **BM25 Only** | 50ms | $0 | åŸºå‡† | ç®€å•æŸ¥è¯¢ |
| **Vector Only** | 200ms | $0 | +15% | è¯­ä¹‰æŸ¥è¯¢ |
| **Hybrid (é¡¹ç›®)** | 300ms | $0 | +25% | é€šç”¨æ¨è âœ… |
| **PPL Rerank** | 2-3s | $0.05 | +30% | é«˜è´¨é‡éœ€æ±‚ |
| **LLM Judge** | 10-30s | $1-5 | +40% | æè‡´è´¨é‡ |

---

## ğŸ’¡ äº”ã€å®æ–½å»ºè®®

### 5.1 ä½•æ—¶ä½¿ç”¨ PPL Chunkingï¼Ÿ

âœ… **æ¨èä½¿ç”¨**ï¼š
1. **ç¦»çº¿ç´¢å¼•æ„å»º**ï¼šæœ‰å……è¶³æ—¶é—´è¿›è¡Œé«˜è´¨é‡åˆ‡åˆ†
2. **é•¿æ–‡æ¡£å¤„ç†**ï¼šæ³•å¾‹æ–‡ä»¶ã€å­¦æœ¯è®ºæ–‡ã€æŠ€æœ¯æ–‡æ¡£
3. **å¤šä¸»é¢˜æ–‡æ¡£**ï¼šéœ€è¦ç²¾ç¡®è¯†åˆ«ä¸»é¢˜è¾¹ç•Œ
4. **é«˜ä»·å€¼åœºæ™¯**ï¼šåŒ»ç–—ã€æ³•å¾‹ã€é‡‘èç­‰å¯¹å‡†ç¡®æ€§è¦æ±‚æé«˜çš„é¢†åŸŸ

âŒ **ä¸æ¨èä½¿ç”¨**ï¼š
1. **å®æ—¶ç³»ç»Ÿ**ï¼šå»¶è¿Ÿæ•æ„Ÿçš„åº”ç”¨
2. **èµ„æºå—é™**ï¼šè®¡ç®—èµ„æºæˆ–é¢„ç®—æœ‰é™
3. **ç®€å•æ–‡æ¡£**ï¼šç»“æ„æ¸…æ™°ã€ä¸»é¢˜å•ä¸€çš„æ–‡æ¡£

### 5.2 ä½•æ—¶ä½¿ç”¨ PPL Rerankï¼Ÿ

âœ… **æ¨èä½¿ç”¨**ï¼š
1. **äºŒé˜¶æ®µæ£€ç´¢**ï¼šåœ¨ç²—ç­›åçš„ç²¾æ’é˜¶æ®µ
2. **å€™é€‰é›†è¾ƒå°**ï¼šTop-50 æˆ– Top-100
3. **è´¨é‡ä¼˜å…ˆ**ï¼šæ„¿æ„ç‰ºç‰²é€Ÿåº¦æ¢å–å‡†ç¡®æ€§
4. **ç”Ÿæˆå¼åœºæ™¯**ï¼šéœ€è¦è¯„ä¼°"é—®é¢˜+ç­”æ¡ˆ"çš„æµç•…åº¦

âŒ **ä¸æ¨èä½¿ç”¨**ï¼š
1. **å¤§è§„æ¨¡æ£€ç´¢**ï¼šéœ€è¦å¯¹åƒä¸‡çº§æ–‡æ¡£æ’åº
2. **å®æ—¶å“åº”**ï¼šè¦æ±‚<100ms å“åº”
3. **æˆæœ¬æ•æ„Ÿ**ï¼šAPI è°ƒç”¨æˆæœ¬æ˜¯ç“¶é¢ˆ

### 5.3 é¡¹ç›®ä¼˜åŒ–å»ºè®®

åŸºäºå½“å‰é¡¹ç›®çš„å®ç°ï¼Œæå‡ºä»¥ä¸‹ä¼˜åŒ–å»ºè®®ï¼š

#### 1. å¢åŠ  PPL-based Chunkerï¼ˆå¯é€‰ï¼‰

```java
// æ–°å¢ï¼šPPLChunker.java
public class PPLChunker implements DocumentChunker {
    private final LanguageModel model;  // æœ¬åœ°å°å‹ LM
    private final double pplThreshold = 20.0;
    
    @Override
    public List<DocumentChunk> chunk(String content, String query) {
        List<String> sentences = splitToSentences(content);
        List<DocumentChunk> chunks = new ArrayList<>();
        List<String> currentChunk = new ArrayList<>();
        
        for (String sentence : sentences) {
            currentChunk.add(sentence);
            double ppl = model.perplexity(String.join(" ", currentChunk));
            
            if (ppl > pplThreshold && currentChunk.size() > 1) {
                // PPL çªç„¶å‡é«˜ï¼Œåˆ‡åˆ†ï¼
                chunks.add(createChunk(currentChunk, chunks.size()));
                currentChunk = new ArrayList<>();
                currentChunk.add(sentence);
            }
        }
        
        if (!currentChunk.isEmpty()) {
            chunks.add(createChunk(currentChunk, chunks.size()));
        }
        
        return chunks;
    }
}
```

#### 2. å¢å¼º Hybrid Search çš„ Rerankï¼ˆæ¨èï¼‰

```java
// ä¼˜åŒ–ï¼šHybridSearchService.java - ä¸‰é˜¶æ®µ Rerank

// é˜¶æ®µ1ï¼šLucene ç²—ç­›ï¼ˆTop-100ï¼‰
SearchResult luceneResult = rag.search(keywords, 100);

// é˜¶æ®µ2ï¼šVector ç²¾æ’ï¼ˆTop-50ï¼‰
List<VectorSearchResult> vectorResults = vectorSearch(question, 50);

// é˜¶æ®µ3ï¼šæ··åˆè¯„åˆ† + PPL å¾®è°ƒï¼ˆTop-10ï¼‰
for (Document doc : topCandidates) {
    // åŸºç¡€åˆ†æ•°
    double baseScore = hybridScore(doc);
    
    // PPL åŠ æˆï¼ˆå¯é€‰ï¼Œä»…å¯¹ Top-10 è®¡ç®—ï¼‰
    if (enablePPLBoost) {
        String combined = question + "\n" + doc.getContent();
        double ppl = calculatePerplexity(combined);
        double pplBoost = 1.0 / (1.0 + Math.log(ppl));  // å½’ä¸€åŒ–
        
        // æœ€ç»ˆåˆ†æ•°
        doc.finalScore = 0.8 * baseScore + 0.2 * pplBoost;
    }
}
```

#### 3. é…ç½®åŒ–é€‰æ‹©ï¼ˆæœ€ä½³å®è·µï¼‰

```yaml
# application.yml - æ–°å¢é…ç½®
knowledge:
  qa:
    chunking:
      strategy: SMART_KEYWORD  # é»˜è®¤æ¨è
      ppl:
        enabled: false         # å¯é€‰å¼€å¯ PPL Chunking
        threshold: 20.0
        model: local-gpt2      # æœ¬åœ°å°æ¨¡å‹
    
    rerank:
      strategy: HYBRID         # é»˜è®¤æ··åˆ
      ppl-boost:
        enabled: false         # å¯é€‰å¼€å¯ PPL åŠ æˆ
        weight: 0.2
        top-k: 10              # ä»…å¯¹ Top-10 è®¡ç®—
```

---

## ğŸ¯ å…­ã€æ€»ç»“ä¸å»ºè®®

### 6.1 å…³é”®ç»“è®º

1. **PPL Chunking** æ˜¯ä¸€ç§åŸºäºè¯­è¨€æ¨¡å‹å›°æƒ‘åº¦çš„æ™ºèƒ½åˆ‡åˆ†æ–¹æ³•
   - âœ… ä¼˜åŠ¿ï¼šè¯­ä¹‰å®Œæ•´ã€ä¸»é¢˜è¯†åˆ«å‡†ç¡®
   - âŒ åŠ£åŠ¿ï¼šè®¡ç®—æˆæœ¬é«˜ã€å¤„ç†é€Ÿåº¦æ…¢

2. **PPL Rerank** æ˜¯ä¸€ç§åŸºäºå›°æƒ‘åº¦çš„é‡æ’åºæ–¹æ³•
   - âœ… ä¼˜åŠ¿ï¼šè¯„ä¼°æµç•…åº¦ã€è‡ªç„¶åº¦é«˜
   - âŒ åŠ£åŠ¿ï¼šéœ€è¦è¯­è¨€æ¨¡å‹ã€å»¶è¿Ÿè¾ƒé«˜

3. **é¡¹ç›®ç°çŠ¶**ï¼š
   - âœ… å·²æœ‰ `AI_SEMANTIC` Chunkerï¼ŒåŠŸèƒ½ç±»ä¼¼ä½†æ›´å¼ºå¤§
   - âœ… å·²æœ‰ `Hybrid Search`ï¼Œæ¯”å•çº¯ PPL Rerank æ›´å®ç”¨
   - âœ… å½“å‰æ–¹æ¡ˆå·²ç»æ˜¯å·¥ä¸šçº§å®è·µ

### 6.2 æœ€ç»ˆå»ºè®®

**å¯¹äºå½“å‰é¡¹ç›®**ï¼š

âœ… **ä¿æŒç°æœ‰æ–¹æ¡ˆ**ï¼š
- `SMART_KEYWORD` Chunking å·²ç»å¹³è¡¡äº†æ•ˆæœå’Œæˆæœ¬
- `Hybrid Search` å·²ç»ç»“åˆäº†è¯æ³•å’Œè¯­ä¹‰

âš ï¸ **å¯é€‰å¢å¼º**ï¼š
- æ·»åŠ  PPL Chunking ä½œä¸ºé«˜çº§é€‰é¡¹ï¼ˆç¦»çº¿åœºæ™¯ï¼‰
- ä¸º Top-K ç»“æœæ·»åŠ  PPL Boostï¼ˆå¾®è°ƒç²¾åº¦ï¼‰

âŒ **ä¸æ¨è**ï¼š
- å®Œå…¨æ›¿æ¢ä¸º PPL-based æ–¹æ¡ˆï¼ˆæˆæœ¬å¤ªé«˜ï¼‰
- å¯¹æ‰€æœ‰æ–‡æ¡£ä½¿ç”¨ PPL Rerankï¼ˆæ€§èƒ½é—®é¢˜ï¼‰

### 6.3 å­¦ä¹ èµ„æº

å¦‚æœæƒ³æ·±å…¥äº†è§£ PPL æŠ€æœ¯ï¼š

ğŸ“š **è®ºæ–‡**ï¼š
- "Perplexity-Based Document Segmentation" (2019)
- "Neural Reranking with Perplexity Scores" (2020)

ğŸ”§ **å¼€æºå®ç°**ï¼š
- Hugging Face Transformers (PPL calculation)
- LangChain (Semantic chunking)

ğŸ’¡ **æœ€ä½³å®è·µ**ï¼š
- ç»“åˆå¤šç§æ–¹æ³•ï¼ˆHybridï¼‰
- åˆ†é˜¶æ®µ Rerankï¼ˆç²—ç­› â†’ ç²¾æ’ â†’ å¾®è°ƒï¼‰
- é…ç½®åŒ–åˆ‡æ¢ï¼ˆçµæ´»é€‚é…åœºæ™¯ï¼‰

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**ï¼š2025-12-04  
**ä½œè€…**ï¼šAI Assistant  
**çŠ¶æ€**ï¼šâœ… å®Œæ•´åˆ†æ

