# ğŸ“‹ RAG ç³»ç»Ÿä»£ç å®¡æŸ¥é—®é¢˜æŠ¥å‘Š

> **å®¡æŸ¥æ—¥æœŸ**: 2025-12-07  
> **å®¡æŸ¥èŒƒå›´**: RAG æ£€ç´¢æ ¸å¿ƒæ¨¡å—ã€åé¦ˆç³»ç»Ÿã€ç­–ç•¥æ¡†æ¶  
> **å®¡æŸ¥äºº**: AI Code Reviewer  
> **æ›´æ–°**: 2025-12-07 - å·²ä¿®å¤é«˜ä¼˜å…ˆçº§ç¡¬ç¼–ç é—®é¢˜

---

## ğŸ“Š é—®é¢˜ç»Ÿè®¡

| é—®é¢˜ç±»å‹ | æ•°é‡ | ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ | çŠ¶æ€ |
|---------|------|-------------|------|
| ç¡¬ç¼–ç é—®é¢˜ | 8 | ğŸ”´ é«˜: 3, ğŸŸ¡ ä¸­: 4, ğŸŸ¢ ä½: 1 | âœ… å…¨éƒ¨å·²ä¿®å¤ |
| æ‰©å±•æ€§é—®é¢˜ | 5 | ğŸ”´ é«˜: 2, ğŸŸ¡ ä¸­: 3 | âœ… E1,E2,E5å·²ä¿®å¤ |
| æ½œåœ¨ç¼ºé™· | 4 | ğŸŸ¡ ä¸­: 3, ğŸŸ¢ ä½: 1 | âœ… å…¨éƒ¨å·²ä¿®å¤ |
| æ€§èƒ½é—®é¢˜ | 3 | ğŸŸ¡ ä¸­: 2, ğŸŸ¢ ä½: 1 | âœ… å…¨éƒ¨å·²ä¿®å¤ |
| ä»£ç è§„èŒƒ | 2 | ğŸŸ¢ ä½: 2 | âœ… å…¨éƒ¨å·²ä¿®å¤ |

---

## âœ… å·²ä¿®å¤çš„é«˜ä¼˜å…ˆçº§é—®é¢˜

### 1. ~~æ··åˆæ£€ç´¢æƒé‡ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `HybridSearchService.java`  
**ä¿®å¤å†…å®¹**:
- åœ¨ `KnowledgeQAProperties.VectorSearchConfig` ä¸­æ·»åŠ äº† `luceneWeight` å’Œ `vectorWeight` é…ç½®
- ä¿®æ”¹ `HybridSearchService` ä½¿ç”¨é…ç½®çš„æƒé‡å€¼

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    vector-search:
      # Lucene å…³é”®è¯æ£€ç´¢æƒé‡ï¼ˆ0.0-1.0ï¼‰
      lucene-weight: 0.3
      # å‘é‡è¯­ä¹‰æ£€ç´¢æƒé‡ï¼ˆ0.0-1.0ï¼‰
      vector-weight: 0.7
```

---

### 2. ~~åŒä¹‰è¯è¯å…¸ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `QueryExpansionService.java`  
**ä¿®å¤å†…å®¹**:
- æ·»åŠ äº† `QueryExpansionConfig` é…ç½®ç±»
- æ”¯æŒä»å¤–éƒ¨æ–‡ä»¶åŠ è½½åŒä¹‰è¯ï¼ˆ`synonym-file` é…ç½®é¡¹ï¼‰
- ä¿ç•™å†…ç½®åŒä¹‰è¯ä½œä¸ºåŸºç¡€ï¼Œå¤–éƒ¨æ–‡ä»¶è¿½åŠ /è¦†ç›–

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    query-expansion:
      enabled: true
      synonym-file: ./data/synonyms.txt  # æ ¼å¼: è¯1,åŒä¹‰è¯1,åŒä¹‰è¯2,...
      use-llm-rewrite: false
```

---

### 3. ~~åœç”¨è¯åˆ—è¡¨ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `QueryExpansionService.java` å’Œ `SimilarQAService.java`  
**ä¿®å¤å†…å®¹**:
- ç»Ÿä¸€ä½¿ç”¨ `KnowledgeQAProperties.SearchConfig` ä¸­é…ç½®çš„åœç”¨è¯
- `QueryExpansionService` å’Œ `SimilarQAService` éƒ½ä»é…ç½®åŠ è½½åœç”¨è¯
- ç§»é™¤äº†å„è‡ªç¡¬ç¼–ç çš„åœç”¨è¯åˆ—è¡¨

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

### 4. ~~PPL Rerank åŸå§‹åˆ†æ•°å¤„ç†ä¸å½“~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `PPLOnnxService.java` å’Œ `HybridSearchService.java`  
**ä¿®å¤å†…å®¹**:
- åœ¨ `HybridSearchService` ä¸­ä¿å­˜æ£€ç´¢åˆ†æ•°åˆ° `Document.score` å­—æ®µ
- åœ¨ `PPLOnnxService.rerank` ä¸­è¯»å– `doc.getScore()` ä½œä¸ºåŸå§‹åˆ†æ•°
- æ·»åŠ è°ƒè¯•æ—¥å¿—è®°å½•æ··åˆè¯„åˆ†è¿‡ç¨‹

**ä¿®å¤åçš„ä»£ç **:
```java
// HybridSearchService - ä¿å­˜æ£€ç´¢åˆ†æ•°
doc.setScore(entry.getValue());

// PPLOnnxService - ä½¿ç”¨åŸå§‹åˆ†æ•°
double originalScore = doc.getScore() != null ? doc.getScore() : 1.0;
double finalScore = (1 - weight) * originalScore + weight * pplScore;
```

---

### 5. ~~ç›¸ä¼¼é—®é¢˜æœåŠ¡ç¡¬ç¼–ç é™åˆ¶~~ âœ… å·²åœ¨ç¬¬ä¸€é˜¶æ®µä¿®å¤

å·²é€šè¿‡ `SimilarQAConfig` é…ç½®åŒ–ã€‚

---

### 6. ~~å›¾ç‰‡åˆ—è¡¨æ•°é‡ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `KnowledgeQAService.java` å’Œ `KnowledgeQAProperties.java`  
**ä¿®å¤å†…å®¹**:
- åœ¨ `ImageProcessingConfig` ä¸­æ·»åŠ äº† `maxImagesPerDoc` é…ç½®
- ä¿®æ”¹ `KnowledgeQAService` ä»é…ç½®è¯»å–å›¾ç‰‡æ•°é‡é™åˆ¶

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    image-processing:
      max-images-per-doc: 5
```

---

### 7. ~~ä¼šè¯è¿‡æœŸæ—¶é—´ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SearchSessionService.java` å’Œ `KnowledgeQAProperties.java`  
**ä¿®å¤å†…å®¹**:
- æ·»åŠ äº† `SessionConfig` é…ç½®ç±»
- ä¿®æ”¹ `SearchSessionService` ä»é…ç½®è¯»å–è¶…æ—¶æ—¶é—´

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    session:
      timeout-minutes: 30
      max-sessions: 1000
```

---

### 8. ~~LLM æ”¹å†™ Prompt ç¡¬ç¼–ç ~~ âœ… å·²åœ¨ç¬¬ä¸€é˜¶æ®µä¿®å¤

å·²é€šè¿‡ `QueryExpansionConfig.llmRewritePrompt` é…ç½®åŒ–ã€‚

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    query-expansion:
      llm-rewrite-prompt: |
        è¯·å¸®æˆ‘æ”¹å†™ä»¥ä¸‹æœç´¢æŸ¥è¯¢...
        åŸå§‹æŸ¥è¯¢ï¼š{query}
        æ”¹å†™åçš„æŸ¥è¯¢ï¼š
```

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜

### 9. ~~æ—¥å¿—çº§åˆ«ä¸ä¸€è‡´~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `KnowledgeQAService.java`  
**ä¿®å¤å†…å®¹**:
- å°† PPL Rerank ç›¸å…³çš„ç¡¬ç¼–ç æ—¥å¿—æ”¹ä¸ºä½¿ç”¨ `I18N.get()`
- æ·»åŠ äº† `log.ppl.rerank_start`ã€`log.ppl.rerank_completed`ã€`log.ppl.rerank_failed` å›½é™…åŒ–æ¶ˆæ¯

**ä¿®å¤åçš„ä»£ç **:
```java
log.info(I18N.get("log.ppl.rerank_start", documents.size()));
log.info(I18N.get("log.ppl.rerank_completed", rerankTime));
log.warn(I18N.get("log.ppl.rerank_failed", e.getMessage()));
```

---

### 10. ~~é­”æ³•æ•°å­—~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `HybridSearchService.java`ã€`KnowledgeQAService.java`ã€`KnowledgeQAProperties.java`  
**ä¿®å¤å†…å®¹**:
- åœ¨ `VectorSearchConfig` ä¸­æ·»åŠ äº† `logDisplayLimit` é…ç½®
- ä¿®æ”¹ `HybridSearchService` ä½¿ç”¨é…ç½®çš„æ—¥å¿—æ˜¾ç¤ºæ•°é‡
- ä¿®æ”¹ `KnowledgeQAService` ä½¿ç”¨ `SimilarQAConfig` ä¸­çš„å‚æ•°

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    vector-search:
      log-display-limit: 10  # æ—¥å¿—ä¸­æ˜¾ç¤ºçš„æœ€å¤§æ–‡æ¡£æ•°é‡
    similar-qa:
      min-score: 30          # æœ€å°ç›¸ä¼¼åº¦åˆ†æ•°
      limit: 3               # æ¨èç»“æœæ•°é‡ä¸Šé™
```

---

## ğŸ”§ æ‰©å±•æ€§é—®é¢˜

### ~~E1. ç­–ç•¥æ¨¡å¼æœªå®Œå…¨åº”ç”¨äºæ£€ç´¢~~ âœ… å·²ä¿®å¤

**æ–°å¢æ–‡ä»¶**:
- `SearchStrategy.java` - æ£€ç´¢ç­–ç•¥æ¥å£
- `SearchContext.java` - æ£€ç´¢ä¸Šä¸‹æ–‡
- `SearchStrategyDispatcher.java` - æ£€ç´¢ç­–ç•¥è°ƒåº¦å™¨
- `HybridSearchStrategy.java` - æ··åˆæ£€ç´¢ç­–ç•¥å®ç°
- `KeywordSearchStrategy.java` - å…³é”®è¯æ£€ç´¢ç­–ç•¥å®ç°
- `VectorSearchStrategy.java` - å‘é‡æ£€ç´¢ç­–ç•¥å®ç°

**åŠŸèƒ½ç‰¹æ€§**:
- å¯æ’æ‹”çš„æ£€ç´¢ç­–ç•¥è®¾è®¡
- è‡ªåŠ¨é€‰æ‹©æœ€ä½³ç­–ç•¥ï¼ˆåŸºäºé€‚ç”¨æ€§è¯„åˆ†ï¼‰
- æ”¯æŒæŒ‡å®šç­–ç•¥æ‰§è¡Œ
- ç­–ç•¥é™çº§æœºåˆ¶
- è¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œç­–ç•¥

---

### ~~E2. è¯„åˆ†èåˆç®—æ³•ä¸å¯æ‰©å±•~~ âœ… å·²ä¿®å¤

**æ–°å¢æ–‡ä»¶**:
- `ScoreContributor.java` - è¯„åˆ†è´¡çŒ®è€…æ¥å£
- `ScoreFusionService.java` - è¯„åˆ†èåˆæœåŠ¡
- `LuceneScoreContributor.java` - Lucene è¯„åˆ†è´¡çŒ®è€…
- `VectorScoreContributor.java` - å‘é‡è¯„åˆ†è´¡çŒ®è€…
- `FeedbackScoreContributor.java` - åé¦ˆè¯„åˆ†è´¡çŒ®è€…

**åŠŸèƒ½ç‰¹æ€§**:
- å¯æ‰©å±•çš„è¯„åˆ†è´¡çŒ®è€…è®¾è®¡
- æ”¯æŒåŠ æƒèåˆ
- è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ /ç§»é™¤è´¡çŒ®è€…
- è´¡çŒ®è€…ä¼˜å…ˆçº§æ§åˆ¶

---

### E3. åŒä¹‰è¯è¯å…¸ä¸æ”¯æŒåŠ¨æ€æ›´æ–°

**å½“å‰çŠ¶æ€**:
- é™æ€åˆå§‹åŒ–ï¼Œè¿è¡Œæ—¶æ— æ³•æ›´æ–°
- æ²¡æœ‰ç®¡ç†æ¥å£

**å»ºè®®**:
- æ·»åŠ åŒä¹‰è¯ç®¡ç† API
- æ”¯æŒçƒ­åŠ è½½é…ç½®æ–‡ä»¶
- æä¾› UI ç®¡ç†ç•Œé¢

---

### E4. ç¼ºå°‘æ£€ç´¢ç»“æœç¼“å­˜

**å½“å‰çŠ¶æ€**:
- æ¯æ¬¡é—®ç­”éƒ½é‡æ–°æ£€ç´¢
- ç›¸ä¼¼é—®é¢˜é‡å¤è®¡ç®—

**å»ºè®®**:
```java
@Service
public class SearchCacheService {
    private final Cache<String, List<Document>> searchCache;
    
    public List<Document> getCachedOrSearch(String question, 
            Supplier<List<Document>> searchFn) {
        String cacheKey = generateCacheKey(question);
        return searchCache.get(cacheKey, k -> searchFn.get());
    }
}
```

---

### ~~E5. åé¦ˆç³»ç»Ÿä¸æ£€ç´¢æœªæ·±åº¦é›†æˆ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `HybridSearchService.java`  
**ä¿®å¤å†…å®¹**:
- æ³¨å…¥ `DocumentWeightService`
- åœ¨æ··åˆè¯„åˆ†ååº”ç”¨æ–‡æ¡£åé¦ˆæƒé‡
- é«˜åˆ†æ–‡æ¡£è‡ªåŠ¨æå‡æ’åï¼Œä½åˆ†æ–‡æ¡£è‡ªåŠ¨é™ä½æ’å

**ä¿®å¤åçš„ä»£ç **:
```java
// åº”ç”¨æ–‡æ¡£åé¦ˆæƒé‡
if (documentWeightService != null) {
    double feedbackWeight = documentWeightService.getDocumentWeight(doc.getTitle());
    double adjustedScore = originalScore * feedbackWeight;
    hybridScores.put(entry.getKey(), adjustedScore);
}
```

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®æ±‡æ€»

### é…ç½®åŒ–æ”¹è¿›

éœ€è¦ç§»åˆ°é…ç½®æ–‡ä»¶çš„é¡¹ç›®ï¼š

| é…ç½®é¡¹ | å½“å‰ä½ç½® | å»ºè®®é…ç½®è·¯å¾„ |
|--------|---------|-------------|
| Luceneæƒé‡ | ä»£ç ç¡¬ç¼–ç  0.3 | `vector-search.lucene-weight` |
| å‘é‡æƒé‡ | ä»£ç ç¡¬ç¼–ç  0.7 | `vector-search.vector-weight` |
| åŒä¹‰è¯è¯å…¸ | ä»£ç é™æ€å— | `query-expansion.synonym-file` |
| åœç”¨è¯ | å¤šå¤„é‡å¤ | ç»Ÿä¸€ä½¿ç”¨ `search.chinese/english-stop-words` |
| ç›¸ä¼¼é—®é¢˜é˜ˆå€¼ | ä»£ç ç¡¬ç¼–ç  30, 4 | `similar-qa.min-score`, `similar-qa.min-rating` |
| å›¾ç‰‡æ•°é‡é™åˆ¶ | ä»£ç ç¡¬ç¼–ç  5 | `image-processing.max-images-per-doc` |
| å†å²è®°å½•é™åˆ¶ | ä»£ç ç¡¬ç¼–ç  100 | `similar-qa.history-limit` |

### æ¶æ„æ”¹è¿›

1. **ç»Ÿä¸€åœç”¨è¯æœåŠ¡** - é¿å…é‡å¤å®šä¹‰
2. **æ£€ç´¢ç­–ç•¥æ¡†æ¶** - å‚è€ƒå¤šæ–‡æ¡£åˆ†æç­–ç•¥è®¾è®¡
3. **è¯„åˆ†èåˆæ¥å£** - å¯æ‰©å±•çš„è¯„åˆ†è®¡ç®—
4. **æ£€ç´¢ç»“æœç¼“å­˜** - æå‡æ€§èƒ½
5. **æƒé‡å®é™…åº”ç”¨** - åé¦ˆæƒé‡å½±å“æ£€ç´¢æ’åº

---

## âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **å®Œå–„çš„å›½é™…åŒ–æ”¯æŒ** - å¤§éƒ¨åˆ†æ—¥å¿—å’Œæ¶ˆæ¯å·²å›½é™…åŒ–
2. **å¯æ’æ‹”çš„ AI å¼•æ“** - PPLã€LLMã€Vision éƒ½æ”¯æŒå¤šç§å®ç°
3. **é™çº§ç­–ç•¥** - PPL æœåŠ¡æ”¯æŒè‡ªåŠ¨é™çº§
4. **ä¼šè¯ç®¡ç†** - æ”¯æŒåˆ†æ‰¹å¼•ç”¨æ–‡æ¡£
5. **é…ç½®åŠ¨æ€ä¿®æ”¹** - `SearchConfigService` æ”¯æŒè¿è¡Œæ—¶è°ƒæ•´å‚æ•°
6. **è¯¦ç»†çš„æ—¥å¿—** - æ£€ç´¢è¿‡ç¨‹æœ‰å®Œæ•´çš„æ—¥å¿—è®°å½•
7. **ç­–ç•¥æ¡†æ¶** - å¤šæ–‡æ¡£åˆ†ææœ‰è‰¯å¥½çš„ç­–ç•¥æ¨¡å¼è®¾è®¡

---

## ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2å¤©ï¼‰âœ… å·²å®Œæˆ
1. âœ… æ··åˆæ£€ç´¢æƒé‡é…ç½®åŒ–
2. âœ… åŒä¹‰è¯è¯å…¸å¤–éƒ¨åŒ–
3. âœ… ç»Ÿä¸€åœç”¨è¯æœåŠ¡
4. âœ… ç›¸ä¼¼é—®é¢˜å‚æ•°é…ç½®åŒ–ï¼ˆSimilarQAConfigï¼‰

### ç¬¬äºŒé˜¶æ®µï¼ˆ3-5å¤©ï¼‰âœ… å·²å®Œæˆ
5. âœ… PPL Rerank åŸå§‹åˆ†æ•°ä¼ é€’
6. âœ… åé¦ˆæƒé‡åº”ç”¨åˆ°æ£€ç´¢
7. âœ… å›¾ç‰‡åˆ—è¡¨æ•°é‡é…ç½®åŒ–
8. âœ… ä¼šè¯è¶…æ—¶æ—¶é—´é…ç½®åŒ–
9. âœ… LLM æ”¹å†™ Prompt é…ç½®åŒ–
10. âœ… æ—¥å¿—çº§åˆ«ç»Ÿä¸€å›½é™…åŒ–
11. âœ… é­”æ³•æ•°å­—é…ç½®åŒ–

### ç¬¬ä¸‰é˜¶æ®µ âœ… å·²å®Œæˆ
12. âœ… æ½œåœ¨ç¼ºé™·ä¿®å¤
13. âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆæ£€ç´¢ç¼“å­˜ï¼‰

### ç¬¬å››é˜¶æ®µ âœ… å·²å®Œæˆ
14. âœ… æ£€ç´¢ç­–ç•¥æ¡†æ¶
15. âœ… è¯„åˆ†èåˆæ¥å£

---

## ğŸ› æ½œåœ¨ç¼ºé™·ä¿®å¤

### D1. ~~ä¼šè¯æ•°é‡é™åˆ¶æœªå®ç°~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SearchSessionService.java`  
**é—®é¢˜**: é…ç½®äº† `maxSessions` ä½†æœªå®é™…ä½¿ç”¨  
**ä¿®å¤å†…å®¹**:
- æ·»åŠ  `enforceSessionLimit()` æ–¹æ³•
- åœ¨åˆ›å»ºä¼šè¯å‰æ£€æŸ¥æ•°é‡é™åˆ¶
- è¶…é™æ—¶è‡ªåŠ¨é©±é€æœ€æ—§çš„ä¼šè¯

**ä¿®å¤åçš„ä»£ç **:
```java
private void enforceSessionLimit() {
    int maxSessions = properties.getSession().getMaxSessions();
    while (sessions.size() >= maxSessions) {
        // æ‰¾åˆ°å¹¶åˆ é™¤æœ€æ—§çš„ä¼šè¯
        String oldestSessionId = sessions.entrySet().stream()
            .min(Comparator.comparing(e -> e.getValue().getLastAccessTime()))
            .map(Map.Entry::getKey)
            .orElse(null);
        if (oldestSessionId != null) {
            sessions.remove(oldestSessionId);
        }
    }
}
```

---

### D2. ~~ç©ºæŒ‡é’ˆæ£€æŸ¥ä¸å®Œæ•´~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SimilarQAService.java`  
**é—®é¢˜**: éƒ¨åˆ†æ–¹æ³•ç¼ºå°‘å‚æ•°å’Œä¾èµ–é¡¹çš„ null æ£€æŸ¥  
**ä¿®å¤å†…å®¹**:
- æ·»åŠ  `question` å‚æ•°çš„ç©ºæ£€æŸ¥
- æ·»åŠ  `qaRecordService` ä¾èµ–çš„ç©ºæ£€æŸ¥
- æ·»åŠ  `SimilarQAConfig` é…ç½®çš„ç©ºæ£€æŸ¥
- æ·»åŠ  `QARecord` åŠå…¶å­—æ®µçš„ç©ºæ£€æŸ¥

---

### D3. ~~é…ç½®é»˜è®¤å€¼å…œåº•~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SimilarQAService.java`  
**é—®é¢˜**: é…ç½®å¯¹è±¡å¯èƒ½ä¸º null å¯¼è‡´ NPE  
**ä¿®å¤å†…å®¹**:
```java
KnowledgeQAProperties.SimilarQAConfig config = properties.getSimilarQa();
if (config == null) {
    config = new KnowledgeQAProperties.SimilarQAConfig();
}
```

---

### D4. ~~è¿”å›å€¼ç©ºå®‰å…¨~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SimilarQAService.java`  
**é—®é¢˜**: `answer` å­—æ®µå¯èƒ½ä¸º null  
**ä¿®å¤å†…å®¹**:
```java
qa.setAnswer(record.getAnswer() != null ? record.getAnswer() : "");
```

---

## âš¡ æ€§èƒ½é—®é¢˜ä¿®å¤

### P1. ~~ç¼ºå°‘æ£€ç´¢ç»“æœç¼“å­˜~~ âœ… å·²ä¿®å¤

**æ–°å¢æ–‡ä»¶**: `SearchCacheService.java`  
**é—®é¢˜**: æ¯æ¬¡é—®ç­”éƒ½é‡æ–°æ‰§è¡Œå®Œæ•´æ£€ç´¢ï¼Œæµªè´¹èµ„æº  
**ä¿®å¤å†…å®¹**:
- åˆ›å»º `SearchCacheService` æœåŠ¡
- ä½¿ç”¨ Caffeine ç¼“å­˜æ£€ç´¢ç»“æœ
- æ”¯æŒæŸ¥è¯¢æ‰©å±•ç»“æœç¼“å­˜
- å¯é…ç½®ç¼“å­˜å¤§å°å’Œè¿‡æœŸæ—¶é—´

**æ ¸å¿ƒæ–¹æ³•**:
```java
public List<Document> getCachedOrSearch(String question, 
        Supplier<List<Document>> searchFn) {
    String cacheKey = generateCacheKey(question);
    CachedSearchResult cached = searchCache.getIfPresent(cacheKey);
    if (cached != null) {
        return cached.getDocuments();
    }
    List<Document> documents = searchFn.get();
    searchCache.put(cacheKey, new CachedSearchResult(documents));
    return documents;
}
```

---

### P2. ~~HybridSearchService é›†æˆç¼“å­˜~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `HybridSearchService.java`  
**ä¿®å¤å†…å®¹**:
- æ³¨å…¥ `SearchCacheService`
- åœ¨ `hybridSearch` æ–¹æ³•ä¸­ä½¿ç”¨ç¼“å­˜åŒ…è£…æ£€ç´¢é€»è¾‘
- ç›¸ä¼¼æŸ¥è¯¢è‡ªåŠ¨å¤ç”¨ç¼“å­˜ç»“æœ

**ä¿®å¤åçš„ä»£ç **:
```java
public List<Document> hybridSearch(String question, ...) {
    if (searchCacheService != null) {
        return searchCacheService.getCachedOrSearch(question, 
            () -> doHybridSearch(question, rag, embeddingEngine, vectorIndexEngine));
    }
    return doHybridSearch(question, rag, embeddingEngine, vectorIndexEngine);
}
```

---

### P3. ~~æŸ¥è¯¢æ‰©å±•ç»“æœç¼“å­˜~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SearchCacheService.java`  
**é—®é¢˜**: åŒä¹‰è¯æ‰©å±•æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—  
**ä¿®å¤å†…å®¹**:
- æ·»åŠ  `queryExpansionCache` ç¼“å­˜
- æä¾› `getCachedOrExpand()` æ–¹æ³•

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2025-12-07  
**æœ€åæ›´æ–°**: 2025-12-07 - å®Œæˆç¬¬å››é˜¶æ®µï¼ˆæ£€ç´¢ç­–ç•¥æ¡†æ¶ã€è¯„åˆ†èåˆæ¥å£ï¼‰  
**çŠ¶æ€**: ğŸ‰ æ‰€æœ‰è®¡åˆ’é—®é¢˜å·²ä¿®å¤ï¼
