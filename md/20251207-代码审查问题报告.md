# ğŸ“‹ RAG ç³»ç»Ÿä»£ç å®¡æŸ¥é—®é¢˜æŠ¥å‘Š

> **å®¡æŸ¥æ—¥æœŸ**: 2025-12-07  
> **å®¡æŸ¥èŒƒå›´**: RAG æ£€ç´¢æ ¸å¿ƒæ¨¡å—ã€åé¦ˆç³»ç»Ÿã€ç­–ç•¥æ¡†æ¶  
> **å®¡æŸ¥äºº**: AI Code Reviewer  
> **æ›´æ–°**: 2025-12-07 - å·²ä¿®å¤é«˜ä¼˜å…ˆçº§ç¡¬ç¼–ç é—®é¢˜

---

## ğŸ“Š é—®é¢˜ç»Ÿè®¡

| é—®é¢˜ç±»å‹ | æ•°é‡ | ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ | çŠ¶æ€ |
|---------|------|-------------|------|
| ç¡¬ç¼–ç é—®é¢˜ | 8 | ğŸ”´ é«˜: 3, ğŸŸ¡ ä¸­: 4, ğŸŸ¢ ä½: 1 | âœ… å…¨éƒ¨å·²ä¿®å¤ |
| æ‰©å±•æ€§é—®é¢˜ | 5 | ğŸ”´ é«˜: 2, ğŸŸ¡ ä¸­: 3 | âœ… E5å·²ä¿®å¤ |
| æ½œåœ¨ç¼ºé™· | 4 | ğŸŸ¡ ä¸­: 3, ğŸŸ¢ ä½: 1 | ğŸ“‹ å¾…å¤„ç† |
| æ€§èƒ½é—®é¢˜ | 3 | ğŸŸ¡ ä¸­: 2, ğŸŸ¢ ä½: 1 | ğŸ“‹ å¾…å¤„ç† |
| ä»£ç è§„èŒƒ | 2 | ğŸŸ¢ ä½: 2 | ğŸ“‹ å¾…å¤„ç† |

---

## âœ… å·²ä¿®å¤çš„é«˜ä¼˜å…ˆçº§é—®é¢˜

### 1. ~~æ··åˆæ£€ç´¢æƒé‡ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `HybridSearchService.java`  
**ä¿®å¤å†…å®¹**:
- åœ¨ `KnowledgeQAProperties.VectorSearchConfig` ä¸­æ·»åŠ äº† `luceneWeight` å’Œ `vectorWeight` é…ç½®
- ä¿®æ”¹ `HybridSearchService` ä½¿ç”¨é…ç½®çš„æƒé‡å€¼

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    vector-search:
      # Lucene å…³é”®è¯æ£€ç´¢æƒé‡ï¼ˆ0.0-1.0ï¼‰
      lucene-weight: 0.3
      # å‘é‡è¯­ä¹‰æ£€ç´¢æƒé‡ï¼ˆ0.0-1.0ï¼‰
      vector-weight: 0.7
```

---

### 2. ~~åŒä¹‰è¯è¯å…¸ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `QueryExpansionService.java`  
**ä¿®å¤å†…å®¹**:
- æ·»åŠ äº† `QueryExpansionConfig` é…ç½®ç±»
- æ”¯æŒä»å¤–éƒ¨æ–‡ä»¶åŠ è½½åŒä¹‰è¯ï¼ˆ`synonym-file` é…ç½®é¡¹ï¼‰
- ä¿ç•™å†…ç½®åŒä¹‰è¯ä½œä¸ºåŸºç¡€ï¼Œå¤–éƒ¨æ–‡ä»¶è¿½åŠ /è¦†ç›–

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    query-expansion:
      enabled: true
      synonym-file: ./data/synonyms.txt  # æ ¼å¼: è¯1,åŒä¹‰è¯1,åŒä¹‰è¯2,...
      use-llm-rewrite: false
```

---

### 3. ~~åœç”¨è¯åˆ—è¡¨ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `QueryExpansionService.java` å’Œ `SimilarQAService.java`  
**ä¿®å¤å†…å®¹**:
- ç»Ÿä¸€ä½¿ç”¨ `KnowledgeQAProperties.SearchConfig` ä¸­é…ç½®çš„åœç”¨è¯
- `QueryExpansionService` å’Œ `SimilarQAService` éƒ½ä»é…ç½®åŠ è½½åœç”¨è¯
- ç§»é™¤äº†å„è‡ªç¡¬ç¼–ç çš„åœç”¨è¯åˆ—è¡¨

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

### 4. ~~PPL Rerank åŸå§‹åˆ†æ•°å¤„ç†ä¸å½“~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `PPLOnnxService.java` å’Œ `HybridSearchService.java`  
**ä¿®å¤å†…å®¹**:
- åœ¨ `HybridSearchService` ä¸­ä¿å­˜æ£€ç´¢åˆ†æ•°åˆ° `Document.score` å­—æ®µ
- åœ¨ `PPLOnnxService.rerank` ä¸­è¯»å– `doc.getScore()` ä½œä¸ºåŸå§‹åˆ†æ•°
- æ·»åŠ è°ƒè¯•æ—¥å¿—è®°å½•æ··åˆè¯„åˆ†è¿‡ç¨‹

**ä¿®å¤åçš„ä»£ç **:
```java
// HybridSearchService - ä¿å­˜æ£€ç´¢åˆ†æ•°
doc.setScore(entry.getValue());

// PPLOnnxService - ä½¿ç”¨åŸå§‹åˆ†æ•°
double originalScore = doc.getScore() != null ? doc.getScore() : 1.0;
double finalScore = (1 - weight) * originalScore + weight * pplScore;
```

---

### 5. ~~ç›¸ä¼¼é—®é¢˜æœåŠ¡ç¡¬ç¼–ç é™åˆ¶~~ âœ… å·²åœ¨ç¬¬ä¸€é˜¶æ®µä¿®å¤

å·²é€šè¿‡ `SimilarQAConfig` é…ç½®åŒ–ã€‚

---

### 6. ~~å›¾ç‰‡åˆ—è¡¨æ•°é‡ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `KnowledgeQAService.java` å’Œ `KnowledgeQAProperties.java`  
**ä¿®å¤å†…å®¹**:
- åœ¨ `ImageProcessingConfig` ä¸­æ·»åŠ äº† `maxImagesPerDoc` é…ç½®
- ä¿®æ”¹ `KnowledgeQAService` ä»é…ç½®è¯»å–å›¾ç‰‡æ•°é‡é™åˆ¶

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    image-processing:
      max-images-per-doc: 5
```

---

### 7. ~~ä¼šè¯è¿‡æœŸæ—¶é—´ç¡¬ç¼–ç ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SearchSessionService.java` å’Œ `KnowledgeQAProperties.java`  
**ä¿®å¤å†…å®¹**:
- æ·»åŠ äº† `SessionConfig` é…ç½®ç±»
- ä¿®æ”¹ `SearchSessionService` ä»é…ç½®è¯»å–è¶…æ—¶æ—¶é—´

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    session:
      timeout-minutes: 30
      max-sessions: 1000
```

---

### 8. ~~LLM æ”¹å†™ Prompt ç¡¬ç¼–ç ~~ âœ… å·²åœ¨ç¬¬ä¸€é˜¶æ®µä¿®å¤

å·²é€šè¿‡ `QueryExpansionConfig.llmRewritePrompt` é…ç½®åŒ–ã€‚

**é…ç½®ç¤ºä¾‹**:
```yaml
knowledge:
  qa:
    query-expansion:
      llm-rewrite-prompt: |
        è¯·å¸®æˆ‘æ”¹å†™ä»¥ä¸‹æœç´¢æŸ¥è¯¢...
        åŸå§‹æŸ¥è¯¢ï¼š{query}
        æ”¹å†™åçš„æŸ¥è¯¢ï¼š
```

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜

### 9. æ—¥å¿—çº§åˆ«ä¸ä¸€è‡´

**æ–‡ä»¶**: å¤šå¤„  
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½

```java
// æœ‰äº›ä½¿ç”¨ emoji + ä¸­æ–‡
log.info("ğŸ”„ Starting PPL Rerank for {} documents...", documents.size());
log.info("âœ… PPL Rerank completed in {}ms", rerankTime);

// æœ‰äº›ä½¿ç”¨å›½é™…åŒ–
log.info(I18N.get("log.hybrid.completed", finalDocs.size(), elapsed));
```

**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨å›½é™…åŒ–ï¼Œemoji å¯ä»¥æ”¾åœ¨å›½é™…åŒ–æ¶ˆæ¯ä¸­ã€‚

---

### 10. é­”æ³•æ•°å­—

**æ–‡ä»¶**: å¤šå¤„  
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½

```java
// HybridSearchService.java
for (int i = 0; i < Math.min(10, luceneDocs.size()); i++)  // âš ï¸ 10
for (int i = 0; i < Math.min(sortedScores.size(), 20); i++)  // âš ï¸ 20

// SimilarQAService.java  
similarQuestions = similarQAService.findSimilar(question, 30, 3);  // âš ï¸ 30, 3
```

**å»ºè®®**: æå–ä¸ºæœ‰æ„ä¹‰çš„å¸¸é‡æˆ–é…ç½®ã€‚

---

## ğŸ”§ æ‰©å±•æ€§é—®é¢˜

### E1. ç­–ç•¥æ¨¡å¼æœªå®Œå…¨åº”ç”¨äºæ£€ç´¢

**å½“å‰çŠ¶æ€**:
- å¤šæ–‡æ¡£åˆ†ææœ‰å®Œå–„çš„ç­–ç•¥æ¡†æ¶ (`MultiDocAnalysisStrategy`)
- ä½†æ··åˆæ£€ç´¢æ²¡æœ‰ç­–ç•¥æ¥å£

**å»ºè®®**:
```java
public interface SearchStrategy {
    String getId();
    List<Document> search(String question, SearchContext context);
    int evaluateSuitability(SearchContext context);
}

// å®ç°ç±»
public class HybridSearchStrategy implements SearchStrategy { ... }
public class KeywordOnlyStrategy implements SearchStrategy { ... }
public class VectorOnlyStrategy implements SearchStrategy { ... }
public class PPLEnhancedSearchStrategy implements SearchStrategy { ... }
```

---

### E2. è¯„åˆ†èåˆç®—æ³•ä¸å¯æ‰©å±•

**å½“å‰çŠ¶æ€**:
- åªæœ‰å›ºå®šçš„ `0.3*Lucene + 0.7*å‘é‡` å…¬å¼
- æ— æ³•è½»æ¾æ·»åŠ å…¶ä»–è¯„åˆ†æ¥æº

**å»ºè®®**:
```java
public interface ScoreContributor {
    String getName();
    Map<String, Double> contribute(String question, List<String> docIds);
    double getWeight();
}

// èåˆå™¨
public class ScoreFusion {
    private List<ScoreContributor> contributors;
    
    public Map<String, Double> fuse(String question, List<String> docIds) {
        Map<String, Double> finalScores = new HashMap<>();
        for (ScoreContributor c : contributors) {
            Map<String, Double> scores = c.contribute(question, docIds);
            // åŠ æƒèåˆ
        }
        return finalScores;
    }
}
```

---

### E3. åŒä¹‰è¯è¯å…¸ä¸æ”¯æŒåŠ¨æ€æ›´æ–°

**å½“å‰çŠ¶æ€**:
- é™æ€åˆå§‹åŒ–ï¼Œè¿è¡Œæ—¶æ— æ³•æ›´æ–°
- æ²¡æœ‰ç®¡ç†æ¥å£

**å»ºè®®**:
- æ·»åŠ åŒä¹‰è¯ç®¡ç† API
- æ”¯æŒçƒ­åŠ è½½é…ç½®æ–‡ä»¶
- æä¾› UI ç®¡ç†ç•Œé¢

---

### E4. ç¼ºå°‘æ£€ç´¢ç»“æœç¼“å­˜

**å½“å‰çŠ¶æ€**:
- æ¯æ¬¡é—®ç­”éƒ½é‡æ–°æ£€ç´¢
- ç›¸ä¼¼é—®é¢˜é‡å¤è®¡ç®—

**å»ºè®®**:
```java
@Service
public class SearchCacheService {
    private final Cache<String, List<Document>> searchCache;
    
    public List<Document> getCachedOrSearch(String question, 
            Supplier<List<Document>> searchFn) {
        String cacheKey = generateCacheKey(question);
        return searchCache.get(cacheKey, k -> searchFn.get());
    }
}
```

---

### ~~E5. åé¦ˆç³»ç»Ÿä¸æ£€ç´¢æœªæ·±åº¦é›†æˆ~~ âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `HybridSearchService.java`  
**ä¿®å¤å†…å®¹**:
- æ³¨å…¥ `DocumentWeightService`
- åœ¨æ··åˆè¯„åˆ†ååº”ç”¨æ–‡æ¡£åé¦ˆæƒé‡
- é«˜åˆ†æ–‡æ¡£è‡ªåŠ¨æå‡æ’åï¼Œä½åˆ†æ–‡æ¡£è‡ªåŠ¨é™ä½æ’å

**ä¿®å¤åçš„ä»£ç **:
```java
// åº”ç”¨æ–‡æ¡£åé¦ˆæƒé‡
if (documentWeightService != null) {
    double feedbackWeight = documentWeightService.getDocumentWeight(doc.getTitle());
    double adjustedScore = originalScore * feedbackWeight;
    hybridScores.put(entry.getKey(), adjustedScore);
}
```

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®æ±‡æ€»

### é…ç½®åŒ–æ”¹è¿›

éœ€è¦ç§»åˆ°é…ç½®æ–‡ä»¶çš„é¡¹ç›®ï¼š

| é…ç½®é¡¹ | å½“å‰ä½ç½® | å»ºè®®é…ç½®è·¯å¾„ |
|--------|---------|-------------|
| Luceneæƒé‡ | ä»£ç ç¡¬ç¼–ç  0.3 | `vector-search.lucene-weight` |
| å‘é‡æƒé‡ | ä»£ç ç¡¬ç¼–ç  0.7 | `vector-search.vector-weight` |
| åŒä¹‰è¯è¯å…¸ | ä»£ç é™æ€å— | `query-expansion.synonym-file` |
| åœç”¨è¯ | å¤šå¤„é‡å¤ | ç»Ÿä¸€ä½¿ç”¨ `search.chinese/english-stop-words` |
| ç›¸ä¼¼é—®é¢˜é˜ˆå€¼ | ä»£ç ç¡¬ç¼–ç  30, 4 | `similar-qa.min-score`, `similar-qa.min-rating` |
| å›¾ç‰‡æ•°é‡é™åˆ¶ | ä»£ç ç¡¬ç¼–ç  5 | `image-processing.max-images-per-doc` |
| å†å²è®°å½•é™åˆ¶ | ä»£ç ç¡¬ç¼–ç  100 | `similar-qa.history-limit` |

### æ¶æ„æ”¹è¿›

1. **ç»Ÿä¸€åœç”¨è¯æœåŠ¡** - é¿å…é‡å¤å®šä¹‰
2. **æ£€ç´¢ç­–ç•¥æ¡†æ¶** - å‚è€ƒå¤šæ–‡æ¡£åˆ†æç­–ç•¥è®¾è®¡
3. **è¯„åˆ†èåˆæ¥å£** - å¯æ‰©å±•çš„è¯„åˆ†è®¡ç®—
4. **æ£€ç´¢ç»“æœç¼“å­˜** - æå‡æ€§èƒ½
5. **æƒé‡å®é™…åº”ç”¨** - åé¦ˆæƒé‡å½±å“æ£€ç´¢æ’åº

---

## âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **å®Œå–„çš„å›½é™…åŒ–æ”¯æŒ** - å¤§éƒ¨åˆ†æ—¥å¿—å’Œæ¶ˆæ¯å·²å›½é™…åŒ–
2. **å¯æ’æ‹”çš„ AI å¼•æ“** - PPLã€LLMã€Vision éƒ½æ”¯æŒå¤šç§å®ç°
3. **é™çº§ç­–ç•¥** - PPL æœåŠ¡æ”¯æŒè‡ªåŠ¨é™çº§
4. **ä¼šè¯ç®¡ç†** - æ”¯æŒåˆ†æ‰¹å¼•ç”¨æ–‡æ¡£
5. **é…ç½®åŠ¨æ€ä¿®æ”¹** - `SearchConfigService` æ”¯æŒè¿è¡Œæ—¶è°ƒæ•´å‚æ•°
6. **è¯¦ç»†çš„æ—¥å¿—** - æ£€ç´¢è¿‡ç¨‹æœ‰å®Œæ•´çš„æ—¥å¿—è®°å½•
7. **ç­–ç•¥æ¡†æ¶** - å¤šæ–‡æ¡£åˆ†ææœ‰è‰¯å¥½çš„ç­–ç•¥æ¨¡å¼è®¾è®¡

---

## ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2å¤©ï¼‰âœ… å·²å®Œæˆ
1. âœ… æ··åˆæ£€ç´¢æƒé‡é…ç½®åŒ–
2. âœ… åŒä¹‰è¯è¯å…¸å¤–éƒ¨åŒ–
3. âœ… ç»Ÿä¸€åœç”¨è¯æœåŠ¡
4. âœ… ç›¸ä¼¼é—®é¢˜å‚æ•°é…ç½®åŒ–ï¼ˆSimilarQAConfigï¼‰

### ç¬¬äºŒé˜¶æ®µï¼ˆ3-5å¤©ï¼‰âœ… å·²å®Œæˆ
5. âœ… PPL Rerank åŸå§‹åˆ†æ•°ä¼ é€’
6. âœ… åé¦ˆæƒé‡åº”ç”¨åˆ°æ£€ç´¢
7. âœ… å›¾ç‰‡åˆ—è¡¨æ•°é‡é…ç½®åŒ–
8. âœ… ä¼šè¯è¶…æ—¶æ—¶é—´é…ç½®åŒ–
9. âœ… LLM æ”¹å†™ Prompt é…ç½®åŒ–

### ç¬¬ä¸‰é˜¶æ®µï¼ˆé•¿æœŸï¼‰
10. ğŸ“‹ æ£€ç´¢ç­–ç•¥æ¡†æ¶
11. ğŸ“‹ è¯„åˆ†èåˆæ¥å£
12. ğŸ“‹ æ£€ç´¢ç»“æœç¼“å­˜

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2025-12-07  
**æœ€åæ›´æ–°**: 2025-12-07 - å®Œæˆæ‰€æœ‰ç¡¬ç¼–ç é—®é¢˜ä¿®å¤  
**ä¸‹æ¬¡å®¡æŸ¥å»ºè®®**: è¿›è¡Œç¬¬ä¸‰é˜¶æ®µæ¶æ„ä¼˜åŒ–
