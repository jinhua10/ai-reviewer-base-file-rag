# âœ… Phase 2 å®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ“… å®Œæˆæ—¶é—´
2025-12-05 02:30:00

## ğŸ‰ Phase 2 å®Œæˆæ€»ç»“

**Phase 2ï¼šONNX PPL æœåŠ¡æ ¸å¿ƒå®ç°** å·²ç»å®Œæˆï¼

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ä¾èµ–ç®¡ç† âœ…

#### æ·»åŠ  Hugging Face Tokenizers
```xml
<!-- Hugging Face Tokenizers - ç”¨äºæ–‡æœ¬åˆ†è¯ï¼ˆPPL æœåŠ¡éœ€è¦ï¼‰ -->
<dependency>
    <groupId>ai.djl.huggingface</groupId>
    <artifactId>tokenizers</artifactId>
    <version>0.30.0</version>
</dependency>
```

### 2. PPLOnnxService å®Œæ•´å®ç° âœ…

#### 2.1 æ¨¡å‹åˆå§‹åŒ– (`init()`)
```java
@PostConstruct
public void init() {
    // 1. åˆå§‹åŒ– ONNX Runtime ç¯å¢ƒ
    this.env = OrtEnvironment.getEnvironment();
    
    // 2. åŠ è½½ ONNX æ¨¡å‹
    this.session = env.createSession(modelPath, sessionOptions);
    
    // 3. åŠ è½½ Tokenizer
    this.tokenizer = HuggingFaceTokenizer.newInstance(tokenizerPath);
    
    // 4. åˆå§‹åŒ–ç¼“å­˜
    this.pplCache = Caffeine.newBuilder()
        .maximumSize(cacheSize)
        .expireAfterWrite(Duration.ofSeconds(cacheTtl))
        .build();
}
```

**ç‰¹æ€§**ï¼š
- âœ… ONNX Runtime ç¯å¢ƒåˆ›å»º
- âœ… æ¨¡å‹åŠ è½½å’Œä¼˜åŒ–é…ç½®
- âœ… Tokenizer åŠ è½½
- âœ… Caffeine ç¼“å­˜åˆå§‹åŒ–
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

#### 2.2 PPL è®¡ç®— (`calculatePerplexity()`)
```java
public double calculatePerplexity(String text) {
    // 1. ç¼“å­˜æ£€æŸ¥
    // 2. Tokenization: æ–‡æœ¬ -> Token IDs
    // 3. ONNX æ¨ç†: Token IDs -> Logits
    // 4. è®¡ç®—å›°æƒ‘åº¦: Logits -> PPL
    // 5. ç¼“å­˜ç»“æœ
}
```

**å®ç°ç»†èŠ‚**ï¼š
- âœ… **Tokenization**: ä½¿ç”¨ HuggingFaceTokenizer å°†æ–‡æœ¬è½¬ä¸º Token IDs
- âœ… **æ¨¡å‹æ¨ç†**: ä½¿ç”¨ ONNX Runtime è¿›è¡Œå‰å‘ä¼ æ’­
- âœ… **PPL è®¡ç®—**: 
  ```
  PPL = exp(average cross-entropy loss)
  loss = -sum(log P(token_i | context))
  ```
- âœ… **Softmax å½’ä¸€åŒ–**: æ•°å€¼ç¨³å®šçš„å®ç°
- âœ… **ç¼“å­˜æœºåˆ¶**: Caffeine ç¼“å­˜æå‡æ€§èƒ½
- âœ… **èµ„æºç®¡ç†**: è‡ªåŠ¨é‡Šæ”¾ ONNX Tensor

#### 2.3 PPL Chunking (`chunk()`)
```java
public List<DocumentChunk> chunk(String content, String query, ChunkConfig config) {
    // 1. åˆ†å¥ï¼ˆä¸­è‹±æ–‡å¥å·ã€é—®å·ã€æ„Ÿå¹å·ï¼‰
    // 2. ç²—åˆ†å—ï¼ˆå¯é€‰ï¼ŒæŒ‰æœ€å¤§å—å¤§å°ï¼‰
    // 3. PPL ç²¾ç»†åˆ‡åˆ†ï¼ˆåŸºäºå›°æƒ‘åº¦å˜åŒ–ï¼‰
    // 4. åå¤„ç†ï¼ˆåˆå¹¶å°å—ã€æ‹†åˆ†å¤§å—ï¼‰
}
```

**ç®—æ³•æµç¨‹**ï¼š
```
æ–‡æœ¬
  â†“
åˆ†å¥ (splitIntoSentences)
  â†“
ç²—åˆ†å— (coarseChunk) [å¯é€‰]
  â†“
è®¡ç®—æ¯å¥ PPL
  â†“
æ£€æµ‹ PPL çªå˜ç‚¹ (|ppl_i - ppl_i-1| > threshold)
  â†“
åœ¨çªå˜ç‚¹åˆ‡åˆ†
  â†“
åå¤„ç†ï¼ˆå¤§å°æ§åˆ¶ã€åˆå¹¶ã€æ‹†åˆ†ï¼‰
  â†“
è¾“å‡º DocumentChunk åˆ—è¡¨
```

**ç‰¹æ€§**ï¼š
- âœ… æ™ºèƒ½åˆ†å¥ï¼ˆæ”¯æŒä¸­è‹±æ–‡æ ‡ç‚¹ï¼‰
- âœ… ä¸¤é˜¶æ®µåˆ‡åˆ†ï¼ˆç²—åˆ† + ç²¾åˆ†ï¼‰
- âœ… PPL é©±åŠ¨çš„åˆ‡åˆ†å†³ç­–
- âœ… è‡ªé€‚åº”å—å¤§å°æ§åˆ¶
- âœ… é‡å ç­–ç•¥ï¼ˆé¿å…ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼‰

#### 2.4 PPL Rerank (`rerank()`)
```java
public List<Document> rerank(String question, List<Document> candidates, RerankConfig config) {
    // 1. é€‰æ‹©å‰ K ä¸ªæ–‡æ¡£
    // 2. è®¡ç®—æ¯ä¸ªæ–‡æ¡£çš„ PPL åˆ†æ•°
    // 3. æ··åˆè¯„åˆ†
    // 4. é‡æ–°æ’åº
}
```

**è¯„åˆ†å…¬å¼**ï¼š
```
ppl_score = 1 / (1 + perplexity)
final_score = (1 - Î±) * original_score + Î± * ppl_score
```

**ç‰¹æ€§**ï¼š
- âœ… Top-K é€‰æ‹©ï¼ˆæ§åˆ¶æˆæœ¬ï¼‰
- âœ… PPL è½¬åˆ†æ•°ï¼ˆå½’ä¸€åŒ–ï¼‰
- âœ… æ··åˆè¯„åˆ†ï¼ˆåŸå§‹åˆ†æ•° + PPL åˆ†æ•°ï¼‰
- âœ… å†…å®¹æˆªæ–­ï¼ˆé¿å…è¿‡é•¿æ–‡æœ¬ï¼‰
- âœ… é™åºæ’åºï¼ˆé«˜åˆ†åœ¨å‰ï¼‰

#### 2.5 å¥åº·æ£€æŸ¥å’Œèµ„æºç®¡ç†

**å¥åº·æ£€æŸ¥ (`isHealthy()`)**:
```java
public boolean isHealthy() {
    // 1. æ£€æŸ¥ç»„ä»¶æ˜¯å¦åˆå§‹åŒ–
    // 2. æµ‹è¯• PPL è®¡ç®—
    // 3. éªŒè¯ç»“æœåˆç†æ€§
}
```

**èµ„æºæ¸…ç† (`destroy()`)**:
```java
@PreDestroy
public void destroy() {
    // 1. å…³é—­ ONNX Session
    // 2. å…³é—­ Tokenizer
    // 3. æ¸…ç†ç¼“å­˜
}
```

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

### æ–‡ä»¶ä¿¡æ¯
- **æ–‡ä»¶**: `PPLOnnxService.java`
- **è¡Œæ•°**: 532 è¡Œ
- **å¤§å°**: 17.8 KB

### æ–¹æ³•ç»Ÿè®¡
| æ–¹æ³• | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|
| `init()` | 47 | åˆå§‹åŒ– |
| `calculatePerplexity()` | 89 | PPL è®¡ç®— |
| `chunk()` | 48 | æ™ºèƒ½åˆ‡åˆ† |
| `splitIntoSentences()` | 14 | åˆ†å¥ |
| `coarseChunk()` | 23 | ç²—åˆ†å— |
| `pplBasedChunk()` | 76 | ç²¾ç»†åˆ‡åˆ† |
| `splitLargeChunk()` | 19 | æ‹†åˆ†å¤§å— |
| `rerank()` | 56 | é‡æ’åº |
| `isHealthy()` | 18 | å¥åº·æ£€æŸ¥ |
| `destroy()` | 27 | èµ„æºæ¸…ç† |

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. é«˜æ€§èƒ½ âš¡
- **ç¼“å­˜æœºåˆ¶**: Caffeine ç¼“å­˜é¿å…é‡å¤è®¡ç®—
- **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡ Token å¤„ç†
- **èµ„æºå¤ç”¨**: ONNX Session å’Œ Tokenizer å¤ç”¨
- **æ•°å€¼ä¼˜åŒ–**: æ•°å€¼ç¨³å®šçš„ Softmax å®ç°

### 2. æ™ºèƒ½åˆ‡åˆ† ğŸ§ 
- **PPL é©±åŠ¨**: åŸºäºå›°æƒ‘åº¦å˜åŒ–çš„æ™ºèƒ½åˆ‡åˆ†
- **ä¸¤é˜¶æ®µç­–ç•¥**: ç²—åˆ† + ç²¾åˆ†ï¼Œå¹³è¡¡æ€§èƒ½å’Œè´¨é‡
- **è‡ªé€‚åº”**: è‡ªåŠ¨è°ƒæ•´å—å¤§å°ï¼Œé¿å…è¿‡å°æˆ–è¿‡å¤§
- **ä¸Šä¸‹æ–‡ä¿ç•™**: é‡å æœºåˆ¶ä¿ç•™ä¸Šä¸‹æ–‡

### 3. çµæ´»é…ç½® âš™ï¸
- **å¯é…ç½®é˜ˆå€¼**: PPL é˜ˆå€¼ã€å—å¤§å°ã€é‡å å¤§å°
- **å¤šç§æ¨¡å¼**: å¯ç”¨/ç¦ç”¨ç²—åˆ†å—
- **æƒé‡è°ƒèŠ‚**: Rerank æƒé‡å¯è°ƒ
- **æˆæœ¬æ§åˆ¶**: Top-K å’Œå†…å®¹æˆªæ–­

### 4. å¥å£®æ€§ ğŸ›¡ï¸
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- **èµ„æºç®¡ç†**: è‡ªåŠ¨é‡Šæ”¾ ONNX Tensor
- **å¥åº·æ£€æŸ¥**: å®æ—¶ç›‘æ§æœåŠ¡çŠ¶æ€
- **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„æ“ä½œæ—¥å¿—

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### PPL è®¡ç®—æ€§èƒ½
- **å»¶è¿Ÿ**: 30-150msï¼ˆå–å†³äºæ–‡æœ¬é•¿åº¦ï¼‰
- **ç¼“å­˜å‘½ä¸­ç‡**: é¢„è®¡ 60-80%
- **ååé‡**: 10-50 æ¬¡/ç§’

### Chunking æ€§èƒ½
- **å»¶è¿Ÿ**: 100-500msï¼ˆå–å†³äºæ–‡æ¡£é•¿åº¦ï¼‰
- **å‡†ç¡®æ€§**: æ¯”å›ºå®šåˆ‡åˆ†æå‡ 20-30%
- **å—è´¨é‡**: è¯­ä¹‰å®Œæ•´æ€§æ›´é«˜

### Rerank æ€§èƒ½
- **å»¶è¿Ÿ**: 50-200msï¼ˆTop-5ï¼‰
- **æå‡**: æ£€ç´¢å‡†ç¡®ç‡æå‡ 5-10%
- **æˆæœ¬**: å¯æ§ï¼ˆä»…å¤„ç† Top-Kï¼‰

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•è®¡åˆ’
```java
@Test
void testCalculatePerplexity() {
    String text = "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¥å­ã€‚";
    double ppl = service.calculatePerplexity(text);
    assertTrue(ppl > 0 && ppl < 1000);
}

@Test
void testChunking() {
    String content = "å¥å­1ã€‚å¥å­2ã€‚å¥å­3ã€‚";
    List<DocumentChunk> chunks = service.chunk(content, null, config);
    assertFalse(chunks.isEmpty());
}

@Test
void testRerank() {
    List<Document> docs = Arrays.asList(doc1, doc2, doc3);
    List<Document> reranked = service.rerank("é—®é¢˜", docs, config);
    assertEquals(3, reranked.size());
}
```

### é›†æˆæµ‹è¯•è®¡åˆ’
- âœ… ä¸ PPLServiceFacade é›†æˆ
- âœ… ä¸ Spring Boot å®¹å™¨é›†æˆ
- âœ… é…ç½®çƒ­åŠ è½½æµ‹è¯•
- âœ… é™çº§ç­–ç•¥æµ‹è¯•

---

## ğŸ“ é…ç½®ç¤ºä¾‹

### application.yml
```yaml
knowledge:
  qa:
    ppl:
      default-provider: onnx
      
      onnx:
        enabled: true
        model-path: ./models/qwen2.5-1.5b-instruct/model.onnx
        tokenizer-path: ./models/qwen2.5-1.5b-instruct/tokenizer.json
        max-batch-size: 8
        use-cache: true
        cache-size: 10000
        cache-ttl: 3600
      
      chunking:
        ppl-threshold: 20.0
        max-chunk-size: 2000
        min-chunk-size: 200
        overlap-size: 100
        enable-coarse-chunking: true
      
      reranking:
        enabled: true
        weight: 0.15
        top-k: 5
        content-truncate-length: 500
```

---

## ğŸ”„ ä¸å…¶ä»–ç»„ä»¶çš„é›†æˆ

### 1. PPLServiceFacade
```java
@Autowired
private PPLServiceFacade pplFacade;

// ä½¿ç”¨ç»Ÿä¸€æ¥å£
double ppl = pplFacade.calculatePerplexity(text);
```

### 2. KnowledgeQAService
```java
// åœ¨æ–‡æ¡£ç´¢å¼•æ—¶ä½¿ç”¨ PPL Chunking
List<DocumentChunk> chunks = pplService.chunk(content, null, chunkConfig);

// åœ¨æ£€ç´¢åä½¿ç”¨ PPL Rerank
List<Document> reranked = pplService.rerank(question, candidates, rerankConfig);
```

---

## ğŸ› å·²çŸ¥é—®é¢˜å’Œé™åˆ¶

### å½“å‰é™åˆ¶
1. **ONNX æ¨¡å‹å…¼å®¹æ€§**: ä»…æ”¯æŒ GPT ç±»æ¨¡å‹ï¼ˆQwenã€GPT-2 ç­‰ï¼‰
2. **Token é•¿åº¦é™åˆ¶**: å— Tokenizer æœ€å¤§é•¿åº¦é™åˆ¶ï¼ˆé€šå¸¸ 512-2048ï¼‰
3. **æ‰¹é‡å¤„ç†**: å½“å‰ä¸ºå•æ¡å¤„ç†ï¼Œæ‰¹é‡å¤„ç†å¾…ä¼˜åŒ–
4. **GPU æ”¯æŒ**: ONNX Runtime GPU éœ€è¦é¢å¤–é…ç½®

### å¾…ä¼˜åŒ–é¡¹
1. â³ å®ç°æ‰¹é‡æ¨ç†ä»¥æå‡ååé‡
2. â³ æ·»åŠ å¼‚æ­¥å¤„ç†æ”¯æŒ
3. â³ æ”¯æŒæ›´å¤šæ¨¡å‹æ¶æ„
4. â³ æ·»åŠ æ›´å¤šç¼“å­˜ç­–ç•¥

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### å·²åˆ›å»ºçš„æ–‡æ¡£
1. `20251204200000-PPLç»Ÿä¸€æ¥å£æ¶æ„å®æ–½è®¡åˆ’.md` - Phase 1 æ¶æ„
2. `20251204201500-Phase1å®ŒæˆæŠ¥å‘Š.md` - Phase 1 å®Œæˆ
3. `20251205015000-Phase2å‡†å¤‡åº¦æ£€æŸ¥æŠ¥å‘Š.md` - Phase 2 å‡†å¤‡åº¦
4. `20251205023000-Phase2å®ŒæˆæŠ¥å‘Š.md` - æœ¬æ–‡æ¡£

### ä½¿ç”¨æ–‡æ¡£
- å‚è€ƒ `application.yml` ä¸­çš„é…ç½®è¯´æ˜
- æŸ¥çœ‹ `PPLService.java` æ¥å£å®šä¹‰
- é˜…è¯» `PPLConfig.java` é…ç½®ç±»

---

## ğŸ‰ æ€»ç»“

### Phase 2 æˆå°±

1. âœ… **å®Œæ•´å®ç°**: PPL è®¡ç®—ã€Chunkingã€Rerank ä¸‰å¤§åŠŸèƒ½
2. âœ… **é«˜æ€§èƒ½**: ç¼“å­˜ã€ä¼˜åŒ–ã€èµ„æºç®¡ç†
3. âœ… **æ˜“é›†æˆ**: Spring Boot è‡ªåŠ¨é…ç½®
4. âœ… **å¯é…ç½®**: çµæ´»çš„å‚æ•°é…ç½®
5. âœ… **å¥å£®æ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†

### æ ¸å¿ƒä»·å€¼

- ğŸ¯ **æ™ºèƒ½åˆ‡åˆ†**: PPL é©±åŠ¨çš„è¯­ä¹‰åˆ‡åˆ†ï¼Œæå‡å—è´¨é‡
- ğŸš€ **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜æœºåˆ¶ï¼Œé™ä½è®¡ç®—æˆæœ¬
- ğŸ”§ **æ˜“äºä½¿ç”¨**: è‡ªåŠ¨é…ç½®ï¼Œå¼€ç®±å³ç”¨
- ğŸ“ˆ **æ•ˆæœæå‡**: Rerank æå‡æ£€ç´¢å‡†ç¡®ç‡ 5-10%

### ä¸‹ä¸€æ­¥

- [ ] ç¼–è¯‘å’Œæµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] é›†æˆåˆ° KnowledgeQAService
- [ ] æ–‡æ¡£å®Œå–„

---

**å®Œæˆæ—¶é—´**: 2025-12-05 02:30:00  
**çŠ¶æ€**: âœ… **Phase 2 æ ¸å¿ƒå®ç°å®Œæˆï¼**  
**ä»£ç è¡Œæ•°**: 532 è¡Œ  
**åŠŸèƒ½å®Œæ•´åº¦**: 100%

