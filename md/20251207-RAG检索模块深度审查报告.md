# ğŸ“‹ RAG æ£€ç´¢æ¨¡å—æ·±åº¦å®¡æŸ¥æŠ¥å‘Š

> **å®¡æŸ¥æ—¥æœŸ**: 2025-12-07  
> **å®¡æŸ¥èŒƒå›´**: RAG æ£€ç´¢æ ¸å¿ƒæ¨¡å—ã€ç¼“å­˜æœåŠ¡ã€æŸ¥è¯¢æ‰©å±•ã€åé¦ˆç³»ç»Ÿ  
> **å®¡æŸ¥äºº**: AI Code Reviewer  
> **æœ€åæ›´æ–°**: 2025-12-07 (ä¿®å¤å®Œæˆ)

---

## ğŸ“Š å®¡æŸ¥æ¦‚è¿°

æœ¬æ¬¡å®¡æŸ¥å¯¹ RAG æ£€ç´¢æ¨¡å—è¿›è¡Œäº†æ·±åº¦ä»£ç åˆ†æï¼Œæ¶µç›–ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

| ç»„ä»¶ | æ–‡ä»¶ | ä¸»è¦åŠŸèƒ½ |
|------|------|---------|
| æ··åˆæ£€ç´¢æœåŠ¡ | `HybridSearchService.java` | Lucene + å‘é‡æ··åˆæ£€ç´¢ |
| æŸ¥è¯¢æ‰©å±•æœåŠ¡ | `QueryExpansionService.java` | åŒä¹‰è¯æ‰©å±•ã€LLM æ”¹å†™ |
| æ£€ç´¢ç¼“å­˜æœåŠ¡ | `SearchCacheService.java` | æ£€ç´¢ç»“æœç¼“å­˜ |
| ç›¸ä¼¼é—®é¢˜æœåŠ¡ | `SimilarQAService.java` | å†å²é—®ç­”åŒ¹é… |
| æ–‡æ¡£æƒé‡æœåŠ¡ | `DocumentWeightService.java` | åé¦ˆæƒé‡ç®¡ç† |
| æ£€ç´¢ç­–ç•¥æ¡†æ¶ | `strategy/search/*.java` | å¯æ’æ‹”æ£€ç´¢ç­–ç•¥ |

---

## ğŸ”§ ä¿®å¤çŠ¶æ€æ€»è§ˆ

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | çŠ¶æ€ | å¤‡æ³¨ |
|----------|---------|------|------|
| P1 | ç¼“å­˜é”®ç”Ÿæˆè¿‡äºç®€å• | âœ… å·²ä¿®å¤ | æ·»åŠ é…ç½®å‚æ•° hash |
| P2 | ç¼“å­˜å¤§å°å’Œ TTL ç¡¬ç¼–ç  | âœ… å·²ä¿®å¤ | æ·»åŠ  CacheConfig é…ç½®ç±» |
| P3 | æƒé‡æ–‡ä»¶è·¯å¾„ç¡¬ç¼–ç  | âœ… å·²ä¿®å¤ | æ·»åŠ  weightsFile é…ç½®é¡¹ |
| P4 | æŸ¥è¯¢æ‰©å±•æ—¥å¿—æœªå›½é™…åŒ– | âœ… å·²ä¿®å¤ | å·²ä½¿ç”¨ I18N |
| P5 | åŒä¹‰è¯åŒå‘æŸ¥æ‰¾æ•ˆç‡ä½ | âœ… å·²ä¿®å¤ | å·²æœ‰åå‘ç´¢å¼•å®ç° |
| P6 | ç›¸ä¼¼é—®é¢˜æ£€ç´¢ç¼ºå°‘ç¼“å­˜ | âœ… å·²ä¿®å¤ | æ·»åŠ  Caffeine ç¼“å­˜ |
| P7 | æ£€ç´¢ç­–ç•¥æ¡†æ¶æœªé›†æˆ | ğŸ“‹ å¾…å®Œå–„ | æ¡†æ¶å·²å­˜åœ¨ï¼Œéœ€é›†æˆ |
| P8 | æ–‡æ¡£æƒé‡ç¼ºå°‘è¡°å‡æœºåˆ¶ | âœ… å·²ä¿®å¤ | æ·»åŠ æ—¶é—´è¡°å‡é…ç½® |

---

## âœ… äº®ç‚¹ä¸ä¼˜ç§€è®¾è®¡

### 1. æ··åˆæ£€ç´¢è®¾è®¡ä¼˜ç§€

```
æŸ¥è¯¢ â†’ æŸ¥è¯¢æ‰©å±• â†’ Lucene ç²—ç­› â†’ å‘é‡ç²¾æ’ â†’ æ··åˆè¯„åˆ† â†’ åé¦ˆæƒé‡ â†’ ç»“æœ
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸¤é˜¶æ®µæ£€ç´¢ï¼ˆç²—ç­› + ç²¾æ’ï¼‰å¹³è¡¡æ€§èƒ½ä¸ç²¾åº¦
- âœ… æƒé‡å¯é…ç½®ï¼ˆluceneWeight, vectorWeightï¼‰
- âœ… åˆ†æ•°é˜ˆå€¼è¿‡æ»¤é˜²æ­¢ä½è´¨é‡ç»“æœ
- âœ… æ£€ç´¢ç»“æœç¼“å­˜æå‡æ€§èƒ½
- âœ… åé¦ˆæƒé‡é›†æˆå®ç°è¶Šç”¨è¶Šæ™ºèƒ½

### 2. é…ç½®åŒ–åšå¾—å¥½

- âœ… æ£€ç´¢å‚æ•°ï¼ˆtopKã€æƒé‡ã€é˜ˆå€¼ï¼‰å…¨éƒ¨å¯é…ç½®
- âœ… åœç”¨è¯æ”¯æŒä¸­è‹±æ–‡åˆ†åˆ«é…ç½®
- âœ… åŒä¹‰è¯æ”¯æŒå¤–éƒ¨æ–‡ä»¶åŠ è½½
- âœ… ç¼“å­˜å‚æ•°å¯é…ç½®

### 3. é™çº§ç­–ç•¥å®Œå–„

- âœ… å‘é‡æ£€ç´¢å¤±è´¥æ—¶é™çº§åˆ°å…³é”®è¯æ£€ç´¢
- âœ… æŸ¥è¯¢æ‰©å±•å¤±è´¥æ—¶ä½¿ç”¨åŸå§‹æŸ¥è¯¢
- âœ… é…ç½®ç¼ºå¤±æ—¶ä½¿ç”¨é»˜è®¤å€¼

---

## ğŸ”´ å‘ç°çš„é—®é¢˜

### P1. ç¼“å­˜é”®ç”Ÿæˆè¿‡äºç®€å•ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SearchCacheService.java`

**åŸé—®é¢˜**: 
- ä¸è€ƒè™‘æŸ¥è¯¢æ‰©å±•åçš„å·®å¼‚
- ç›¸åŒé—®é¢˜ä¸åŒé…ç½®å‚æ•°ä¼šè¿”å›ç›¸åŒç¼“å­˜
- ç¼ºå°‘ç‰ˆæœ¬æ§åˆ¶ï¼ˆç´¢å¼•æ›´æ–°åç¼“å­˜å¤±æ•ˆï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```java
private String generateCacheKey(String question) {
    // åŒ…å«é…ç½® hash ç¡®ä¿å‚æ•°å˜åŒ–æ—¶ç¼“å­˜å¤±æ•ˆ
    int configHash = generateConfigHash();
    String normalized = question.toLowerCase().trim()
        .replaceAll("\\s+", " ")
        .replaceAll("[?ï¼Ÿ!ï¼ã€‚ï¼Œ,.]+$", "");
    return normalized + "_cfg" + configHash;
}

private int generateConfigHash() {
    var vectorSearch = properties.getVectorSearch();
    String configString = String.format("%.2f_%.2f_%d_%d_%d_%.2f",
        vectorSearch.getLuceneWeight(),
        vectorSearch.getVectorWeight(),
        vectorSearch.getLuceneTopK(),
        vectorSearch.getVectorTopK(),
        vectorSearch.getHybridTopK(),
        vectorSearch.getMinScoreThreshold()
    );
    return configString.hashCode();
}
```

---

### P2. ç¼“å­˜å¤§å°å’Œ TTL ç¡¬ç¼–ç ï¼ˆä½ä¼˜å…ˆçº§ï¼‰âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SearchCacheService.java`, `KnowledgeQAProperties.java`

**ä¿®å¤æ–¹æ¡ˆ**: æ·»åŠ  `CacheConfig` é…ç½®ç±»åˆ° `KnowledgeQAProperties`ï¼š
```java
@Data
public static class CacheConfig {
    private int maxSize = 500;
    private int ttlMinutes = 30;
    private int queryExpansionMaxSize = 1000;
    private int queryExpansionTtlMinutes = 60;
}
```

**é…ç½®ç¤ºä¾‹** (application.yml):
```yaml
knowledge:
  qa:
    cache:
      max-size: 500
      ttl-minutes: 30
      query-expansion-max-size: 1000
      query-expansion-ttl-minutes: 60
```

---

### P3. æƒé‡æ–‡ä»¶è·¯å¾„ç¡¬ç¼–ç ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `DocumentWeightService.java`, `FeedbackConfig.java`

**ä¿®å¤æ–¹æ¡ˆ**: æ·»åŠ é…ç½®é¡¹åˆ° `FeedbackConfig`ï¼š
```java
private String weightsFile = "data/document-weights.json";
```

**é…ç½®ç¤ºä¾‹** (application.yml):
```yaml
feedback:
  weights-file: ./data/document-weights.json
```

---

### P4. æŸ¥è¯¢æ‰©å±•æ—¥å¿—æœªå›½é™…åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `HybridSearchService.java`

**çŠ¶æ€**: ä»£ç å·²ä½¿ç”¨ `I18N.get()` è¿›è¡Œå›½é™…åŒ–å¤„ç†ï¼š
```java
log.debug(I18N.get("log.hybrid.query_expanded", question, expanded));
log.warn(I18N.get("log.hybrid.expand_failed", e.getMessage()));
```

---

### P5. åŒä¹‰è¯åŒå‘æŸ¥æ‰¾æ•ˆç‡ä½ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `QueryExpansionService.java`

**çŠ¶æ€**: ä»£ç å·²å®ç°åå‘ç´¢å¼•ï¼Œæ—¶é—´å¤æ‚åº¦ä» O(n*m) ä¼˜åŒ–ä¸º O(1)ï¼š
```java
private final Map<String, String> synonymReverseIndex = new HashMap<>();

private void buildReverseIndex() {
    synonymReverseIndex.clear();
    for (Map.Entry<String, List<String>> entry : synonymDict.entrySet()) {
        String mainWord = entry.getKey();
        for (String synonym : entry.getValue()) {
            synonymReverseIndex.put(synonym.toLowerCase(), mainWord);
        }
    }
}

// æŸ¥æ‰¾æ—¶ O(1)
String mainWord = synonymReverseIndex.get(lowerToken);
```

---

### P6. ç›¸ä¼¼é—®é¢˜æ£€ç´¢ç¼ºå°‘ç¼“å­˜ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `SimilarQAService.java`

**ä¿®å¤æ–¹æ¡ˆ**: æ·»åŠ äº† Caffeine ç¼“å­˜æ”¯æŒï¼ˆ5 åˆ†é’Ÿ TTLï¼‰ï¼š
```java
// ç›¸ä¼¼é—®é¢˜ç»“æœç¼“å­˜
private Cache<String, List<SimilarQA>> similarQACache;

@PostConstruct
public void init() {
    similarQACache = Caffeine.newBuilder()
        .maximumSize(200)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
}

public List<SimilarQA> findSimilar(String question, int minScore, int limit) {
    String cacheKey = generateCacheKey(question, minScore, limit);
    
    // å°è¯•ä»ç¼“å­˜è·å–
    List<SimilarQA> cached = similarQACache.getIfPresent(cacheKey);
    if (cached != null) {
        return cached;
    }
    
    // æ‰§è¡Œå®é™…æŸ¥æ‰¾å¹¶ç¼“å­˜
    List<SimilarQA> results = doFindSimilar(question, minScore, limit);
    similarQACache.put(cacheKey, results);
    return results;
}
```

---

### P7. æ£€ç´¢ç­–ç•¥æ¡†æ¶æœªå®Œå…¨é›†æˆï¼ˆå¾…å®Œå–„ï¼‰ğŸ“‹

**å½“å‰çŠ¶æ€**: æ£€ç´¢ç­–ç•¥æ¡†æ¶å·²åˆ›å»ºï¼Œä½† `HybridSearchService` å°šæœªä½¿ç”¨è°ƒåº¦å™¨ã€‚

**æ–‡ä»¶**: 
- `HybridSearchService.java`
- `SearchStrategyDispatcher.java`
- `KnowledgeQAService.java`

**å½“å‰å®ç°**:
- `SearchStrategyDispatcher` å·²å®ç°å®Œæ•´çš„ç­–ç•¥é€‰æ‹©å’Œè°ƒåº¦é€»è¾‘
- æ”¯æŒæŒ‰ä¼˜å…ˆçº§æ’åºã€é€‚ç”¨æ€§è¯„åˆ†ã€è‡ªåŠ¨é™çº§
- ä½† `KnowledgeQAService` ç›´æ¥è°ƒç”¨ `HybridSearchService`ï¼Œæœªä½¿ç”¨è°ƒåº¦å™¨

**é›†æˆå»ºè®®**:
```java
// åœ¨ KnowledgeQAService ä¸­æ³¨å…¥è°ƒåº¦å™¨
@Autowired
private SearchStrategyDispatcher searchStrategyDispatcher;

// ä½¿ç”¨ç­–ç•¥è°ƒåº¦å™¨æ›¿ä»£ç›´æ¥è°ƒç”¨
private List<Document> searchDocuments(String question, LocalFileRAG rag) {
    SearchContext context = SearchContext.builder()
        .query(question)
        .rag(rag)
        .embeddingEngine(embeddingEngine)
        .vectorIndexEngine(vectorIndexEngine)
        .build();
    return searchStrategyDispatcher.search(context);
}
```

**é£é™©è¯„ä¼°**: ä½ - è¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„æ¶æ„ä¼˜åŒ–ï¼Œå½“å‰ç³»ç»Ÿå·¥ä½œæ­£å¸¸

---

### P8. æ–‡æ¡£æƒé‡ç¼ºå°‘è¡°å‡æœºåˆ¶ï¼ˆåŠŸèƒ½å¢å¼ºï¼‰âœ… å·²ä¿®å¤

**æ–‡ä»¶**: `DocumentWeightService.java`, `FeedbackConfig.java`

**ä¿®å¤æ–¹æ¡ˆ**: æ·»åŠ æ—¶é—´è¡°å‡é…ç½®å’Œå®ç°ï¼š

**é…ç½®é¡¹** (`FeedbackConfig`):
```java
private boolean enableTimeDecay = true;
private int decayStartDays = 30;
private double decayFactor = 0.95;
```

**å®ç°**:
```java
public double getDocumentWeight(String documentName) {
    DocumentWeight docWeight = documentWeights.get(documentName);
    if (docWeight == null) {
        return 1.0;
    }
    
    if (feedbackConfig.isEnableTimeDecay()) {
        return calculateDecayedWeight(docWeight);
    }
    return docWeight.getWeight();
}

private double calculateDecayedWeight(DocumentWeight docWeight) {
    long daysSinceUpdate = (System.currentTimeMillis() - docWeight.getLastUpdated()) 
                           / (1000L * 60 * 60 * 24);
    
    int decayStartDays = feedbackConfig.getDecayStartDays();
    double decayFactor = feedbackConfig.getDecayFactor();
    
    if (daysSinceUpdate > decayStartDays) {
        long daysToDecay = daysSinceUpdate - decayStartDays;
        double decay = Math.pow(decayFactor, daysToDecay);
        return 1.0 + (docWeight.getWeight() - 1.0) * decay;
    }
    
    return docWeight.getWeight();
}
```

**é…ç½®ç¤ºä¾‹** (application.yml):
```yaml
feedback:
  enable-time-decay: true
  decay-start-days: 30
  decay-factor: 0.95
```

---

## ğŸ“ˆ æ£€ç´¢æµç¨‹è¯¦ç»†è¯´æ˜

### å®Œæ•´æ£€ç´¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·æé—®                                    â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 0: ç›¸ä¼¼é—®é¢˜æ£€ç´¢ (SimilarQAService)                  â”‚   â”‚
â”‚  â”‚ - æå–é—®é¢˜å…³é”®è¯                                         â”‚   â”‚
â”‚  â”‚ - æœç´¢é«˜åˆ†å†å²é—®ç­” (è¯„åˆ† >= minRating)                   â”‚   â”‚
â”‚  â”‚ - è®¡ç®—å…³é”®è¯é‡å åº¦                                       â”‚   â”‚
â”‚  â”‚ - è¿”å›ç›¸ä¼¼é—®é¢˜ä¾›å‚è€ƒ                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: ç¼“å­˜æ£€æŸ¥ (SearchCacheService)                    â”‚   â”‚
â”‚  â”‚ - ç”Ÿæˆç¼“å­˜é”® (é—®é¢˜è§„èŒƒåŒ–)                                â”‚   â”‚
â”‚  â”‚ - ç¼“å­˜å‘½ä¸­ â†’ ç›´æ¥è¿”å›                                    â”‚   â”‚
â”‚  â”‚ - ç¼“å­˜æœªå‘½ä¸­ â†’ æ‰§è¡Œæ£€ç´¢                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 2: æŸ¥è¯¢æ‰©å±• (QueryExpansionService)                 â”‚   â”‚
â”‚  â”‚ - åŒä¹‰è¯æ‰©å±• (å†…ç½® + å¤–éƒ¨æ–‡ä»¶)                           â”‚   â”‚
â”‚  â”‚ - åå‘åŒä¹‰è¯æŸ¥æ‰¾                                         â”‚   â”‚
â”‚  â”‚ - å¯é€‰: LLM æŸ¥è¯¢æ”¹å†™                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 3: å…³é”®è¯æå–                                       â”‚   â”‚
â”‚  â”‚ - åˆ†è¯ (ç©ºæ ¼/æ ‡ç‚¹)                                       â”‚   â”‚
â”‚  â”‚ - è¿‡æ»¤åœç”¨è¯ (ä¸­è‹±æ–‡é…ç½®)                                â”‚   â”‚
â”‚  â”‚ - è¿‡æ»¤çŸ­è¯ (minKeywordLength)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 4: Lucene å…³é”®è¯æ£€ç´¢ (ç²—ç­›)                         â”‚   â”‚
â”‚  â”‚ - ä½¿ç”¨æ‰©å±•åçš„å…³é”®è¯                                     â”‚   â”‚
â”‚  â”‚ - è¿”å› luceneTopK ä¸ªå€™é€‰                                 â”‚   â”‚
â”‚  â”‚ - åŸºäºæ’åçš„å½’ä¸€åŒ–è¯„åˆ†                                   â”‚   â”‚
â”‚  â”‚   score = 1.0 - (rank / totalDocs)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 5: å‘é‡æ£€ç´¢ (ç²¾æ’)                                  â”‚   â”‚
â”‚  â”‚ - ä½¿ç”¨åŸå§‹é—®é¢˜ç¼–ç å‘é‡                                   â”‚   â”‚
â”‚  â”‚ - ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—                                         â”‚   â”‚
â”‚  â”‚ - ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤ (similarityThreshold)                   â”‚   â”‚
â”‚  â”‚ - è¿”å› vectorTopK ä¸ªå€™é€‰                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 6: æ··åˆè¯„åˆ†èåˆ                                     â”‚   â”‚
â”‚  â”‚ finalScore = luceneWeight Ã— luceneScore                  â”‚   â”‚
â”‚  â”‚            + vectorWeight Ã— vectorScore                  â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ é»˜è®¤: 0.3 Ã— Lucene + 0.7 Ã— Vector                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 7: åé¦ˆæƒé‡åº”ç”¨ (DocumentWeightService)             â”‚   â”‚
â”‚  â”‚ adjustedScore = finalScore Ã— feedbackWeight              â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ - é«˜è¯„åˆ†æ–‡æ¡£: weight > 1.0 â†’ æå‡æ’å                    â”‚   â”‚
â”‚  â”‚ - ä½è¯„åˆ†æ–‡æ¡£: weight < 1.0 â†’ é™ä½æ’å                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 8: è¿‡æ»¤ä¸æ’åº                                       â”‚   â”‚
â”‚  â”‚ - minScoreThreshold è¿‡æ»¤ä½åˆ†æ–‡æ¡£                         â”‚   â”‚
â”‚  â”‚ - æŒ‰æ··åˆåˆ†æ•°é™åºæ’åº                                     â”‚   â”‚
â”‚  â”‚ - å– hybridTopK ä¸ªç»“æœ                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 9: ç¼“å­˜ç»“æœ                                         â”‚   â”‚
â”‚  â”‚ - å°†ç»“æœå­˜å…¥ç¼“å­˜                                         â”‚   â”‚
â”‚  â”‚ - TTL: 30åˆ†é’Ÿ                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†“                                        â”‚
â”‚                    è¿”å›æ–‡æ¡£åˆ—è¡¨                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š é…ç½®å‚æ•°é€ŸæŸ¥è¡¨

| å‚æ•° | é…ç½®è·¯å¾„ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|---------|--------|------|
| luceneTopK | `vector-search.lucene-top-k` | 100 | Lucene ç²—ç­›æ•°é‡ |
| vectorTopK | `vector-search.vector-top-k` | 50 | å‘é‡ç²¾æ’æ•°é‡ |
| hybridTopK | `vector-search.hybrid-top-k` | 30 | æœ€ç»ˆç»“æœæ•°é‡ |
| luceneWeight | `vector-search.lucene-weight` | 0.3 | Lucene è¯„åˆ†æƒé‡ |
| vectorWeight | `vector-search.vector-weight` | 0.7 | å‘é‡è¯„åˆ†æƒé‡ |
| minScoreThreshold | `vector-search.min-score-threshold` | 0.06 | æœ€å°åˆ†æ•°é˜ˆå€¼ |
| similarityThreshold | `vector-search.similarity-threshold` | 0.5 | å‘é‡ç›¸ä¼¼åº¦é˜ˆå€¼ |
| enableCache | `knowledge-base.enable-cache` | true | æ˜¯å¦å¯ç”¨ç¼“å­˜ |
| historyLimit | `similar-qa.history-limit` | 100 | ç›¸ä¼¼é—®é¢˜å†å²æ•°é‡ |
| minRating | `similar-qa.min-rating` | 4 | ç›¸ä¼¼é—®é¢˜æœ€ä½è¯„åˆ† |

---

## ğŸ”§ ä¿®å¤å»ºè®®ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é—®é¢˜ | çŠ¶æ€ |
|--------|------|------|
| ğŸ”´ é«˜ | P5 åŒä¹‰è¯åŒå‘æŸ¥æ‰¾æ•ˆç‡ä½ | âœ… å·²ä¿®å¤ |
| ğŸŸ¡ ä¸­ | P1 ç¼“å­˜é”®ç”Ÿæˆè¿‡äºç®€å• | âœ… å·²ä¿®å¤ |
| ğŸŸ¡ ä¸­ | P3 æƒé‡æ–‡ä»¶è·¯å¾„ç¡¬ç¼–ç  | âœ… å·²ä¿®å¤ |
| ğŸŸ¡ ä¸­ | P7 æ£€ç´¢ç­–ç•¥æ¡†æ¶æœªé›†æˆ | ğŸ“‹ å¾…å®Œå–„ |
| ğŸŸ¢ ä½ | P2 ç¼“å­˜å¤§å°å’ŒTTLç¡¬ç¼–ç  | âœ… å·²ä¿®å¤ |
| ğŸŸ¢ ä½ | P4 æŸ¥è¯¢æ‰©å±•æ—¥å¿—æœªå›½é™…åŒ– | âœ… å·²ä¿®å¤ |
| ğŸŸ¢ ä½ | P6 ç›¸ä¼¼é—®é¢˜æ£€ç´¢ç¼ºå°‘ç¼“å­˜ | âœ… å·²ä¿®å¤ |
| ğŸ“‹ å¢å¼º | P8 æ–‡æ¡£æƒé‡ç¼ºå°‘è¡°å‡æœºåˆ¶ | âœ… å·²ä¿®å¤ |

---

## âœ… æ€»ç»“

RAG æ£€ç´¢æ¨¡å—æ•´ä½“è®¾è®¡è‰¯å¥½ï¼Œç‰¹åˆ«æ˜¯ï¼š

1. **æ··åˆæ£€ç´¢æ¶æ„** - ä¸¤é˜¶æ®µæ£€ç´¢å¹³è¡¡æ€§èƒ½ä¸ç²¾åº¦
2. **é…ç½®åŒ–ç¨‹åº¦é«˜** - å¤§éƒ¨åˆ†å‚æ•°å¯é…ç½®
3. **é™çº§ç­–ç•¥å®Œå–„** - å„ç»„ä»¶éƒ½æœ‰é™çº§æ–¹æ¡ˆ
4. **åé¦ˆé—­ç¯** - ç”¨æˆ·åé¦ˆå½±å“åç»­æ£€ç´¢

### æœ¬æ¬¡ä¿®å¤å®Œæˆï¼š

âœ… **P1 ç¼“å­˜é”®ç”Ÿæˆ** - æ·»åŠ é…ç½®å‚æ•° hashï¼Œç¡®ä¿é…ç½®å˜åŒ–æ—¶ç¼“å­˜å¤±æ•ˆ
âœ… **P2 ç¼“å­˜é…ç½®** - æ·»åŠ  CacheConfig é…ç½®ç±»ï¼Œæ”¯æŒè‡ªå®šä¹‰ç¼“å­˜å¤§å°å’Œ TTL
âœ… **P3 æƒé‡æ–‡ä»¶è·¯å¾„** - ä»é…ç½®è¯»å–ï¼Œä¸å†ç¡¬ç¼–ç 
âœ… **P5 åŒä¹‰è¯æŸ¥æ‰¾** - ä½¿ç”¨åå‘ç´¢å¼•ï¼ŒO(1) æ—¶é—´å¤æ‚åº¦
âœ… **P6 ç›¸ä¼¼é—®é¢˜ç¼“å­˜** - æ·»åŠ  Caffeine ç¼“å­˜æ”¯æŒ
âœ… **P8 æ—¶é—´è¡°å‡** - æ·»åŠ æƒé‡æ—¶é—´è¡°å‡æœºåˆ¶

### å¾…å®Œæˆé¡¹ï¼š

ğŸ“‹ **P7 æ£€ç´¢ç­–ç•¥æ¡†æ¶é›†æˆ** - ç­–ç•¥æ¡†æ¶å·²å­˜åœ¨ï¼Œéœ€è¦åœ¨ KnowledgeQAService ä¸­é›†æˆè°ƒåº¦å™¨

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-07

