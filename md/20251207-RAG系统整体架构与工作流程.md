# RAG 智能知识库系统 - 整体架构与工作流程

> 文档版本: v1.2  
> 更新日期: 2025-12-07  
> 作者: AI Reviewer Team  
> 最新更新: 
> - 添加检索策略调度器（SearchStrategyDispatcher）
> - 规划 HOPE 三层记忆架构（参考 Google 论文）

---

## 一、系统架构概览

### 1.1 核心设计理念

本系统采用**可插拔的 AI 引擎架构**，支持在多个关键环节灵活切换不同的 AI 能力提供者：

| 环节 | 可选引擎 | 特点 |
|------|---------|------|
| 文档分块 | ONNX本地模型 / Ollama / 在线LLM | 离线优先，按需升级 |
| 向量嵌入 | BGE-Base-ZH / BGE-M3 / 其他ONNX模型 | 国产模型优先 |
| 文档重排序 | PPL Rerank / 无 | 提升检索精度 |
| 问答生成 | DeepSeek / OpenAI / Qwen / Ollama | 成本与质量平衡 |
| 图片理解 | Qwen-VL / GPT-4o / Ollama Vision | 多模态支持 |
| **智能记忆** | **HOPE 三层架构** (规划中) | **减少 LLM 调用，提升响应速度** |

### 1.2 系统架构图

```
+------------------------------------------------------------------+
|                        用户界面 (React)                           |
|  +------------+  +------------+  +------------+  +------------+   |
|  | 智能问答   |  | 文档管理   |  | AI分析     |  | 统计信息   |   |
|  +------------+  +------------+  +------------+  +------------+   |
+------------------------------------------------------------------+
                              |
                              v
+------------------------------------------------------------------+
|                     Spring Boot 后端                              |
|  +------------------+  +------------------+  +------------------+ |
|  | KnowledgeQA      |  | DocumentMgmt    |  | FeedbackSystem   | |
|  | Controller       |  | Controller      |  | Controller       | |
|  +------------------+  +------------------+  +------------------+ |
+------------------------------------------------------------------+
                              |
          +-------------------+-------------------+
          v                   v                   v
+----------------+  +------------------+  +------------------+
| RAG 核心引擎   |  | AI 引擎抽象层    |  | 反馈优化系统     |
| - Lucene索引   |  | - LLMClient      |  | - 权重调整       |
| - 向量索引     |  | - PPLService     |  | - 问答归档       |
| - 混合检索     |  | - VisionLLM      |  | - 相似问题       |
+----------------+  +------------------+  +------------------+
          |
          v
+------------------------------------------------------------------+
|          HOPE 三层记忆架构 (规划中，参考 Google 论文)             |
|  +----------------+  +----------------+  +----------------+       |
|  | 低频层         |  | 中频层         |  | 高频层         |       |
|  | (Permanent)    |  | (Ordinary)     |  | (High-freq)    |       |
|  | 技能知识/模板  |  | 近期问答归档   |  | 会话上下文     |       |
|  | 可直接回答     |  | 知识晋升来源   |  | 临时定义       |       |
|  +----------------+  +----------------+  +----------------+       |
+------------------------------------------------------------------+
          |
          v
+------------------------------------------------------------------+
|              检索策略调度框架 (SearchStrategyDispatcher)          |
|  +----------------+  +----------------+  +----------------+       |
|  | HybridSearch   |  | KeywordSearch  |  | VectorSearch   |       |
|  | Strategy       |  | Strategy       |  | Strategy       |       |
|  | (默认,优先级10)|  | (优先级20)     |  | (优先级30)     |       |
|  +----------------+  +----------------+  +----------------+       |
+------------------------------------------------------------------+
          |
          v
+------------------------------------------------------------------+
|                      存储层                                       |
|  +------------+  +------------+  +------------+  +------------+   |
|  | 文档存储   |  | 向量索引   |  | 反馈记录   |  | 问答归档   |   |
|  | ./data/    |  | ./data/    |  | ./data/    |  | ./data/    |   |
|  | documents  |  | vector-idx |  | feedback   |  | rag        |   |
|  +------------+  +------------+  +------------+  +------------+   |
+------------------------------------------------------------------+
```

---

## 二、文档索引流程

### 2.1 文档入库方式

系统支持两种文档入库方式：

#### 方式一：Web 上传（推荐）

```
用户选择文件 → 上传到服务器 → 保存到 ./data/documents
                                    ↓
                          auto-index-after-upload = true?
                                    ↓
                            是 → 自动触发增量索引
                            否 → 等待手动触发
```

#### 方式二：本地复制

```
用户复制文件到 ./data/documents 目录
                    ↓
        手动点击"增量索引"按钮
                    ↓
              触发索引流程
```

### 2.2 索引处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        索引处理流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 文件扫描                                                     │
│     FileTrackingService.needsUpdate()                           │
│     ├── 检查文件是否新增                                         │
│     ├── 检查文件是否修改（MD5校验）                              │
│     └── 跳过未变更文件                                           │
│                        ↓                                         │
│  2. 文档解析                                                     │
│     DocumentParser                                               │
│     ├── Excel → ExcelParser                                     │
│     ├── Word → WordParser                                       │
│     ├── PPT → PowerPointParser                                  │
│     ├── PDF → PDFParser                                         │
│     └── 其他 → TextParser                                       │
│                        ↓                                         │
│  3. 图片处理 (可选)                                              │
│     ImageStorageService                                          │
│     ├── strategy: placeholder → 仅保存占位符                    │
│     ├── strategy: vision-llm → 调用 Vision LLM 提取文本         │
│     │   ├── Qwen-VL (默认)                                      │
│     │   ├── GPT-4o                                              │
│     │   └── Ollama Vision (本地)                                │
│     └── strategy: llm-client → 使用主LLM的图片能力              │
│                        ↓                                         │
│  4. 智能分块 ★★★ 可切换引擎 ★★★                                │
│     DocumentPreprocessingService.chunkDocumentWithPPL()          │
│     ├── strategy: ppl (默认，推荐)                              │
│     │   ├── provider: onnx → 本地 ONNX 模型 (免费、快速)        │
│     │   ├── provider: ollama → 本地 Ollama (qwen2.5:0.5b)       │
│     │   └── provider: openai → 在线 API (高精度、收费)          │
│     ├── strategy: llm → 使用大语言模型切分                      │
│     │   └── 调用 LLMClient.generate() 智能识别语义边界          │
│     └── strategy: auto → 自动选择（优先LLM，降级PPL）           │
│                        ↓                                         │
│  5. 建立索引                                                     │
│     LocalFileRAG                                                 │
│     ├── Lucene 全文索引 → 关键词检索                            │
│     └── 向量索引 → 语义检索                                     │
│         └── Embedding 模型 ★★★ 可切换 ★★★                      │
│             ├── bge-base-zh (默认，智源)                        │
│             ├── bge-m3 (最新)                                   │
│             └── text2vec-base-chinese (阿里)                    │
│                        ↓                                         │
│  6. 记录追踪                                                     │
│     FileTrackingService.markAsProcessed()                        │
│     └── 记录文件MD5、处理时间                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 PPL 智能分块详解

PPL (Perplexity) 分块是本系统的核心创新之一：

```
原理：利用语言模型的困惑度（Perplexity）检测语义边界

输入文档: "第一章 产品介绍...第二章 技术规格...第三章 使用说明..."
                    ↓
1. 分句处理
   ["第一章 产品介绍", "本产品是...", "第二章 技术规格", ...]
                    ↓
2. 计算每句 PPL
   [12.5, 15.2, 45.8, 18.3, ...]  ← 45.8 突变！
                    ↓
3. 检测突变点 (threshold=20.0)
   在 PPL 变化 > 20 的位置切分
                    ↓
4. 输出语义块
   块1: "第一章 产品介绍..."
   块2: "第二章 技术规格..."
   块3: "第三章 使用说明..."
```

**引擎切换能力：**

| 引擎 | 速度 | 精度 | 成本 | 适用场景 |
|------|------|------|------|---------|
| ONNX (qwen2.5-0.5b) | 快 | 中 | 免费 | 日常使用 |
| Ollama (qwen2.5:0.5b) | 快 | 中 | 免费 | 简单部署 |
| OpenAI API | 慢 | 高 | 收费 | 高精度需求 |
| LLM 直接切分 | 慢 | 最高 | 收费 | 重要文档 |

---

## 三、知识库问答流程 (RAG)

### 3.1 完整问答流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     知识库问答流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户提问: "这个产品的价格是多少？"                              │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 0: 相似问题推荐                                      │   │
│  │ SimilarQAService.findSimilar()                            │   │
│  │ ├── 搜索历史高分问答（评分>=4）                           │   │
│  │ ├── 基于关键词重叠度计算相似度                            │   │
│  │ ├── 如果找到相似问题 → 直接展示历史答案供参考             │   │
│  │ └── 用户可选择采用历史答案或继续新查询                    │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 1: 检索策略调度 (SearchStrategyDispatcher) ★ 新增 ★  │   │
│  │                                                            │   │
│  │ 策略调度器自动选择最合适的检索策略：                       │   │
│  │ ├── 评估各策略对当前查询的适用性（0-100分）               │   │
│  │ ├── 选择得分最高且超过阈值的策略                          │   │
│  │ └── 支持降级：选定策略失败时切换到默认策略                │   │
│  │                                                            │   │
│  │ 可用策略：                                                 │   │
│  │ ├── hybrid (默认): 混合检索，适用于大多数场景             │   │
│  │ ├── keyword: 关键词检索，适合精确匹配                     │   │
│  │ └── vector: 向量检索，适合语义相似                        │   │
│  │                                                            │   │
│  │ 降级逻辑：                                                 │   │
│  │ ├── 策略调度器可用 → 使用策略调度器                       │   │
│  │ ├── 无可用策略但有向量引擎 → 直接混合检索                 │   │
│  │ └── 无向量引擎 → 纯关键词检索                             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 1.1: 混合检索 (HybridSearchService)                  │   │
│  │                                                            │   │
│  │ 1.0 缓存检查（新增 2025-12-07）                           │   │
│  │     ├── SearchCacheService.getCachedOrSearch()            │   │
│  │     ├── 相似查询自动复用缓存结果                          │   │
│  │     └── 缓存命中直接返回，无需重新检索                    │   │
│  │                                                            │   │
│  │ 1.1 查询扩展 (QueryExpansionService)                      │   │
│  │     ├── 同义词扩展（内置词典 + 自定义配置）               │   │
│  │     │   例: "数据库" → "DB database 存储 数据存储"        │   │
│  │     ├── 可选：LLM 改写（更智能但增加延迟）                │   │
│  │     └── 扩展后查询用于 Lucene 检索                        │   │
│  │                                                            │   │
│  │ 1.2 关键词检索 (Lucene)                                   │   │
│  │     ├── 提取关键词（过滤停用词）                          │   │
│  │     ├── 中英文停用词支持（yml可配置）                     │   │
│  │     └── lucene-top-k: 100 个候选                          │   │
│  │                                                            │   │
│  │ 1.3 向量检索 ★★★ 可切换嵌入模型 ★★★                      │   │
│  │     ├── 使用 EmbeddingEngine 编码问题                     │   │
│  │     ├── 计算与文档向量的余弦相似度                        │   │
│  │     ├── 相似度阈值过滤（similarity-threshold）            │   │
│  │     └── vector-top-k: 50 个候选                           │   │
│  │                                                            │   │
│  │ 1.4 混合评分融合                                          │   │
│  │     ├── Lucene 权重: 可配置 (默认0.3)                     │   │
│  │     ├── 向量权重: 可配置 (默认0.7)                        │   │
│  │     ├── 最小分数阈值过滤（min-score-threshold: 0.06）     │   │
│  │     └── hybrid-top-k: 30 个最终候选                       │   │
│  │                                                            │   │
│  │ 1.5 反馈权重应用                                          │   │
│  │     ├── 从 DocumentWeightService 获取文档权重             │   │
│  │     ├── 调整公式: adjustedScore = hybridScore × weight    │   │
│  │     └── 高评分文档自动提升排名，低评分文档降低排名        │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 1.5: PPL Rerank (可选) ★★★ 可切换引擎 ★★★           │   │
│  │ PPLServiceFacade.rerank()                                 │   │
│  │ ├── 对前 top-k 个文档计算困惑度                           │   │
│  │ ├── PPL 转分数: ppl_score = 1/(1+ppl)                     │   │
│  │ ├── 混合评分: (1-α)×原始分数 + α×ppl_score               │   │
│  │ │   其中 α = reranking.weight (默认0.25)                  │   │
│  │ │   ✅ 原始分数现在正确传递自混合检索                     │   │
│  │ ├── 重新排序，PPL 越低排名越靠前                          │   │
│  │ └── 引擎: ONNX / Ollama / OpenAI（自动降级）             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 2: 会话管理与分页                                    │   │
│  │ SearchSessionService                                      │   │
│  │ ├── 创建会话 sessionId                                    │   │
│  │ ├── 按 documents-per-query (默认5) 分批                   │   │
│  │ ├── 第一批直接使用，剩余文档保存会话中                    │   │
│  │ └── 支持用户请求 "下一批" 继续引用                        │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 3: 智能上下文构建                                    │   │
│  │ SmartContextBuilder.buildSmartContext()                   │   │
│  │                                                            │   │
│  │ 3.1 文档切分策略 ★★★ 可切换 ★★★                          │   │
│  │     ├── SIMPLE: 固定长度切分                              │   │
│  │     ├── SMART_KEYWORD: 关键词优先 (推荐)                  │   │
│  │     └── AI_SEMANTIC: AI语义切分 (高成本)                  │   │
│  │                                                            │   │
│  │ 3.2 长度控制                                              │   │
│  │     ├── max-context-length: 20000 字符                    │   │
│  │     └── max-doc-length: 5000 字符/文档                    │   │
│  │                                                            │   │
│  │ 3.3 相关性保留                                            │   │
│  │     └── 优先保留包含关键词的内容                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 4: 图片信息收集                                      │   │
│  │ ImageStorageService.listImages()                          │   │
│  │ ├── 收集相关文档的图片URL                                │   │
│  │ ├── 最多每文档列出5张图片                                │   │
│  │ └── 附加到上下文（Markdown格式）                         │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 5: Prompt 构建                                       │   │
│  │ buildEnhancedPrompt()                                     │   │
│  │ ├── 系统提示词（yml可配置）                              │   │
│  │ ├── 用户问题                                              │   │
│  │ ├── 相关文档上下文                                        │   │
│  │ ├── 图片信息（如有）                                      │   │
│  │ ├── 文档来源说明                                          │   │
│  │ └── 分页提示（如有更多文档）                              │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 6: LLM 生成答案 ★★★ 可切换引擎 ★★★                  │   │
│  │ LLMClient.generate()                                      │   │
│  │ ├── DeepSeek (默认，性价比高)                             │   │
│  │ ├── OpenAI GPT-4o (高质量)                                │   │
│  │ ├── Qwen (国产)                                           │   │
│  │ └── Ollama (本地部署)                                     │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 7: 保存问答记录                                      │   │
│  │ QARecordService.saveRecord()                              │   │
│  │ └── 用于后续反馈、相似问题推荐、高分归档                  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  返回: AIAnswer {                                                │
│    answer: 答案文本,                                            │
│    sources: 引用来源,                                           │
│    responseTime: 耗时,                                          │
│    chunks: 切分块信息,                                          │
│    images: 相关图片,                                            │
│    usedDocuments: 本次使用文档,                                 │
│    totalDocuments: 总检索文档数,                                │
│    hasMore: 是否有更多文档,                                     │
│    sessionId: 会话ID（用于分页）,                               │
│    similarQuestions: 相似问题推荐                               │
│  }                                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 混合检索评分算法详解

```
┌─────────────────────────────────────────────────────────────────┐
│                   混合检索评分算法                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Lucene 归一化评分:                                              │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ normalizedScore = 1.0 - (排名位置 / 总文档数)               ││
│  │                                                              ││
│  │ 例: Lucene 返回 100 个文档                                  ││
│  │     第1名: 1.0 - (0/100) = 1.0                              ││
│  │     第10名: 1.0 - (9/100) = 0.91                            ││
│  │     第50名: 1.0 - (49/100) = 0.51                           ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  向量相似度评分:                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 直接使用余弦相似度 (0.0 ~ 1.0)                              ││
│  │ 需要超过 similarity-threshold 才纳入候选                    ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  混合评分公式:                                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ hybridScore = luceneWeight × luceneNormalizedScore          ││
│  │             + vectorWeight × vectorSimilarity               ││
│  │                                                              ││
│  │ ✅ 已配置化: 权重从 yml 配置读取                            ││
│  │    - lucene-weight: 0.3  (默认)                             ││
│  │    - vector-weight: 0.7  (默认)                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ✅ 反馈权重调整（新增 2025-12-07）:                            │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ adjustedScore = hybridScore × feedbackWeight                ││
│  │                                                              ││
│  │ feedbackWeight 来自 DocumentWeightService:                  ││
│  │    - 默认权重: 1.0                                          ││
│  │    - 高评分(4-5星): 权重提升 → 排名上升 📈                 ││
│  │    - 低评分(1-2星): 权重降低 → 排名下降 📉                 ││
│  │    - 权重范围: 0.3 ~ 2.0 (可配置)                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  PPL Rerank 二次评分（如启用）:                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ pplScore = 1.0 / (1.0 + perplexity)                         ││
│  │                                                              ││
│  │ finalScore = (1 - weight) × originalScore + weight × pplScore││
│  │                                                              ││
│  │ ✅ 原始分数现在正确传递自混合检索                           ││
│  │ 其中 weight 来自配置: reranking.weight (默认0.25)           ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 查询扩展机制

```
┌─────────────────────────────────────────────────────────────────┐
│                   查询扩展机制                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  原始查询: "如何配置数据库？"                                    │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 1. 同义词扩展 (快速，无成本)                              │   │
│  │                                                           │   │
│  │ 内置同义词词典:                                           │   │
│  │ ├── 数据库 → [DB, database, 存储, 数据存储]              │   │
│  │ ├── 配置 → [config, configuration, 设置, 参数]           │   │
│  │ ├── 接口 → [API, interface, 端点, endpoint]              │   │
│  │ ├── 服务器 → [server, 服务端, 后端, backend]             │   │
│  │ └── ...更多（见 QueryExpansionService）                   │   │
│  │                                                           │   │
│  │ ✅ 已支持外部文件加载同义词                               │   │
│  │ 配置: synonym-file: ./data/synonyms.txt                   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 2. LLM 改写 (可选，高延迟)                                │   │
│  │                                                           │   │
│  │ 通过 LLM 改写查询:                                        │   │
│  │ - 保持原意但使用更通用表述                                │   │
│  │ - 添加同义词或相关概念                                    │   │
│  │ - 明确化模糊查询                                          │   │
│  │                                                           │   │
│  │ 配置: use-llm-rewrite: false (默认关闭)                   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  扩展后查询: "如何配置数据库？ DB database 存储 config 设置"     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4 检索策略框架 (新增 2025-12-07)

检索策略框架支持可插拔的检索方式，根据查询上下文自动选择最合适的策略：

```
┌─────────────────────────────────────────────────────────────────┐
│                   检索策略调度框架                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  核心类: SearchStrategyDispatcher                                │
│  策略接口: SearchStrategy                                        │
│  上下文: SearchContext                                           │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                   策略选择流程                            │   │
│  │                                                           │   │
│  │  1. 收集所有已注册的策略                                  │   │
│  │     strategies: [HybridSearchStrategy,                    │   │
│  │                  KeywordSearchStrategy,                   │   │
│  │                  VectorSearchStrategy]                    │   │
│  │                        ↓                                  │   │
│  │  2. 评估每个策略的适用性 (0-100分)                        │   │
│  │     strategy.evaluateSuitability(context)                 │   │
│  │     ├── HybridSearchStrategy: 95 分 (有向量引擎+长查询)   │   │
│  │     ├── KeywordSearchStrategy: 60 分                      │   │
│  │     └── VectorSearchStrategy: 70 分                       │   │
│  │                        ↓                                  │   │
│  │  3. 选择得分最高且 >= 阈值(50)的策略                      │   │
│  │     → 选择 HybridSearchStrategy                           │   │
│  │                        ↓                                  │   │
│  │  4. 执行检索                                              │   │
│  │     strategy.search(context)                              │   │
│  │                        ↓                                  │   │
│  │  5. 失败时降级到默认策略                                  │   │
│  │     fallback → defaultStrategyId = "hybrid"               │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                   已实现的策略                            │   │
│  │                                                           │   │
│  │  策略ID      │ 优先级 │ 适用场景                         │   │
│  │  ────────────┼────────┼─────────────────────────────────  │   │
│  │  hybrid      │   10   │ 通用场景，结合关键词+语义        │   │
│  │  keyword     │   20   │ 精确匹配，专有名词查询           │   │
│  │  vector      │   30   │ 语义相似，概念性问题             │   │
│  │                                                           │   │
│  │  适用性评分逻辑:                                          │   │
│  │  ├── 有向量引擎 → +10分                                   │   │
│  │  ├── 查询长度 > 20字符 → +5分                             │   │
│  │  ├── 包含专有名词 → keyword 策略加分                      │   │
│  │  └── 概念性问题 → vector 策略加分                         │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                   扩展能力                                │   │
│  │                                                           │   │
│  │  ✅ 动态注册策略: dispatcher.registerStrategy(strategy)   │   │
│  │  ✅ 指定策略执行: dispatcher.searchWithStrategy(id, ctx)  │   │
│  │  ✅ 调整默认策略: dispatcher.setDefaultStrategyId(id)     │   │
│  │  ✅ 调整阈值: dispatcher.setSuitabilityThreshold(val)     │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.5 分批引用机制

当检索到大量相关文档时，系统支持分批引用：

```
检索到 30 个相关文档
        ↓
创建会话 (sessionId: abc123)
        ↓
第一次问答：使用前 5 个文档 (documents-per-query: 5)
返回: { hasMore: true, sessionId: "abc123" }
        ↓
用户点击"下一批" → 调用 /api/qa/next?sessionId=abc123
        ↓
第二次问答：使用第 6-10 个文档
        ↓
... 循环直到所有文档被引用
```

---

## 四、反馈系统与精度提升

### 4.1 反馈系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      反馈系统架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │                  用户反馈入口                           │     │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │     │
│  │  │ 整体评分    │  │ 文档评分    │  │ 表情评价    │     │     │
│  │  │ 1-5星      │  │ 每个文档    │  │ 😀😊😐😞😢  │     │     │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │     │
│  └────────────────────────────────────────────────────────┘     │
│                              ↓                                   │
│  ┌────────────────────────────────────────────────────────┐     │
│  │              FeedbackController                         │     │
│  │  ├── /api/feedback/overall/rate    → 整体评分          │     │
│  │  ├── /api/feedback/document/rate   → 文档评分          │     │
│  │  └── /api/feedback/document        → 有帮助/无帮助     │     │
│  └────────────────────────────────────────────────────────┘     │
│                              ↓                                   │
│  ┌────────────────────────────────────────────────────────┐     │
│  │              反馈处理与优化                             │     │
│  │                                                         │     │
│  │  1. 动态权重调整                                        │     │
│  │     FeedbackService.adjustDocumentWeight()              │     │
│  │     ├── 高评分文档 → 权重 +0.1 (最高2.0)               │     │
│  │     └── 低评分文档 → 权重 -0.15 (最低0.1)              │     │
│  │                                                         │     │
│  │  2. 问答归档 (高分答案)                                 │     │
│  │     QAArchiveService                                    │     │
│  │     ├── 评分 >= 4 的问答 → 归档为文档                  │     │
│  │     ├── 保存到 ./data/rag 目录                         │     │
│  │     └── auto-index: true → 自动加入知识库              │     │
│  │                                                         │     │
│  │  3. 相似问题索引                                        │     │
│  │     SimilarQAService                                    │     │
│  │     └── 提取关键词，建立相似度索引                     │     │
│  │                                                         │     │
│  └────────────────────────────────────────────────────────┘     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 精度提升机制

#### 机制一：动态文档权重

```
初始状态: 所有文档权重 = 1.0

用户反馈后:
  - 文档A 获得5星 → 权重 1.0 + 0.1 = 1.1
  - 文档B 获得1星 → 权重 1.0 - 0.15 = 0.85

下次检索时:
  - 文档A 的相关性分数 × 1.1 → 排名提升
  - 文档B 的相关性分数 × 0.85 → 排名下降

效果: 好文档自动置顶，差文档自动降权
```

#### 机制二：高分问答归档

```
问答完成 → 用户给5星评价
                ↓
          rating >= 4 ?
                ↓ 是
    创建 Markdown 文档:
    ---
    问题: xxx
    答案: xxx
    引用: xxx
    评分: 5
    ---
                ↓
    保存到 ./data/rag/qa-archive-xxx.md
                ↓
    auto-index: true → 加入知识库索引
                ↓
    下次有人问相似问题 → 可以直接检索到这个高质量答案
```

#### 机制三：相似问题推荐

```
用户提问: "产品怎么安装？"
                ↓
    SimilarQAService.findSimilar()
                ↓
    搜索历史问答，计算相似度:
    - "如何安装产品？" → 相似度 85%
    - "安装步骤是什么？" → 相似度 78%
                ↓
    展示给用户:
    "您可能想问：
     • 如何安装产品？ (85% 相似)
     • 安装步骤是什么？ (78% 相似)"
                ↓
    用户可直接采用历史高分答案，无需重新生成
```

### 4.3 少量交互快速提升精度的设计

| 优化措施 | 减少交互次数 | 原理 |
|---------|------------|------|
| 相似问题推荐 | -2~3次 | 复用历史高分答案 |
| PPL Rerank | -1~2次 | 提升首次检索准确率 |
| 查询扩展 | -1~2次 | 同义词自动补充 |
| 动态权重 | -1次 | 好文档自动置顶 |
| 高分归档 | -2~3次 | 知识自动积累 |

**效果估算：**
- 传统 RAG：平均需要 8-10 次交互达到满意答案
- 优化后：平均需要 3-5 次交互达到满意答案
- 提升：减少约 50% 的交互次数

---

## 五、知识库越用越智能的机制

### 5.1 智能积累闭环

```
┌─────────────────────────────────────────────────────────────────┐
│                   知识库智能积累闭环                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│     ┌──────────────┐                                            │
│     │   用户提问   │                                            │
│     └──────┬───────┘                                            │
│            ↓                                                     │
│     ┌──────────────┐     ┌──────────────┐                       │
│     │  RAG 检索    │ ←── │ 相似问题库   │ ←──┐                  │
│     └──────┬───────┘     └──────────────┘    │                  │
│            ↓                                  │                  │
│     ┌──────────────┐                         │                  │
│     │  LLM 生成    │                         │                  │
│     └──────┬───────┘                         │                  │
│            ↓                                  │                  │
│     ┌──────────────┐                         │                  │
│     │  返回答案    │                         │                  │
│     └──────┬───────┘                         │                  │
│            ↓                                  │                  │
│     ┌──────────────┐                         │                  │
│     │  用户反馈    │                         │                  │
│     └──────┬───────┘                         │                  │
│            ↓                                  │                  │
│     ┌──────────────────────────────────┐    │                  │
│     │         反馈处理                  │    │                  │
│     │  ├── 高分(>=4) → 归档到知识库 ───────┘                  │
│     │  ├── 调整文档权重                │                       │
│     │  └── 更新相似问题索引 ───────────────→ 相似问题库        │
│     └──────────────────────────────────┘                       │
│                                                                  │
│  ═══════════════════════════════════════════════════════════    │
│  效果: 使用越多 → 高质量问答越多 → 检索越精准 → 体验越好        │
│  ═══════════════════════════════════════════════════════════    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 LLM 结果文档化

每次 AI 分析的结果都会被保存：

```
AI 分析完成
      ↓
LLMResultDocumentService.save()
      ↓
保存为结构化文档:
{
  "id": "llm-result-xxx",
  "type": "document-analysis",
  "question": "总结文档要点",
  "answer": "...",
  "sourceDocuments": ["产品手册.pdf"],
  "rating": null,
  "createdAt": "2025-12-07T10:30:00"
}
      ↓
可选: auto-add-to-knowledge-base: true
      → 自动加入知识库
```

---

## 六、文档 AI 分析功能

### 6.1 单文档分析

```
┌─────────────────────────────────────────────────────────────────┐
│                     单文档 AI 分析                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户选择: "产品手册.pdf" + 提示词: "总结核心内容"               │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 模式选择                                                  │   │
│  │ ├── 直接分析模式 (推荐)                                  │   │
│  │ │   └── 直接将文档内容发送给 LLM                         │   │
│  │ │                                                         │   │
│  │ └── 知识库增强模式                                       │   │
│  │     └── 结合知识库中的相关内容一起分析                   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 大文档处理                                                │   │
│  │ ├── 文档 <= 20000字 → 直接发送                           │   │
│  │ └── 文档 > 20000字 → 渐进式分析                          │   │
│  │     ├── 分成多个批次                                     │   │
│  │     ├── 每批次提取关键点                                 │   │
│  │     ├── 维护记忆窗口 (memory-window-size: 3)             │   │
│  │     └── 最终合并生成总结                                 │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  LLM 生成分析结果 ★★★ 可切换引擎 ★★★                           │
│                        ↓                                         │
│  保存结果 + 可选加入知识库                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 多文档联合分析（智能策略系统）

系统设计了**可扩展的策略框架**，支持智能感知用户意图并自动切换最佳分析策略。

#### 6.2.1 策略框架架构

```
┌─────────────────────────────────────────────────────────────────┐
│                   多文档分析策略框架                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                 MultiDocAnalysisStrategy 接口               │ │
│  │  ┌────────────────────────────────────────────────────────┐│ │
│  │  │ • getId()           - 策略唯一标识                     ││ │
│  │  │ • getName()         - 策略名称                         ││ │
│  │  │ • getDescription()  - 策略描述                         ││ │
│  │  │ • getCapabilities() - 能力声明（类型/文档数/成本）     ││ │
│  │  │ • evaluateSuitability() - 评估适用性(0-100)           ││ │
│  │  │ • estimateResources()   - 预估资源消耗                ││ │
│  │  │ • analyze()             - 执行分析                    ││ │
│  │  │ • canCombineWith()      - 是否可组合                  ││ │
│  │  │ • getRecommendedCombinations() - 推荐组合             ││ │
│  │  └────────────────────────────────────────────────────────┘│ │
│  └────────────────────────────────────────────────────────────┘ │
│                              ↓                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                StrategyDispatcher 智能调度器               │ │
│  │  ├── 注册管理所有策略实现                                  │ │
│  │  ├── 根据上下文智能选择最佳策略                           │ │
│  │  ├── 组合多个策略执行                                     │ │
│  │  ├── 监控策略执行效果                                     │ │
│  │  └── 根据历史统计动态调整策略权重                         │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.2.2 已实现的策略方案

| 策略ID | 策略名称 | 适用场景 | Token成本 | 速度 | 关系保持 |
|--------|---------|---------|----------|------|---------|
| `parallel-summary` | 并行摘要策略 | 快速总结、综合分析 | 中 | 快 | 中 |
| `structured-compare` | 结构化对比策略 | 方案对比、优缺点分析 | 中 | 中 | 高 |
| `question-driven` | 问题导向检索 | 精确查询、找答案 | 最低 | 最快 | 低 |
| `entity-relation` | 实体关联策略 | 关联分析、因果追溯 | 中 | 中 | 最高 |

**策略能力声明示例：**

```java
// 并行摘要策略
StrategyCapabilities.builder()
    .supportedTypes(Set.of(SUMMARY, COMPREHENSIVE))
    .minDocuments(1).maxDocuments(20).optimalDocuments(5)
    .tokenCost(CostLevel.MEDIUM)
    .speed(SpeedLevel.FAST)
    .quality(QualityLevel.GOOD)
    .relationPreserve(RelationLevel.MEDIUM)
    .build();

// 结构化对比策略
StrategyCapabilities.builder()
    .supportedTypes(Set.of(COMPARE))
    .minDocuments(2).maxDocuments(10).optimalDocuments(3)
    .tokenCost(CostLevel.MEDIUM)
    .speed(SpeedLevel.MEDIUM)
    .quality(QualityLevel.EXCELLENT)
    .relationPreserve(RelationLevel.HIGH)
    .build();
```

#### 6.2.3 智能意图感知与策略切换

```
┌─────────────────────────────────────────────────────────────────┐
│                 智能意图感知与策略切换流程                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户输入                                                        │
│  ├── 选择 3 个文档                                              │
│  └── 问题: "对比这三个方案的优缺点"                             │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 1: 用户意图分析                                      │   │
│  │                                                           │   │
│  │ 关键词检测规则:                                           │   │
│  │ ┌─────────────────────────────────────────────────────┐  │   │
│  │ │ 检测特征            │ 识别为      │ 推荐策略         │  │   │
│  │ ├─────────────────────┼────────────┼─────────────────┤  │   │
│  │ │ "什么"/"哪个"/"多少" │ 精确查询   │ question-driven │  │   │
│  │ │ "总结"/"概括"/"简述" │ 快速概览   │ parallel-summary│  │   │
│  │ │ "对比"/"比较"/"区别" │ 对比分析   │ structured-comp │  │   │
│  │ │ "为什么"/"原因"     │ 因果分析   │ entity-relation │  │   │
│  │ │ "关联"/"联系"       │ 关联分析   │ entity-relation │  │   │
│  │ └─────────────────────┴────────────┴─────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 2: 策略适用性评估                                    │   │
│  │                                                           │   │
│  │ 各策略评分(0-100):                                        │   │
│  │ ├── parallel-summary:   45  (总结型，但问的是对比)        │   │
│  │ ├── structured-compare: 85  ✅ (检测到"对比"关键词)       │   │
│  │ ├── question-driven:    30  (非精确查询类型)              │   │
│  │ └── entity-relation:    50  (可分析关联，非最优)          │   │
│  │                                                           │   │
│  │ 历史统计调整:                                             │   │
│  │ └── structured-compare 成功率 92% → +4.2 → 最终 89.2     │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 3: 策略选择决策                                      │   │
│  │                                                           │   │
│  │ 选择规则:                                                 │   │
│  │ ├── 最高分策略 > 次高分 × 1.5 → 单独使用最高分策略       │   │
│  │ └── 否则组合使用得分相近的策略(top 2)                    │   │
│  │                                                           │   │
│  │ 本次决策: structured-compare (89.2) >> 其他 → 单独使用    │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Step 4: 执行策略分析                                      │   │
│  │                                                           │   │
│  │ StructuredCompareStrategy.analyze()                       │   │
│  │ ├── 解析文档内容                                         │   │
│  │ ├── 构建对比分析 Prompt                                  │   │
│  │ ├── 调用 LLM 生成对比表格                                │   │
│  │ └── 输出结构化报告                                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│                        ↓                                         │
│  输出: 对比表格 + 共同点/差异 + 优缺点 + 建议                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.2.4 前端用户友好的分析目标选择

系统为用户提供了**6 种预设分析目标**，自动映射到后端策略：

```
┌─────────────────────────────────────────────────────────────────┐
│  📋 您想要什么样的分析？                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ 🚀 快速了解大意  │  │ 🎯 精确查找答案  │  │ ⚖️ 对比优劣    │  │
│  │ 几分钟内了解    │  │ 针对问题找答案  │  │ 对比优缺点     │  │
│  │ 主要内容        │  │                 │  │                │  │
│  │ → parallel-     │  │ → question-     │  │ → structured-  │  │
│  │   summary       │  │   driven        │  │   compare      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ 🔗 分析关联关系  │  │ 🔄 追溯因果脉络  │  │ 📊 全面深度分析 │  │
│  │ 找出联系和      │  │ 分析前因后果    │  │ 最详细的       │  │
│  │ 异同点          │  │                 │  │ 分析报告       │  │
│  │ → entity-       │  │ → entity-       │  │ → parallel +   │  │
│  │   relation      │  │   relation      │  │   entity       │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                  │
│  💡 智能推荐: 检测到"对比"关键词 → 推荐【对比优劣】             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.2.5 策略组合执行

当多个策略评分相近时，系统会组合执行并合并结果：

```
场景: 用户问 "分析这些文档的关联并总结要点"
                    ↓
策略评分:
├── parallel-summary:  75  (检测到"总结")
└── entity-relation:   80  (检测到"关联")
                    ↓
差距 < 1.5倍 → 组合执行
                    ↓
┌─────────────────────────────────────────────────────────────────┐
│ 组合执行流程                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [并行摘要策略]          [实体关联策略]                          │
│       ↓                       ↓                                  │
│  各文档独立摘要          提取实体和关系                          │
│       ↓                       ↓                                  │
│  综合摘要报告            关系网络分析                            │
│       ↓                       ↓                                  │
│  └───────────┬──────────────┘                                   │
│              ↓                                                   │
│         合并结果                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ ## 并行摘要策略 分析结果                                    ││
│  │ [各文档摘要 + 综合总结]                                     ││
│  │                                                              ││
│  │ ## 实体关联策略 分析结果                                    ││
│  │ [实体提取 + 关系网络 + 跨文档关联]                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.2.6 策略扩展能力（未来优化）

系统采用**可插拔设计**，支持引入新策略：

```java
// 1. 实现 MultiDocAnalysisStrategy 接口
@Component
public class MindMapStrategy implements MultiDocAnalysisStrategy {
    @Override
    public String getId() { return "mind-map"; }
    
    @Override
    public int evaluateSuitability(AnalysisContext context) {
        // 评估是否适合生成思维导图
    }
    
    @Override
    public AnalysisResult analyze(AnalysisContext context, ProgressCallback callback) {
        // 实现思维导图生成逻辑
    }
}

// 2. Spring 自动注册到 StrategyDispatcher
// 无需修改任何配置，即插即用
```

**规划中的策略扩展：**

| 策略 | 描述 | 状态 |
|------|------|------|
| 思维导图策略 | 自动生成思维导图结构 | 规划中 |
| 时间线策略 | 按时间顺序分析事件 | 规划中 |
| 渐进式记忆策略 | 超大文档的滑动窗口分析 | 规划中 |
| 辩论式策略 | 让 LLM 从正反两面分析 | 规划中 |
| 引用策略 | 严格追溯每个结论的出处 | 规划中 |

**策略市场设想：**

```
┌─────────────────────────────────────────────────────────────────┐
│  📦 策略市场 (未来功能)                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  内置策略           社区策略            企业策略                  │
│  ├── 并行摘要 ✅    ├── 法律合同对比    ├── 财报分析专用        │
│  ├── 结构对比 ✅    ├── 学术论文综述    ├── 医疗文档解读        │
│  ├── 问题导向 ✅    ├── 代码审查        ├── 风控报告生成        │
│  └── 实体关联 ✅    └── 新闻聚合        └── 合规检查            │
│                                                                  │
│  [安装] [更新] [自定义]                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 PPT 渐进式分析

针对 PPT 这种多页文档的特殊处理：

```
PPT: 50 页演示文稿
        ↓
┌─────────────────────────────────────────────────────────────────┐
│ 渐进式分析流程                                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  批次1: 幻灯片 1-10                                              │
│  ├── 提取图片 → Vision LLM 识别                                 │
│  ├── 提取文本                                                    │
│  ├── LLM 分析 → 生成关键点                                      │
│  └── 保存到记忆窗口                                              │
│                        ↓                                         │
│  批次2: 幻灯片 11-20                                             │
│  ├── 携带批次1的关键点作为上下文                                │
│  ├── LLM 分析 → 生成新的关键点                                  │
│  └── 更新记忆窗口（保留最近3批次）                              │
│                        ↓                                         │
│  ... 继续处理 ...                                                │
│                        ↓                                         │
│  最终整合:                                                       │
│  ├── 汇总所有批次的关键点                                       │
│  ├── LLM 生成综合总结                                           │
│  └── 输出: 总结 + 每页详情                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 七、思维导图格式

以下内容可直接复制到 XMind、MindMaster、Markmap 等工具转换为思维导图：

```markdown
# RAG智能知识库系统

## 一、系统架构
### 可插拔AI引擎
- 文档分块: ONNX/Ollama/在线LLM
- 向量嵌入: BGE-Base-ZH/BGE-M3
- 文档重排: PPL Rerank
- 问答生成: DeepSeek/OpenAI/Qwen
- 图片理解: Qwen-VL/GPT-4o

### 存储层
- 文档存储: ./data/documents
- 向量索引: ./data/vector-index
- 反馈记录: ./data/feedback
- 问答归档: ./data/rag

## 二、文档索引流程
### 入库方式
- Web上传(支持自动索引)
- 本地复制+手动索引

### 处理步骤
- 文件扫描(增量检测)
- 文档解析(多格式)
- 图片处理(Vision LLM可选)
- 智能分块(PPL/LLM可切换)
- 建立索引(Lucene+向量)
- 记录追踪

### PPL智能分块
- ONNX本地(快速免费)
- Ollama本地(简单部署)
- 在线API(高精度)
- LLM直接切分(最高精度)

## 三、知识库问答(RAG)
### 问答流程
- Step0: 相似问题推荐
- Step1: 混合检索(Lucene+向量)
  - 1.0 查询扩展
    - 同义词扩展
    - LLM改写(可选)
  - 1.1 Lucene关键词检索
  - 1.2 向量语义检索
  - 1.3 混合评分融合
    - ⚠️ 权重硬编码0.3/0.7
- Step1.5: PPL Rerank(可选)
- Step2: 会话管理与分页
- Step3: 智能上下文构建
- Step4: 图片信息收集
- Step5: Prompt构建
- Step6: LLM生成答案
- Step7: 保存问答记录

### 检索优化
- lucene-top-k: 100
- vector-top-k: 50
- hybrid-top-k: 30
- documents-per-query: 5
- min-score-threshold: 0.06

### 查询扩展
- 同义词扩展
  - ✅ 支持外部文件加载
  - ✅ 内置词典 + 可扩展
- LLM改写(可选)
  - use-llm-rewrite配置

### 已修复问题 ✅
- ✅ 混合权重可配置
- ✅ 同义词文件支持
- ✅ 停用词统一从配置加载
- ✅ PPL原始分数正确传递
- ✅ 反馈权重应用到检索
- ✅ 图片列表数量可配置
- ✅ 会话超时时间可配置
- ✅ LLM改写Prompt可配置
- ✅ 日志统一国际化
- ✅ 魔法数字配置化
- ✅ 会话数量限制实现
- ✅ 空指针检查完善
- ✅ 检索结果缓存
- ✅ 检索策略框架
- ✅ 评分融合接口

### 性能优化 ⚡
- ✅ 检索结果缓存 (SearchCacheService)
- ✅ 查询扩展结果缓存
- ✅ 会话自动驱逐机制

### 检索策略框架 🎯
#### 策略接口 (SearchStrategy)
- hybrid: 混合检索（默认，高优先级）
- keyword: 关键词检索
- vector: 向量检索

#### 策略调度器 (SearchStrategyDispatcher)
- 自动选择最佳策略
- 基于适用性评分
- 支持策略降级
- 运行时动态注册

#### 评分融合 (ScoreFusionService)
- 可扩展评分贡献者
- LuceneScoreContributor
- VectorScoreContributor
- FeedbackScoreContributor
- 加权融合算法

## 四、反馈系统
### 反馈类型
- 整体评分(1-5星)
- 文档评分
- 表情评价

### 精度提升机制
- 动态文档权重
- 高分问答归档
- 相似问题推荐

### 效果
- 减少50%交互次数

## 五、知识积累闭环
### 自动积累
- 高分答案→归档→加入知识库
- 权重调整→好文档置顶
- 相似问题索引→复用历史

### LLM结果文档化
- 保存每次分析结果
- 可选加入知识库

## 六、AI分析功能
### 单文档分析
- 直接分析模式
- 知识库增强模式
- 大文档渐进式分析

### 多文档联合分析
#### 智能策略框架
- MultiDocAnalysisStrategy接口
- StrategyDispatcher调度器
- 可插拔策略设计

#### 已实现策略
- parallel-summary: 并行摘要
- structured-compare: 结构化对比
- question-driven: 问题导向检索
- entity-relation: 实体关联分析

#### 智能意图感知
- 关键词检测规则
- 策略适用性评分
- 历史统计调整
- 自动选择最佳策略

#### 前端分析目标
- 快速了解大意
- 精确查找答案
- 对比优劣
- 分析关联关系
- 追溯因果脉络
- 全面深度分析

#### 策略扩展能力
- 可插拔设计
- Spring自动注册
- 规划中: 思维导图/时间线/渐进记忆

### PPT渐进式分析
- 批次处理
- 记忆窗口
- Vision LLM图片识别
- 最终整合
```

---

### Markmap 专用格式（可直接生成交互式思维导图）

```markmap
# RAG智能知识库系统

## 系统架构
### AI引擎层
#### 文档分块引擎
- ONNX本地模型 ⚡
- Ollama本地服务
- 在线LLM API
#### 向量嵌入引擎
- BGE-Base-ZH 🇨🇳
- BGE-M3
- Text2Vec
#### 问答生成引擎
- DeepSeek 💰
- OpenAI GPT-4o
- Qwen通义千问
- Ollama本地
#### 图片理解引擎
- Qwen-VL 🇨🇳
- GPT-4o Vision
- Ollama Vision

## 文档索引流程
### 入库方式
- Web上传 ✅
  - 自动索引可配置
- 本地复制
  - 手动触发索引
### 处理管线
- 文件扫描(MD5增量)
- 文档解析(多格式)
- 图片处理(Vision可选)
- 智能分块(PPL/LLM)
- 索引建立(Lucene+向量)

## 知识库问答RAG
### 问答流程
- 相似问题推荐
- 混合检索
  - 查询扩展
    - 同义词扩展 ✅可扩展
    - LLM改写(可选)
  - Lucene关键词
  - 向量语义
  - 混合评分 ✅权重可配置
  - 反馈权重 ✅新增
- PPL Rerank ✅分数传递
- 会话管理分页
- 智能上下文构建
- LLM生成答案
### 精度优化
- lucene-top-k: 100
- vector-top-k: 50
- hybrid-top-k: 30
- min-score: 0.06
### 查询扩展
- 同义词词典 ✅可扩展
- LLM改写(可选)
- ✅ synonym-file已实现

## 反馈系统
### 反馈类型
- 整体1-5星
- 文档评分
- 表情反馈
### 精度提升
- 动态权重调整 📈
- 高分问答归档 📦
- 相似问题推荐 🔗
- ✅ 权重应用到检索
### 效果
- 减少50%交互 🎯

## 知识积累闭环
### 自动积累
- 高分→归档→知识库
- 权重→好文档置顶
- 索引→相似问题
### 越用越智能 🧠

## 多文档分析
### 策略框架
- MultiDocAnalysisStrategy接口
- StrategyDispatcher调度器
### 已实现策略
- 并行摘要 parallel-summary
- 结构对比 structured-compare
- 问题导向 question-driven
- 实体关联 entity-relation
### 智能意图感知
- 关键词检测
- 适用性评分
- 历史统计
- 自动选择
### 用户分析目标
- 🚀 快速了解
- 🎯 精确查找
- ⚖️ 对比优劣
- 🔗 分析关联
- 🔄 追溯因果
- 📊 深度分析
### 未来扩展
- 思维导图策略
- 时间线策略
- 渐进记忆策略
- 策略市场 🛒
```

---

## 八、配置快速参考

### 8.1 引擎切换配置

```yaml
# PPL 引擎切换
knowledge.qa.ppl:
  default-provider: onnx  # 可选: onnx, ollama, openai
  
# 分块策略切换
knowledge.qa.ppl.chunking:
  strategy: ppl  # 可选: ppl, llm, auto
  
# 问答切分策略切换
knowledge.qa.llm:
  chunking-strategy: SMART_KEYWORD  # 可选: SIMPLE, SMART_KEYWORD, AI_SEMANTIC

# 向量模型切换
knowledge.qa.vector-search.model:
  name: bge-base-zh  # 可选: bge-base-zh, bge-m3, text2vec-base-chinese

# LLM 引擎切换
knowledge.qa.llm:
  provider: openai
  api-url: https://api.deepseek.com/v1/chat/completions
  model: deepseek-chat

# Vision LLM 切换
knowledge.qa.image-processing:
  strategy: vision-llm
  vision-llm:
    model: qwen-vl-plus  # 可选: qwen-vl-plus, gpt-4o, llava
```

### 8.2 混合检索配置（新增 2025-12-07）

```yaml
knowledge:
  qa:
    vector-search:
      # 检索范围配置
      lucene-top-k: 100        # Lucene 粗筛数量
      vector-top-k: 50         # 向量精排数量
      hybrid-top-k: 30         # 最终结果数量
      documents-per-query: 5   # 每次问答引用数量
      
      # 混合评分权重配置
      lucene-weight: 0.3       # 关键词检索权重
      vector-weight: 0.7       # 向量语义权重
      min-score-threshold: 0.06  # 最小分数阈值
      
      # 日志显示配置（新增）
      log-display-limit: 10    # 日志中显示的最大文档数量
      
    # 相似问题推荐配置
    similar-qa:
      history-limit: 100       # 历史记录查询上限
      min-rating: 4            # 最低评分阈值
      min-score: 30            # 最小相似度(0-100)
      limit: 3                 # 推荐结果数量上限
      
    # 会话管理配置
    session:
      timeout-minutes: 30      # 会话超时时间
      max-sessions: 1000       # 最大会话数量
      
    # 图片处理配置
    image-processing:
      max-images-per-doc: 5    # 每文档最大图片数
      
    # 查询扩展配置
    query-expansion:
      enabled: true
      synonym-file: ./data/synonyms.txt  # 外部同义词文件
      use-llm-rewrite: false
      llm-rewrite-prompt: |    # LLM 改写 Prompt（可自定义）
        请帮我改写以下搜索查询...
        原始查询：{query}
        改写后的查询：
      synonym-file: ./data/synonyms.txt  # 自定义同义词文件
      use-llm-rewrite: false
```

### 8.2 推荐配置组合

| 场景 | PPL | 分块 | LLM | Vision |
|------|-----|------|-----|--------|
| 经济优先 | onnx | ppl | deepseek | qwen-vl |
| 质量优先 | openai | llm | gpt-4o | gpt-4o |
| 离线部署 | ollama | ppl | ollama | ollama |

### 8.3 多文档分析 API 参考

```bash
# 智能分析接口（自动选择策略）
POST /api/document-qa/analyze-smart
{
  "documentPaths": ["方案A.docx", "方案B.docx"],
  "question": "对比这两个方案的优缺点",
  "goalId": "compare",  // 可选: quick, precise, compare, relation, causal, comprehensive
  "strategies": [],     // 为空则自动选择
  "useKnowledgeBase": false
}

# 获取可用策略列表
GET /api/document-qa/strategies

# 响应示例
{
  "strategies": [
    {
      "id": "parallel-summary",
      "name": "并行摘要策略",
      "description": "并行处理多个文档，生成各自摘要后综合分析",
      "capabilities": {
        "supportedTypes": ["SUMMARY", "COMPREHENSIVE"],
        "minDocuments": 1,
        "maxDocuments": 20,
        "tokenCost": "MEDIUM",
        "speed": "FAST"
      }
    },
    ...
  ]
}
```

### 8.4 策略选择规则

| 用户目标 | goalId | 自动选择策略 | 适用文档数 |
|---------|--------|-------------|-----------|
| 快速了解大意 | quick | parallel-summary | 1-20 |
| 精确查找答案 | precise | question-driven | 1-100 |
| 对比优劣 | compare | structured-compare | 2-10 |
| 分析关联关系 | relation | entity-relation | 2-10 |
| 追溯因果脉络 | causal | entity-relation | 2-10 |
| 全面深度分析 | comprehensive | parallel + entity | 2-10 |

### 8.5 检索策略框架（新增 2025-12-07）

#### 检索策略类型

| 策略ID | 策略名称 | 适用场景 | 优先级 |
|--------|---------|---------|--------|
| hybrid | 混合检索策略 | 大多数场景（默认） | 10 |
| keyword | 关键词检索策略 | 精确匹配、短查询 | 20 |
| vector | 向量检索策略 | 语义相似、长查询 | 30 |

#### 策略自动选择规则

```yaml
# HybridSearchStrategy 适用性评分规则
- 基础分数: 80
- 有向量引擎: +10
- 查询长度 > 20字符: +5
- 最高: 100

# KeywordSearchStrategy 适用性评分规则
- 基础分数: 50
- 包含引号(精确匹配): +30
- 包含缩写词: +10
- 短查询 < 10字符: +15
- 无向量引擎: +40

# VectorSearchStrategy 适用性评分规则
- 无向量引擎: 0 (不可用)
- 基础分数: 60
- 长查询 > 30字符: +20
- 问句形式: +15
```

#### 评分贡献者配置

| 贡献者 | 默认权重 | 说明 |
|--------|---------|------|
| lucene | 0.3 | 基于关键词匹配的评分 |
| vector | 0.7 | 基于向量相似度的评分 |
| feedback | 0.2 | 基于用户反馈的评分调整 |

#### 代码示例

```java
// 自动选择最佳策略检索
List<Document> docs = searchStrategyDispatcher.search(context);

// 指定策略检索
List<Document> docs = searchStrategyDispatcher.searchWithStrategy("keyword", context);

// 动态注册新策略
searchStrategyDispatcher.registerStrategy(new CustomSearchStrategy());

// 使用评分融合
Map<String, Double> scores = scoreFusionService.fuse(context);
```

---

## 九、HOPE 三层记忆架构（规划中）

> 参考 Google 论文：HOPE (High-frequency, Ordinary, Permanent Encoding)  
> 详细设计方案：[20251207-HOPE三层记忆架构设计方案.md](./20251207-HOPE三层记忆架构设计方案.md)

### 9.1 设计目标

借鉴人脑记忆机制，让知识库系统越来越智能：

| 目标 | 说明 | 预期效果 |
|------|------|---------|
| 减少 LLM 调用 | 简单问题直接回答 | 节省 40-60% API 成本 |
| 提升响应速度 | 技能知识即时返回 | 简单问题 < 100ms |
| 减少幻觉 | 确定性知识直接回答 | 提升 5% 准确率 |
| 持续学习 | 从反馈中积累知识 | 越用越智能 |

### 9.2 三层架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户问题输入                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
        ┌───────────────────┐  ┌───────────────────┐
        │   问题分类器       │  │   HOPE 三层查询    │
        │ (QuestionClassifier)│  │                   │
        └───────────────────┘  └───────────────────┘
                    │                   │
          ┌─────────┴─────────┬─────────┴─────────┐
          ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   低频层        │ │   中频层        │ │   高频层        │
│ (Permanent)     │ │ (Ordinary)      │ │ (High-freq)     │
│                 │ │                 │ │                 │
│ • 技能模板库    │ │ • 近期问答归档  │ │ • 会话上下文    │
│ • 确定性知识    │ │ • 新增文档知识  │ │ • 临时定义      │
│ • Prompt模板    │ │ • 用户偏好      │ │ • 实时更正      │
│                 │ │                 │ │                 │
│ 命中+高置信度   │ │ 命中→增强检索  │ │ 命中→上下文注入 │
│ → 直接回复 🚀   │ │ → 模板增强     │ │                 │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

### 9.3 响应策略

| 策略 | 触发条件 | 处理方式 | 响应时间 |
|------|---------|---------|---------|
| **直接回答** | 低频层命中 + 置信度 > 0.9 | 跳过 LLM，直接返回 | < 100ms |
| **模板增强** | 有技能模板 + 中等复杂度 | 使用优化 Prompt | 1-2s |
| **完整 RAG** | 需要推理 | 原有流程 | 2-5s |

### 9.4 知识生命周期

```
新问答产生 → 高频层(会话) → 正面反馈 → 中频层(30天) → 高频使用 → 低频层(永久)
                                ↓
                         负面反馈 → 丢弃
```

### 9.5 与现有系统集成点

| 现有组件 | 集成方式 | 说明 |
|---------|---------|------|
| `SimilarQAService` | 作为中频层数据源 | 历史高分问答 |
| `QARecordService` | 反馈学习入口 | 评分触发知识晋升 |
| `SearchCacheService` | 高频层缓存 | 扩展为会话上下文 |
| `KnowledgeQAService.ask()` | 主流程集成点 | 添加策略决策 |

### 9.6 实施路线图

| 阶段 | 任务 | 预计时间 |
|------|------|---------|
| Phase 1 | 低频层基础架构 + 直接回答 | 1-2 周 |
| Phase 2 | 中频层 + 知识晋升机制 | 1-2 周 |
| Phase 3 | 高频层 + 学习反馈 | 1 周 |
| Phase 4 | 优化与监控 | 持续 |

---

> 文档结束

