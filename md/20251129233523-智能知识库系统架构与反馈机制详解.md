# 智能知识库系统架构与反馈机制详解

> 文档生成时间：2025-11-29 23:35:23 (北京时间)
> 
> 作者：AI Reviewer Team

---

## 📋 目录

- [1. 系统概述](#1-系统概述)
- [2. 核心功能架构](#2-核心功能架构)
- [3. 混合检索机制详解](#3-混合检索机制详解)
- [4. 用户反馈系统详解](#4-用户反馈系统详解)
- [5. 动态权重调整机制](#5-动态权重调整机制)
- [6. 如何让知识库更智能](#6-如何让知识库更智能)
- [7. 完整工作流程](#7-完整工作流程)
- [8. 配置说明](#8-配置说明)
- [9. 未来优化建议](#9-未来优化建议)

---

## 1. 系统概述

### 1.1 系统定位

本系统是一个基于 **RAG (Retrieval-Augmented Generation)** 架构的智能知识库问答系统，结合了：

- **混合检索**：Lucene 关键词检索 + 向量语义检索
- **用户反馈闭环**：通过用户反馈持续优化检索质量
- **动态权重调整**：根据反馈动态调整文档相关性权重
- **智能文档处理**：支持多种文档格式，智能切分与索引

### 1.2 技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| 后端框架 | Spring Boot 3.x | 核心框架 |
| 全文检索 | Apache Lucene | 关键词检索 |
| 向量检索 | ONNX Runtime | 本地向量模型 |
| 文档解析 | Apache Tika | 多格式文档解析 |
| LLM 集成 | OpenAI API | 支持 DeepSeek/GPT-4 等 |
| 缓存 | Caffeine | 高性能本地缓存 |

---

## 2. 核心功能架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户界面                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 文档管理 │  │ 知识问答 │  │ 反馈管理 │  │ 配置管理 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                      REST API 层                             │
│  ┌────────────────────┐  ┌─────────────────────────────┐   │
│  │ KnowledgeQAController  │  FeedbackController         │   │
│  │ - 问答接口            │  - 反馈接口                  │   │
│  │ - 索引管理            │  - 统计接口                  │   │
│  └────────────────────┘  └─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                      业务服务层                              │
│  ┌──────────────────┐  ┌──────────────────────────────┐   │
│  │ KnowledgeQAService   │  HybridSearchService         │   │
│  │ - 问答逻辑          │  - 混合检索                   │   │
│  │ - 上下文构建        │  - 评分融合                   │   │
│  └──────────────────┘  └──────────────────────────────┘   │
│  ┌──────────────────┐  ┌──────────────────────────────┐   │
│  │ QARecordService     │  DocumentWeightService        │   │
│  │ - 问答记录管理      │  - 权重管理                   │   │
│  │ - 反馈处理          │  - 动态调整                   │   │
│  └──────────────────┘  └──────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                      RAG 核心层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ LocalFileRAG │  │ IndexEngine  │  │ VectorIndex  │     │
│  │ - 文档管理    │  │ - Lucene索引 │  │ - 向量索引   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ Parser       │  │ Chunker      │  │ Embedding    │     │
│  │ - 文档解析    │  │ - 智能切分   │  │ - 向量化     │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                      存储层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 文档存储     │  │ 索引存储     │  │ 反馈数据     │     │
│  │ ./data/      │  │ ./data/      │  │ ./data/      │     │
│  │ documents/   │  │ knowledge-   │  │ qa-records/  │     │
│  │              │  │ base/        │  │              │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据流程

#### 2.2.1 文档索引流程

```
文档上传 → 文档解析 → 内容提取 → 智能切分 → 向量化 → 
  ↓
索引构建（Lucene + 向量索引）→ 缓存 → 完成
```

#### 2.2.2 问答流程

```
用户提问 → 混合检索 → 评分排序 → 文档筛选 → 上下文构建 → 
  ↓
LLM 生成答案 → 返回用户 → 记录问答 → 等待反馈
```

#### 2.2.3 反馈流程

```
用户反馈 → 保存记录 → 判断是否需要审核 → 
  ↓                    ↓
  |                自动应用
  |                    ↓
审核队列          权重调整 → 影响下次检索
```

---

## 3. 混合检索机制详解

### 3.1 检索策略

系统采用 **三阶段混合检索**：

```
阶段1: Lucene 关键词检索 (粗筛)
  ↓ 候选集1 (lucene-top-k: 40)
  
阶段2: 向量语义检索 (精排)
  ↓ 候选集2 (vector-top-k: 40)
  
阶段3: 混合评分与去重 (融合)
  ↓ 最终结果 (hybrid-top-k: 20)
```

### 3.2 评分算法

#### 3.2.1 Lucene 归一化评分

```java
// Lucene 结果按排名归一化 (第1名=1.0，逐步降低)
luceneScore = 1.0 - (rank / totalResults)
```

示例：
- 第1名：1.0
- 第10名：0.75
- 第20名：0.50

#### 3.2.2 向量相似度评分

```java
// 向量检索使用余弦相似度 (0.0-1.0)
vectorScore = cosineSimilarity(queryVector, docVector)
```

#### 3.2.3 混合评分公式

```java
// 混合评分 = Lucene权重 * Lucene分 + 向量权重 * 向量分
hybridScore = 0.3 * luceneScore + 0.7 * vectorScore
```

**权重说明**：
- Lucene 权重：0.3 (关键词匹配，快速粗筛)
- 向量权重：0.7 (语义相似度，精确匹配)

#### 3.2.4 动态权重调整

```java
// 应用用户反馈后的最终评分
finalScore = hybridScore * documentWeight

// 文档权重根据反馈动态调整：
// - 初始权重：1.0
// - 点赞增量：+0.1 (可配置)
// - 踩踏减量：-0.15 (可配置)
// - 权重范围：[0.1, 2.0]
```

### 3.3 配置参数详解

| 参数 | 默认值 | 说明 | 影响 |
|------|--------|------|------|
| `lucene-top-k` | 40 | Lucene 检索返回的候选文档数 | 越大召回率越高，但计算量增加 |
| `vector-top-k` | 40 | 向量检索返回的候选文档数 | 越大语义匹配越全面 |
| `hybrid-top-k` | 20 | 混合后保留的最终文档数 | 这些文档可分批用于问答 |
| `documents-per-query` | 5 | 单次问答使用的文档数 | 控制上下文长度和响应速度 |
| `min-score-threshold` | 0.10 | 最低评分阈值 | 过滤低相关性文档 |
| `similarity-threshold` | 0.5 | 向量相似度阈值 | 向量检索的准入门槛 |

### 3.4 检索日志示例

```log
🔍 提取关键词: Agent
📚 Lucene检索找到 1 个文档 (总命中: 1)
   Lucene Top-10 文档（按相关性排序）:
      1. 培训通知.pdf - 316 字符 (Lucene 排名分: 1.000)

🎯 向量检索找到 40 个文档
   向量 Top-10 文档:
      - t0703.xls (相似度: 0.561)
      - t0702a.xls (相似度: 0.552)
      - l0704.xls (相似度: 0.549)

📊 混合评分 Top-5 (过滤前，阈值=0.1):
      ✅ 2. t0703.xls (评分: 0.393)
      ✅ 4. t0702a.xls (评分: 0.387)
      ✅ 5. l0704.xls (评分: 0.384)

🎲 混合评分 Top-20 (Lucene权重:0.3 + 向量权重:0.7):
   2. t0703.xls (混合分: 0.393 = Lucene排名#N/A + 向量:0.561)
   4. t0702a.xls (混合分: 0.387 = Lucene排名#N/A + 向量:0.552)
   5. l0704.xls (混合分: 0.384 = Lucene排名#N/A + 向量:0.549)

✅ 混合检索完成: 返回 10 个文档，耗时 93ms
```

---

## 4. 用户反馈系统详解

### 4.1 反馈类型

系统支持 **两种粒度** 的反馈：

#### 4.1.1 整体反馈

```json
{
  "recordId": "a1b2c3d4",
  "rating": 4,              // 1-5分
  "feedback": "回答很有帮助"  // 可选文字反馈
}
```

**用途**：
- 衡量整体问答质量
- 用于系统统计分析
- 不直接影响检索权重

#### 4.1.2 文档反馈

```json
{
  "recordId": "a1b2c3d4",
  "documentName": "培训通知.pdf",
  "feedbackType": "LIKE",    // LIKE 或 DISLIKE
  "reason": "内容非常相关"   // 可选原因
}
```

**用途**：
- **直接影响** 文档在检索中的权重
- 记录文档对特定问题的有效性
- 用于持续优化检索排序

### 4.2 反馈工作流程

```
┌─────────────────────────────────────────────────────┐
│                用户提交反馈                          │
└─────────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────┐
│           保存到 QARecord (JSON文件)                 │
│  路径: ./data/qa-records/yyyyMMdd/HHmmss_xxx.json   │
└─────────────────────────────────────────────────────┘
                       ↓
            ┌──────────┴──────────┐
            ↓                     ↓
  ┌──────────────────┐   ┌──────────────────┐
  │ require-approval │   │ require-approval │
  │     = true       │   │     = false      │
  └──────────────────┘   └──────────────────┘
            ↓                     ↓
  ┌──────────────────┐   ┌──────────────────┐
  │ 进入审核队列      │   │ 立即应用到权重    │
  │ status=PENDING   │   │ status=APPROVED  │
  └──────────────────┘   └──────────────────┘
            ↓                     ↓
  ┌──────────────────┐   ┌──────────────────┐
  │ 管理员审核        │   │ 更新文档权重      │
  │ APPROVED/REJECT  │   │ 影响下次检索      │
  └──────────────────┘   └──────────────────┘
            ↓                     
  ┌──────────────────┐            
  │ 应用到权重        │            
  └──────────────────┘            
```

### 4.3 QARecord 数据结构

```java
{
  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "question": "什么是 Agent？",
  "answer": "基于上下文的 AI 回答...",
  "timestamp": "2025-11-29T23:30:46",
  
  // 检索信息
  "retrievedDocuments": [        // 所有检索到的文档
    "t0703.xls", "t0702a.xls", ...
  ],
  "usedDocuments": [             // 实际用于生成答案的文档
    "t0703.xls", "t0702a.xls", "l0704.xls", "t0702.xls", "t0702c.xls"
  ],
  
  // 性能指标
  "responseTimeMs": 5234,
  
  // 整体反馈
  "overallRating": 4,
  "overallFeedback": "回答很有帮助",
  
  // 文档反馈
  "documentFeedbacks": [
    {
      "documentName": "t0703.xls",
      "feedbackType": "LIKE",
      "reason": "数据很准确",
      "feedbackTime": "2025-11-29T23:32:15"
    },
    {
      "documentName": "t0702a.xls",
      "feedbackType": "DISLIKE",
      "reason": "内容不相关",
      "feedbackTime": "2025-11-29T23:32:20"
    }
  ],
  
  // 审核状态
  "reviewStatus": "APPROVED",    // PENDING/APPROVED/REJECTED
  "appliedToOptimization": true  // 是否已应用到权重
}
```

### 4.4 存储结构

```
data/qa-records/
├── 20251129/
│   ├── 233046_a1b2c3d4.json    # 23:30:46 的问答记录
│   ├── 234125_f5e6d7c8.json
│   └── ...
├── 20251128/
│   └── ...
└── ...
```

**设计特点**：
- 按日期组织，便于管理和归档
- JSON 格式，易于查询和分析
- 文件名包含时间和 ID，快速定位

---

## 5. 动态权重调整机制

### 5.1 DocumentWeight 数据结构

```java
{
  "documentName": "培训通知.pdf",
  "weight": 1.15,              // 当前权重
  "likeCount": 3,              // 点赞次数
  "dislikeCount": 1,           // 踩踏次数
  "originalWeight": 1.0,       // 原始权重
  "lastUpdated": 1732896000000 // 最后更新时间
}
```

### 5.2 权重调整算法

```java
// 1. 初始权重
double weight = 1.0;

// 2. 用户点赞
if (feedbackType == LIKE) {
    weight += likeWeightIncrement;  // 默认 +0.1
}

// 3. 用户踩踏
if (feedbackType == DISLIKE) {
    weight += dislikeWeightDecrement;  // 默认 -0.15
}

// 4. 应用限制
weight = Math.max(minWeight, weight);  // 默认 >= 0.1
weight = Math.min(maxWeight, weight);  // 默认 <= 2.0
```

### 5.3 权重作用机制

#### 5.3.1 理论设计（待实现）

```java
// 在混合检索评分时应用权重
finalScore = hybridScore * getDocumentWeight(documentName);
```

#### 5.3.2 实际状态

**当前系统已经实现了完整的权重管理基础设施**：
- ✅ DocumentWeightService：权重存储和更新
- ✅ FeedbackController：反馈接口
- ✅ QARecordService：反馈处理和权重应用
- ❌ HybridSearchService：**尚未集成权重到评分计算**

**需要改进的地方**：

在 `HybridSearchService.hybridSearch()` 方法中的混合评分部分添加权重：

```java
// 当前代码（第3步）
for (var entry : hybridScores.entrySet()) {
    Document doc = rag.getDocument(entry.getKey());
    double score = entry.getValue();
    // 需要添加：
    double weight = documentWeightService.getDocumentWeight(doc.getTitle());
    double finalScore = score * weight;
}
```

### 5.4 权重示例

假设用户多次反馈同一文档：

| 操作 | 点赞数 | 踩踏数 | 权重计算 | 最终权重 |
|------|--------|--------|----------|----------|
| 初始 | 0 | 0 | 1.0 | 1.0 |
| 点赞 | 1 | 0 | 1.0 + 0.1 | 1.1 |
| 点赞 | 2 | 0 | 1.1 + 0.1 | 1.2 |
| 踩踏 | 2 | 1 | 1.2 - 0.15 | 1.05 |
| 点赞 | 3 | 1 | 1.05 + 0.1 | 1.15 |

### 5.5 权重持久化

```
data/document-weights.json
```

```json
{
  "培训通知.pdf": {
    "documentName": "培训通知.pdf",
    "weight": 1.15,
    "likeCount": 3,
    "dislikeCount": 1,
    "originalWeight": 1.0,
    "lastUpdated": 1732896000000
  },
  "产品手册.docx": {
    "documentName": "产品手册.docx",
    "weight": 0.85,
    "likeCount": 1,
    "dislikeCount": 2,
    "originalWeight": 1.0,
    "lastUpdated": 1732896100000
  }
}
```

---

## 6. 如何让知识库更智能

### 6.1 当前反馈闭环

```
用户提问 → 检索文档 → AI回答 → 用户反馈 → 权重调整 → 
  ↑                                                    ↓
  └────────────────── 下次检索更准确 ←─────────────────┘
```

**优点**：
- ✅ 直接利用用户反馈
- ✅ 无需重新索引
- ✅ 实时生效

**局限**：
- ❌ 只影响检索排序，不增加新知识
- ❌ 每个问答是独立的，无法累积知识

### 6.2 建议：将问答归档为新知识

#### 6.2.1 核心思路

**将每次高质量的问答对转化为新的知识文档**，持续丰富知识库：

```
优质问答 → 构建新文档 → 索引到知识库 → 未来可被检索
```

#### 6.2.2 实现方案

##### 方案A：自动归档（推荐）

```java
// 在 KnowledgeQAService.answer() 方法中
public String answer(String question) {
    // ... 现有逻辑 ...
    String answer = llmClient.chat(prompt);
    
    // 保存问答记录
    String recordId = qaRecordService.saveRecord(record);
    
    // ✨ 新增：自动归档高质量问答
    if (shouldArchiveAsKnowledge(question, answer)) {
        archiveAsKnowledgeDocument(question, answer, usedDocuments);
    }
    
    return answer;
}

// 判断是否应该归档
private boolean shouldArchiveAsKnowledge(String question, String answer) {
    // 策略1: 问题长度 > 10字
    if (question.length() < 10) return false;
    
    // 策略2: 回答长度 > 50字
    if (answer.length() < 50) return false;
    
    // 策略3: 不是简单的"无法回答"
    if (answer.contains("无法回答") || answer.contains("没有相关信息")) {
        return false;
    }
    
    return true;
}

// 归档为新文档
private void archiveAsKnowledgeDocument(String question, String answer, 
                                       List<Document> sources) {
    // 构建新文档内容
    StringBuilder content = new StringBuilder();
    content.append("# ").append(question).append("\n\n");
    content.append("## 回答\n\n").append(answer).append("\n\n");
    content.append("## 来源文档\n\n");
    for (Document doc : sources) {
        content.append("- ").append(doc.getTitle()).append("\n");
    }
    content.append("\n---\n");
    content.append("生成时间: ").append(LocalDateTime.now()).append("\n");
    
    // 保存到知识库
    String fileName = String.format("%s-QA-%s.md", 
        LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMddHHmmss")),
        question.substring(0, Math.min(20, question.length()))
    );
    
    Path knowledgePath = Paths.get("./data/rag", fileName);
    Files.writeString(knowledgePath, content.toString());
    
    // 增量索引新文档
    knowledgeBaseService.incrementalIndexFile(knowledgePath);
    
    log.info("📚 归档问答为新知识: {}", fileName);
}
```

##### 方案B：基于反馈归档（更保守）

仅在用户给出高评分（4-5分）时才归档：

```java
// 在 QARecordService.addOverallFeedback() 中
public boolean addOverallFeedback(String recordId, int rating, String feedback) {
    // ... 现有逻辑 ...
    
    // ✨ 新增：高评分问答自动归档
    if (rating >= 4 && feedbackConfig.isEnableAutoArchive()) {
        archiveHighQualityQA(record);
    }
    
    return updateRecord(record);
}
```

#### 6.2.3 归档文档示例

```markdown
# 什么是 Agent？

## 回答

Agent 是一种智能代理系统，具有以下特点：

1. **自主性**：能够独立做出决策和执行任务
2. **反应性**：能够感知环境变化并做出响应
3. **主动性**：能够主动采取行动以达成目标
4. **社交性**：能够与其他 Agent 或用户交互

在本系统中，Agent 可用于自动化知识库管理、智能问答等场景。

## 来源文档

- 培训通知.pdf
- AI系统架构文档.docx
- 技术白皮书.pdf

---
生成时间: 2025-11-29 23:30:46
评分: 5 分
用户反馈: 回答非常详细和准确
```

#### 6.2.4 配置选项

```yaml
# application.yml
knowledge:
  qa:
    # 问答归档配置
    qa-archive:
      # 是否启用自动归档
      enabled: true
      
      # 归档策略
      # auto: 自动归档所有问答
      # feedback-based: 基于用户反馈（评分>=4）
      # manual: 手动审核后归档
      strategy: feedback-based
      
      # 最低评分阈值（feedback-based 模式）
      min-rating: 4
      
      # 问题最短长度（字符数）
      min-question-length: 10
      
      # 回答最短长度（字符数）
      min-answer-length: 50
      
      # 归档路径
      archive-path: ./data/rag
      
      # 是否自动索引归档的文档
      auto-index: true
```

### 6.3 其他智能化建议

#### 6.3.1 相似问题推荐

```java
// 当用户提问时，推荐历史相似问题
List<QARecord> similarQuestions = findSimilarQuestions(question, 5);
if (!similarQuestions.isEmpty()) {
    response.setSimilarQuestions(similarQuestions);
}
```

#### 6.3.2 热门问题统计

```java
// 统计高频问题，生成 FAQ
Map<String, Integer> questionFrequency = 
    qaRecordService.getQuestionFrequency(30); // 最近30天
```

#### 6.3.3 知识图谱构建

```
问题 ----关联----> 文档
  ↓                 ↓
用户反馈         知识点
  ↓                 ↓
权重调整         关系网络
```

#### 6.3.4 自动文档摘要

对归档的问答生成结构化摘要：

```markdown
**问题类型**: 概念解释
**领域**: 人工智能
**关键词**: Agent, 自主性, 智能代理
**相关文档**: 3个
**参考次数**: 12次
**平均评分**: 4.5
```

---

## 7. 完整工作流程

### 7.1 用户问答流程（带反馈）

```
┌────────────────────────────────────────────────────────────────┐
│ 步骤1: 用户提问                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ POST /api/qa/answer                                            │
│ { "question": "什么是 Agent？" }                               │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤2: 混合检索                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 2.1 Lucene 关键词检索 → 40 个候选文档                          │
│ 2.2 向量语义检索 → 40 个候选文档                               │
│ 2.3 混合评分 + 去重 → 20 个文档                                │
│ 2.4 应用文档权重 → 调整排序                                     │
│ 2.5 过滤低分文档 → 10 个高质量文档                              │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤3: 分批处理                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 取前 5 个文档（documents-per-query）                            │
│ 剩余 5 个文档保留，用户可通过 next 接口继续                      │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤4: 智能上下文构建                                            │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 4.1 关键词提取（从问题中）                                       │
│ 4.2 文档切分（Smart Keyword Chunker）                           │
│ 4.3 提取相关片段（包含关键词的部分）                              │
│ 4.4 控制总长度（max-context-length: 20000）                     │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤5: LLM 生成答案                                             │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 使用 Prompt 模板构建请求                                        │
│ 调用 DeepSeek/GPT-4 API                                        │
│ 生成基于上下文的答案                                             │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤6: 返回答案 + 保存记录                                       │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ {                                                              │
│   "answer": "...",                                             │
│   "recordId": "a1b2c3d4",                                      │
│   "usedDocuments": ["doc1", "doc2", ...],                     │
│   "remainingDocuments": 5                                      │
│ }                                                              │
│                                                                │
│ 保存到: ./data/qa-records/20251129/233046_a1b2c3d4.json       │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤7: 用户反馈（可选）                                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 7A. 整体反馈                                                    │
│ POST /api/feedback/overall                                     │
│ { "recordId": "a1b2c3d4", "rating": 4, "feedback": "..." }    │
│                                                                │
│ 7B. 文档反馈                                                    │
│ POST /api/feedback/document                                    │
│ {                                                              │
│   "recordId": "a1b2c3d4",                                      │
│   "documentName": "培训通知.pdf",                              │
│   "feedbackType": "LIKE"                                       │
│ }                                                              │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤8: 权重调整（自动）                                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ if (require-approval == false && auto-apply == true) {         │
│   documentWeightService.applyFeedback(documentName, LIKE);    │
│   // 培训通知.pdf 权重: 1.0 → 1.1                              │
│ }                                                              │
│                                                                │
│ 保存到: ./data/document-weights.json                           │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│ 步骤9: 下次检索自动生效                                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 下次检索 "培训通知.pdf" 时：                                    │
│ finalScore = hybridScore * 1.1  （权重已提升）                  │
│ → 排序更靠前 → 更容易被使用                                     │
└────────────────────────────────────────────────────────────────┘
```

### 7.2 关键时序图

```
用户        前端         后端              RAG           LLM         存储
 │          │           │                 │             │           │
 │─问题───→│           │                 │             │           │
 │          │─API请求→│                 │             │           │
 │          │           │─混合检索───────→│             │           │
 │          │           │                 │─Lucene─────→           │
 │          │           │                 │─Vector─────→           │
 │          │           │←返回20个文档────│             │           │
 │          │           │─取前5个文档─────│             │           │
 │          │           │─构建上下文──────│             │           │
 │          │           │─生成答案───────────────────→│           │
 │          │           │←返回答案────────────────────│           │
 │          │           │─保存记录──────────────────────────────→│
 │          │←返回答案──│                 │             │           │
 │←显示答案─│           │                 │             │           │
 │          │           │                 │             │           │
 │─点赞文档─→           │                 │             │           │
 │          │─反馈请求→│                 │             │           │
 │          │           │─更新记录──────────────────────────────→│
 │          │           │─调整权重──────────────────────────────→│
 │          │←反馈成功──│                 │             │           │
 │←提示成功─│           │                 │             │           │
```

---

## 8. 配置说明

### 8.1 核心配置项

#### 8.1.1 混合检索配置

```yaml
knowledge:
  qa:
    vector-search:
      # Lucene 检索的候选文档数（粗筛）
      lucene-top-k: 40
      
      # 向量检索的候选文档数（精排）
      vector-top-k: 40
      
      # 混合后保留的最终文档数（去重后）
      hybrid-top-k: 20
      
      # 单次问答使用的文档数
      documents-per-query: 5
      
      # 最低评分阈值（过滤低相关性文档）
      min-score-threshold: 0.10
```

**调优建议**：

| 场景 | lucene-top-k | vector-top-k | hybrid-top-k | documents-per-query |
|------|--------------|--------------|--------------|---------------------|
| 快速响应 | 20 | 20 | 10 | 3 |
| 平衡（推荐） | 40 | 40 | 20 | 5 |
| 高召回率 | 100 | 100 | 50 | 10 |

#### 8.1.2 反馈配置

```yaml
feedback:
  # 是否需要审核才能生效（false = 直接生效）
  require-approval: false
  
  # 是否自动应用反馈到检索优化
  auto-apply: true
  
  # 点赞权重增量
  like-weight-increment: 0.1
  
  # 踩的权重减量
  dislike-weight-decrement: -0.15
  
  # 权重限制
  min-weight: 0.1
  max-weight: 2.0
  
  # 是否启用动态权重调整
  enable-dynamic-weighting: true
```

**生产环境建议**：
- `require-approval: true` （需审核，更安全）
- `auto-apply: false` （手动应用，可控）

**开发/测试环境**：
- `require-approval: false` （直接生效，快速迭代）
- `auto-apply: true` （自动应用，方便测试）

#### 8.1.3 LLM 配置

```yaml
knowledge:
  qa:
    llm:
      # 单次问答最大文档数
      max-documents-per-query: 5
      
      # 最大上下文长度（字符数）
      max-context-length: 20000
      
      # 单文档最大长度（字符数）
      max-doc-length: 5000
```

### 8.2 REST API 接口

#### 8.2.1 问答接口

```http
POST /api/qa/answer
Content-Type: application/json

{
  "question": "什么是 Agent？"
}
```

**响应**：
```json
{
  "success": true,
  "answer": "Agent 是...",
  "recordId": "a1b2c3d4-e5f6-7890",
  "usedDocuments": ["doc1.pdf", "doc2.docx"],
  "remainingDocuments": 5,
  "metadata": {
    "totalRetrieved": 20,
    "responseTime": "5234ms",
    "model": "deepseek-chat"
  }
}
```

#### 8.2.2 反馈接口

**整体反馈**：
```http
POST /api/feedback/overall
Content-Type: application/json

{
  "recordId": "a1b2c3d4",
  "rating": 4,
  "feedback": "回答很有帮助"
}
```

**文档反馈**：
```http
POST /api/feedback/document
Content-Type: application/json

{
  "recordId": "a1b2c3d4",
  "documentName": "培训通知.pdf",
  "feedbackType": "LIKE",
  "reason": "内容非常相关"
}
```

#### 8.2.3 配置管理接口

```http
# 获取当前配置
GET /api/feedback/config

# 更新配置
POST /api/feedback/config
{
  "requireApproval": false,
  "likeWeightIncrement": 0.15
}
```

#### 8.2.4 统计接口

```http
# 问答统计
GET /api/feedback/statistics

# 文档权重统计
GET /api/feedback/config/weights
```

---

## 9. 未来优化建议

### 9.1 短期优化（1-2周）

#### ✅ 优先级：高

1. **完善权重应用到检索评分**
   - 在 `HybridSearchService` 中集成 `DocumentWeightService`
   - 修改混合评分公式：`finalScore = hybridScore * documentWeight`

2. **实现问答归档功能**
   - 基于反馈自动归档高质量问答
   - 增量索引归档的文档

3. **修复文档获取失败问题**
   - 日志中显示 "无法获取文档ID"
   - 检查文档缓存和索引的一致性

### 9.2 中期优化（1个月）

#### ✅ 优先级：中

1. **相似问题推荐**
   - 使用向量检索查找历史相似问题
   - 展示给用户参考

2. **热门问题 FAQ**
   - 统计高频问题
   - 自动生成 FAQ 页面

3. **问答质量评估**
   - 基于反馈数据训练评估模型
   - 自动识别低质量回答

4. **A/B 测试框架**
   - 测试不同的权重参数
   - 测试不同的 Prompt 模板

### 9.3 长期优化（3-6个月）

#### ✅ 优先级：中低

1. **知识图谱**
   - 构建问题-文档-概念的关系网络
   - 图数据库存储（Neo4j）

2. **多模态支持**
   - 图片内容理解（已有基础）
   - 表格智能解析
   - PDF 布局分析

3. **协同过滤**
   - 基于用户行为的推荐
   - 文档相关性学习

4. **强化学习**
   - 基于反馈持续优化检索策略
   - 动态调整 Lucene/Vector 权重比例

### 9.4 性能优化

1. **缓存优化**
   - 热门问题结果缓存
   - 向量嵌入缓存

2. **并行处理**
   - Lucene 和向量检索并行执行
   - 多文档并行切分

3. **索引优化**
   - 增量索引优化
   - 定期索引压缩和重建

---

## 10. 总结

### 10.1 系统优势

1. ✅ **混合检索**：结合关键词和语义，召回率和精确率兼顾
2. ✅ **反馈闭环**：用户反馈直接影响检索质量
3. ✅ **分批处理**：支持大量文档的渐进式探索
4. ✅ **灵活配置**：所有参数可通过 YAML 或 API 动态调整
5. ✅ **完善日志**：详细的检索过程日志，便于调试

### 10.2 关键机制总结

| 机制 | 作用 | 生效时机 |
|------|------|----------|
| 混合检索 | 融合关键词和语义检索 | 每次问答 |
| 动态权重 | 根据反馈调整文档排序 | 下次检索 |
| 分批处理 | 控制上下文长度和响应速度 | 每次问答 |
| 问答归档 | 将问答转化为新知识 | 高评分后 |
| 审核机制 | 确保反馈质量 | 可选 |

### 10.3 如何让知识库更智能

```
当前: 反馈 → 权重调整 → 检索优化
未来: 反馈 → 权重调整 + 知识归档 → 检索优化 + 知识增长
                                   ↓
                            知识图谱 + 协同过滤
```

**核心思想**：
- **短期**：优化检索排序（已实现 90%）
- **中期**：积累结构化知识（问答归档）
- **长期**：知识推理与生成（知识图谱）

---

## 附录

### A. 数据流转图

```
文档上传
  ↓
解析 → 切分 → 向量化 → 索引
  ↓      ↓       ↓        ↓
Tika  Chunker  ONNX   Lucene+Vector
                            ↓
                        知识库
                            ↓
用户提问 → 混合检索 → 评分排序 → 文档筛选
                        ↓
                  应用文档权重
                        ↓
                  构建上下文 → LLM → 答案
                        ↓
                  保存问答记录
                        ↓
                  用户反馈
                        ↓
        ┌───────────────┴───────────────┐
        ↓                               ↓
   整体反馈                         文档反馈
 (rating 1-5)                    (LIKE/DISLIKE)
        ↓                               ↓
  统计分析                          权重调整
                                      ↓
                              影响下次检索
```

### B. 文件结构速查

```
data/
├── documents/              # 原始文档
├── knowledge-base/         # Lucene 索引
├── vector-index/           # 向量索引
├── qa-records/            # 问答记录
│   └── yyyyMMdd/          # 按日期组织
│       └── HHmmss_xxx.json
├── document-weights.json  # 文档权重
└── rag/                   # 归档的问答知识（建议）

logs/
└── app.log                # 应用日志

md/
└── yyyyMMddHHmmss-*.md    # 分析报告
```

### C. 关键类速查

| 类名 | 职责 | 路径 |
|------|------|------|
| `KnowledgeQAService` | 问答核心逻辑 | `service/` |
| `HybridSearchService` | 混合检索 | `service/` |
| `QARecordService` | 问答记录管理 | `feedback/` |
| `DocumentWeightService` | 权重管理 | `feedback/` |
| `FeedbackController` | 反馈 API | `controller/` |
| `LocalFileRAG` | RAG 核心 | `service/` |

---

**文档版本**：v1.0
**最后更新**：2025-11-29 23:35:23
**维护者**：AI Reviewer Team

