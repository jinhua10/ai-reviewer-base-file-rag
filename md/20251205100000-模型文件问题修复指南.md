# ğŸ”§ æ¨¡å‹æ–‡ä»¶é—®é¢˜ä¿®å¤æŒ‡å—

## ğŸ“… åˆ›å»ºæ—¶é—´
2025-12-05 10:00:00

## ğŸ¯ é—®é¢˜æè¿°

### ç—‡çŠ¶
åº”ç”¨å¯åŠ¨æ—¶å‡ºç°é”™è¯¯ï¼š
```
ai.onnxruntime.OrtException: Error code - ORT_RUNTIME_EXCEPTION
Exception during initialization: file_size: ç³»ç»Ÿæ‰¾ä¸åˆ°æŒ‡å®šçš„æ–‡ä»¶ã€‚
"D:\Jetbrains\hackathon\ai-reviewer-base-file-rag\.\models\bge-base-zh\model.onnx.data"
```

### æ ¹æœ¬åŸå› 
**embedding æ¨¡å‹æ–‡ä»¶ä¸å®Œæ•´**

æ£€æŸ¥å‘ç°ï¼š
- âŒ `bge-base-zh/model.onnx` - **ä»… 1.2 MB**ï¼ˆä¸å®Œæ•´ï¼‰
- âŒ `bge-m3/model.onnx` - **ä»… 2.7 MB**ï¼ˆä¸å®Œæ•´ï¼‰
- âŒ **ç¼ºå°‘** `model.onnx_data` æ–‡ä»¶ï¼ˆåŒ…å«æ¨¡å‹æƒé‡ï¼‰

å®Œæ•´çš„ ONNX æ¨¡å‹åº”è¯¥åŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼š
1. `model.onnx` - æ¨¡å‹ç»“æ„ï¼ˆå°æ–‡ä»¶ï¼Œå‡ MBï¼‰
2. `model.onnx_data` - æ¨¡å‹æƒé‡ï¼ˆå¤§æ–‡ä»¶ï¼Œå‡ ç™¾MBåˆ°å‡ GBï¼‰

---

## âœ… å·²å®æ–½çš„ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šç¦ç”¨å‘é‡æœç´¢ï¼Œä½¿ç”¨çº¯æ–‡æœ¬æœç´¢

**ä¿®æ”¹å†…å®¹**ï¼š

1. **application.yml**
```yaml
vector-search:
  enabled: false  # ç¦ç”¨å‘é‡æœç´¢
```

2. **KnowledgeQAService.java**
```java
// å‘é‡æœç´¢åˆå§‹åŒ–å¤±è´¥æ—¶ä¸æŠ›å‡ºå¼‚å¸¸
// ç³»ç»Ÿç»§ç»­è¿è¡Œï¼Œä½¿ç”¨ Lucene æ–‡æœ¬æœç´¢
```

**æ•ˆæœ**ï¼š
- âœ… åº”ç”¨å¯ä»¥æ­£å¸¸å¯åŠ¨
- âœ… æ–‡æ¡£ç´¢å¼•åŠŸèƒ½æ­£å¸¸
- âœ… é—®ç­”åŠŸèƒ½æ­£å¸¸ï¼ˆä½¿ç”¨å…³é”®è¯åŒ¹é…ï¼‰
- âš ï¸ æ— è¯­ä¹‰å‘é‡æœç´¢ï¼ˆç›¸å…³æ€§å¯èƒ½ç•¥ä½ï¼‰

---

## ğŸ”§ å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šä¸‹è½½å®Œæ•´çš„ BGE-Base-ZH ONNX æ¨¡å‹ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1ï¼šä¸‹è½½æ¨¡å‹æ–‡ä»¶

ä»ä»¥ä¸‹æ¥æºä¸‹è½½å®Œæ•´çš„ ONNX æ¨¡å‹ï¼š

**é€‰é¡¹ 1ï¼šHugging Face**
```bash
# ä½¿ç”¨ huggingface-cli ä¸‹è½½
huggingface-cli download BAAI/bge-base-zh-v1.5 \
  --include "onnx/*" \
  --local-dir ./models/bge-base-zh
```

**é€‰é¡¹ 2ï¼šModelScopeï¼ˆå›½å†…æ¨èï¼‰**
```bash
# ä½¿ç”¨ modelscope ä¸‹è½½
pip install modelscope
modelscope download --model BAAI/bge-base-zh-v1.5 \
  --include onnx
```

**é€‰é¡¹ 3ï¼šæ‰‹åŠ¨ä¸‹è½½**
1. è®¿é—®ï¼šhttps://huggingface.co/BAAI/bge-base-zh-v1.5
2. ä¸‹è½½ä»¥ä¸‹æ–‡ä»¶ï¼š
   - `model.onnx`
   - `model.onnx_data`ï¼ˆçº¦ 400MBï¼‰
   - `tokenizer.json`
   - `config.json`

#### æ­¥éª¤ 2ï¼šæ”¾ç½®æ–‡ä»¶
å°†ä¸‹è½½çš„æ–‡ä»¶æ”¾åˆ°ï¼š
```
models/
  â””â”€ bge-base-zh/
      â”œâ”€ model.onnx
      â”œâ”€ model.onnx_data  â† é‡è¦ï¼
      â”œâ”€ tokenizer.json
      â””â”€ config.json
```

#### æ­¥éª¤ 3ï¼šå¯ç”¨å‘é‡æœç´¢
ä¿®æ”¹ `application.yml`ï¼š
```yaml
vector-search:
  enabled: true  # å¯ç”¨å‘é‡æœç´¢
  model:
    name: bge-base-zh
    path: ./models/bge-base-zh/model.onnx
```

#### æ­¥éª¤ 4ï¼šé‡å¯åº”ç”¨
```powershell
mvn spring-boot:run
```

---

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ OpenAI Embedding API

å¦‚æœæœ‰ OpenAI API Keyï¼Œå¯ä»¥ä½¿ç”¨äº‘ç«¯ embeddingï¼š

#### æ­¥éª¤ 1ï¼šé…ç½® API Key
åœ¨ `application.yml` ä¸­æ·»åŠ ï¼š
```yaml
vector-search:
  enabled: true
  provider: openai
  openai:
    api-key: sk-your-api-key-here
    model: text-embedding-3-small
```

#### æ­¥éª¤ 2ï¼šæ·»åŠ ä¾èµ–
åœ¨ `pom.xml` ä¸­ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š
```xml
<dependency>
    <groupId>com.theokanning.openai-gpt3-java</groupId>
    <artifactId>service</artifactId>
    <version>0.18.2</version>
</dependency>
```

---

### æ–¹æ¡ˆ Cï¼šè½¬æ¢ç°æœ‰çš„ PyTorch æ¨¡å‹ä¸º ONNX

å¦‚æœå·²æœ‰ `model.safetensors` æˆ– `pytorch_model.bin`ï¼š

#### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–
```bash
pip install transformers onnx torch optimum
```

#### æ­¥éª¤ 2ï¼šè½¬æ¢æ¨¡å‹
```python
from optimum.onnxruntime import ORTModelForFeatureExtraction
from transformers import AutoTokenizer

model_path = "./models/bge-base-zh"
onnx_path = "./models/bge-base-zh-onnx"

# åŠ è½½å¹¶è½¬æ¢æ¨¡å‹
model = ORTModelForFeatureExtraction.from_pretrained(
    model_path, 
    export=True
)
tokenizer = AutoTokenizer.from_pretrained(model_path)

# ä¿å­˜ ONNX æ¨¡å‹
model.save_pretrained(onnx_path)
tokenizer.save_pretrained(onnx_path)
```

#### æ­¥éª¤ 3ï¼šå¤åˆ¶æ–‡ä»¶
```powershell
Copy-Item "models/bge-base-zh-onnx/*" "models/bge-base-zh/" -Force
```

---

## ğŸ“Š å¯¹æ¯”ï¼šå„æ–¹æ¡ˆä¼˜ç¼ºç‚¹

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **å½“å‰æ–¹æ¡ˆ**<br>ç¦ç”¨å‘é‡æœç´¢ | â€¢ ç«‹å³å¯ç”¨<br>â€¢ æ— éœ€ä¸‹è½½<br>â€¢ ç³»ç»Ÿç¨³å®š | â€¢ æœç´¢è´¨é‡ç•¥ä½<br>â€¢ æ— è¯­ä¹‰ç†è§£ | â­â­â­ |
| **æ–¹æ¡ˆ A**<br>ä¸‹è½½ ONNX æ¨¡å‹ | â€¢ å®Œå…¨æœ¬åœ°åŒ–<br>â€¢ æ— APIè´¹ç”¨<br>â€¢ éšç§ä¿æŠ¤ | â€¢ éœ€ä¸‹è½½ 400MB<br>â€¢ å ç”¨ç£ç›˜ç©ºé—´ | â­â­â­â­â­ |
| **æ–¹æ¡ˆ B**<br>OpenAI API | â€¢ æ— éœ€ä¸‹è½½<br>â€¢ è´¨é‡æœ€é«˜<br>â€¢ ç»´æŠ¤ç®€å• | â€¢ éœ€APIè´¹ç”¨<br>â€¢ ä¾èµ–ç½‘ç»œ<br>â€¢ æ•°æ®ä¸Šä¼  | â­â­â­â­ |
| **æ–¹æ¡ˆ C**<br>è½¬æ¢æ¨¡å‹ | â€¢ ä½¿ç”¨ç°æœ‰æ–‡ä»¶<br>â€¢ è‡ªå®šä¹‰ä¼˜åŒ– | â€¢ éœ€Pythonç¯å¢ƒ<br>â€¢ æŠ€æœ¯è¦æ±‚é«˜ | â­â­â­ |

---

## ğŸ” æ¨¡å‹æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥

### æ£€æŸ¥è„šæœ¬
```powershell
# æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
Get-ChildItem "D:\Jetbrains\hackathon\ai-reviewer-base-file-rag\models" -Recurse | 
Where-Object { $_.Name -like "*.onnx*" } | 
Select-Object Name, Length, Directory | 
Format-Table -AutoSize
```

### é¢„æœŸç»“æœï¼ˆå®Œæ•´æ¨¡å‹ï¼‰
```
Name              Length        Directory
----              ------        ---------
model.onnx        ~2-5 MB       models/bge-base-zh
model.onnx_data   ~400 MB       models/bge-base-zh  â† å¿…é¡»å­˜åœ¨ï¼
```

### å½“å‰çŠ¶æ€ï¼ˆä¸å®Œæ•´ï¼‰
```
Name              Length        Directory
----              ------        ---------
model.onnx        1.2 MB        models/bge-base-zh  â† å¤ªå°ï¼
(ç¼ºå°‘ model.onnx_data)                              â† ä¸¢å¤±ï¼
```

---

## ğŸš€ å¿«é€Ÿä¿®å¤å‘½ä»¤

### é€‰é¡¹ 1ï¼šç¦ç”¨å‘é‡æœç´¢ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰
```powershell
# å·²ç»åœ¨ application.yml ä¸­è®¾ç½®
# vector-search.enabled: false
# é‡å¯åº”ç”¨å³å¯
mvn spring-boot:run
```

### é€‰é¡¹ 2ï¼šä½¿ç”¨å›½å†…é•œåƒä¸‹è½½æ¨¡å‹
```bash
# ä½¿ç”¨ ModelScope CLI
pip install modelscope
modelscope download --model ZhipuAI/bge-base-zh-v1.5 \
  --cache_dir ./models
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `src/main/resources/application.yml`
   - è®¾ç½® `vector-search.enabled: false`

2. `src/main/java/top/yumbo/ai/rag/spring/boot/service/KnowledgeQAService.java`
   - å‘é‡æœç´¢å¤±è´¥æ—¶ä¸æŠ›å‡ºå¼‚å¸¸
   - æ·»åŠ è¯¦ç»†çš„é”™è¯¯æç¤º

### éœ€è¦ä¿®å¤çš„æ–‡ä»¶ï¼ˆå®Œæ•´æ–¹æ¡ˆï¼‰
1. `models/bge-base-zh/model.onnx` - éœ€è¦é‡æ–°ä¸‹è½½
2. `models/bge-base-zh/model.onnx_data` - **ç¼ºå¤±ï¼Œå¿…é¡»ä¸‹è½½**
3. `models/bge-m3/model.onnx` - éœ€è¦é‡æ–°ä¸‹è½½
4. `models/bge-m3/model.onnx_data` - **ç¼ºå¤±ï¼Œå¿…é¡»ä¸‹è½½**

---

## âœ… éªŒè¯æ­¥éª¤

### 1. éªŒè¯å½“å‰æ–¹æ¡ˆï¼ˆæ–‡æœ¬æœç´¢ï¼‰
```powershell
# å¯åŠ¨åº”ç”¨
mvn spring-boot:run

# åº”è¯¥çœ‹åˆ°æ—¥å¿—ï¼š
# âœ… çŸ¥è¯†åº“æ„å»ºå®Œæˆ
# âš ï¸ å‘é‡æœç´¢åˆå§‹åŒ–å¤±è´¥ï¼Œç³»ç»Ÿå°†ä»…ä½¿ç”¨æ–‡æœ¬æœç´¢åŠŸèƒ½
# âœ… Started Application
```

### 2. æµ‹è¯•æœç´¢åŠŸèƒ½
```bash
curl http://localhost:8080/api/knowledge-base/search?question=æµ‹è¯•
# åº”è¯¥è¿”å›æœç´¢ç»“æœï¼ˆåŸºäºå…³é”®è¯ï¼‰
```

### 3. éªŒè¯å®Œæ•´æ–¹æ¡ˆï¼ˆå¦‚å·²ä¿®å¤ï¼‰
```
# åº”è¯¥çœ‹åˆ°æ—¥å¿—ï¼š
# âœ… å‘é‡æœç´¢å¼•æ“å·²åŠ è½½
# âœ… æ¨¡å‹ï¼šbge-base-zh
# âœ… å‘é‡ç»´åº¦ï¼š768
# âœ… å·²åŠ è½½å‘é‡ç´¢å¼•ï¼Œæ–‡æ¡£æ•°ï¼šxxx
```

---

## ğŸ¯ æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… **åº”ç”¨å¯ä»¥å¯åŠ¨**
- âœ… **æ–‡æ¡£ç´¢å¼•åŠŸèƒ½æ­£å¸¸**
- âœ… **é—®ç­”åŠŸèƒ½å¯ç”¨**ï¼ˆåŸºäºæ–‡æœ¬æœç´¢ï¼‰
- âš ï¸ **å‘é‡æœç´¢å·²ç¦ç”¨**ï¼ˆæ¨¡å‹æŸåï¼‰

### æ€§èƒ½å½±å“
| åŠŸèƒ½ | å½“å‰çŠ¶æ€ | å®Œæ•´æ–¹æ¡ˆ |
|------|----------|----------|
| æ–‡æ¡£ä¸Šä¼  | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| å…³é”®è¯æœç´¢ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| è¯­ä¹‰æœç´¢ | âŒ ä¸å¯ç”¨ | âœ… å¯ç”¨ |
| æœç´¢è´¨é‡ | â­â­â­ | â­â­â­â­â­ |
| å“åº”é€Ÿåº¦ | å¿« | ä¸­ç­‰ |

### å»ºè®®
1. **çŸ­æœŸ**ï¼šä½¿ç”¨å½“å‰æ–¹æ¡ˆï¼ˆæ–‡æœ¬æœç´¢ï¼‰ï¼Œç³»ç»Ÿå®Œå…¨å¯ç”¨
2. **é•¿æœŸ**ï¼šæŒ‰æ–¹æ¡ˆ A ä¸‹è½½å®Œæ•´çš„ ONNX æ¨¡å‹ï¼Œè·å¾—æœ€ä½³ä½“éªŒ
3. **æ›¿ä»£**ï¼šå¦‚æœ‰ API Keyï¼Œå¯è€ƒè™‘æ–¹æ¡ˆ Bï¼ˆOpenAI Embeddingï¼‰

---

**å®Œæˆæ—¶é—´**: 2025-12-05 10:00:00  
**çŠ¶æ€**: âœ… **åº”ç”¨å·²å¯æ­£å¸¸å¯åŠ¨ï¼**  
**ä¿®å¤æ–¹æ¡ˆ**: ç¦ç”¨å‘é‡æœç´¢ + ä½¿ç”¨æ–‡æœ¬æœç´¢  
**åç»­ä¼˜åŒ–**: ä¸‹è½½å®Œæ•´ ONNX æ¨¡å‹ï¼ˆå¯é€‰ï¼‰

