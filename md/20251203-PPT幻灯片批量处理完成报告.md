# PPT å¹»ç¯ç‰‡æ‰¹é‡å¤„ç†å®ç°å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ éœ€æ±‚åˆ†æ

ä½ çš„éœ€æ±‚ï¼š
1. âœ… **ä»¥å¹»ç¯ç‰‡ä¸ºæœ€å°å•ä½**å¤„ç† PPT
2. âœ… **æ”¯æŒæ‰¹é‡å¤„ç†å¤šå¼ å¹»ç¯ç‰‡**
3. âœ… **æ‰¹é‡å¤§å°å¯é…ç½®**ï¼šé€šè¿‡ `knowledge.qa.image-processing.vision-llm.batch.size` é…ç½®

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. é…ç½®ç±»æ›´æ–°ï¼ˆKnowledgeQAProperties.javaï¼‰

æ·»åŠ äº†å®Œæ•´çš„æ‰¹é‡å¤„ç†é…ç½®ç»“æ„ï¼š

```java
@Data
public static class VisionLlmConfig {
    private boolean enabled = false;
    private String apiKey = "${VISION_LLM_API_KEY:}";
    private String model = "gpt-4-vision-preview";
    private String endpoint = "${VISION_LLM_ENDPOINT:}";
    private BatchConfig batch = new BatchConfig();  // æ–°å¢
}

@Data
public static class BatchConfig {
    private boolean enabled = true;    // æ˜¯å¦å¯ç”¨æ‰¹é‡å¤„ç†
    private int size = 4;               // æ‰¹é‡å¤§å°ï¼ˆé»˜è®¤4å¼ å¹»ç¯ç‰‡ï¼‰
    private CompressConfig compress = new CompressConfig();
}

@Data
public static class CompressConfig {
    private boolean enabled = true;     // æ˜¯å¦å¯ç”¨å‹ç¼©
    private double quality = 0.8;       // å‹ç¼©è´¨é‡
    private int maxSizeKb = 300;        // æœ€å¤§å°ºå¯¸
    private int maxWidth = 1920;        // æœ€å¤§å®½åº¦
    private int maxHeight = 1080;       // æœ€å¤§é«˜åº¦
}
```

### 2. OfficeImageExtractor é‡æ„

#### æ·»åŠ æ‰¹é‡å¤§å°å­—æ®µ
```java
private final SmartImageExtractor imageExtractor;
private final int batchSize; // æ‰¹é‡å¤„ç†çš„å¹»ç¯ç‰‡æ•°é‡

public OfficeImageExtractor(SmartImageExtractor imageExtractor, int batchSize) {
    this.imageExtractor = imageExtractor;
    this.batchSize = Math.max(1, batchSize);
}
```

#### é‡å†™ extractFromPPTX æ–¹æ³•
å®ç°äº†ä¸¤ç§æ¨¡å¼ï¼š

**1. æ‰¹é‡å¤„ç†æ¨¡å¼**ï¼ˆå½“æ”¯æŒ VisionLLM ä¸” batchSize > 1ï¼‰
- ä»¥å¹»ç¯ç‰‡ä¸ºæœ€å°å•ä½
- æ¯æ¬¡æ”¶é›† N å¼ å¹»ç¯ç‰‡çš„æ‰€æœ‰å›¾ç‰‡ï¼ˆN = batchSizeï¼‰
- æå–å›¾ç‰‡ä½ç½®ä¿¡æ¯ï¼ˆåæ ‡ã€å¤§å°ï¼‰
- ä¸€æ¬¡æ€§å‘é€ç»™ Vision LLM åˆ†æ
- è‡ªåŠ¨æè¿°å›¾ç‰‡çš„ç©ºé—´å¸ƒå±€å…³ç³»

**2. å•å¼ æ¨¡å¼**ï¼ˆå…¼å®¹æ—§ç‰ˆï¼ŒOCR ç­‰åœºæ™¯ï¼‰
- é€å¼ å¹»ç¯ç‰‡å¤„ç†
- é€ä¸ªå›¾ç‰‡å¤„ç†
- ä¿æŒå‘åå…¼å®¹

### 3. TikaDocumentParser æ›´æ–°

æ·»åŠ äº†æ‰¹é‡å¤§å°é…ç½®å­—æ®µï¼š
```java
private final int visionBatchSize;
private static final int DEFAULT_VISION_BATCH_SIZE = 1;

public TikaDocumentParser(int maxContentLength, 
                         boolean extractImageMetadata,
                         boolean includeImagePlaceholders,
                         int visionBatchSize,        // æ–°å¢å‚æ•°
                         SmartImageExtractor imageExtractor) {
    // ...
    this.visionBatchSize = Math.max(1, visionBatchSize);
}
```

å¹¶åœ¨ parse æ–¹æ³•ä¸­ä¼ é€’ç»™ OfficeImageExtractorï¼š
```java
OfficeImageExtractor officeExtractor = 
    new OfficeImageExtractor(imageExtractor, visionBatchSize);
```

### 4. KnowledgeBaseService æ›´æ–°

ä»é…ç½®ä¸­è¯»å–æ‰¹é‡å¤§å°ï¼š
```java
// è·å–æ‰¹é‡å¤§å°é…ç½®
int visionBatchSize = properties.getImageProcessing()
                                .getVisionLlm()
                                .getBatch()
                                .getSize();

this.documentParser = new TikaDocumentParser(
    10 * 1024 * 1024,
    true,
    true,
    visionBatchSize,   // ä¼ é€’é…ç½®å€¼
    imageExtractor
);
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°

### æ‰¹é‡å¤„ç†é€»è¾‘

```java
private String extractWithBatchMode(List<XSLFSlide> allSlides, XMLSlideShow ppt) {
    int totalSlides = allSlides.size();
    int processedSlides = 0;
    
    while (processedSlides < totalSlides) {
        // 1. è®¡ç®—æœ¬æ‰¹æ¬¡å¤„ç†çš„å¹»ç¯ç‰‡èŒƒå›´
        int endIndex = Math.min(processedSlides + batchSize, totalSlides);
        List<XSLFSlide> batchSlides = allSlides.subList(processedSlides, endIndex);
        
        // 2. æ”¶é›†æœ¬æ‰¹æ¬¡æ‰€æœ‰å›¾ç‰‡ï¼ˆå¸¦ä½ç½®ä¿¡æ¯ï¼‰
        List<ImagePositionInfo> batchImages = new ArrayList<>();
        
        for (XSLFSlide slide : batchSlides) {
            // æå–æ–‡æœ¬
            // ...
            
            // æå–å›¾ç‰‡åŠä½ç½®
            for (XSLFShape shape : slide.getShapes()) {
                if (shape instanceof XSLFPictureShape picture) {
                    Rectangle2D anchor = picture.getAnchor();
                    ImagePositionInfo imgPos = new ImagePositionInfo(
                        imageData, imageName,
                        anchor.getX(), anchor.getY(),
                        anchor.getWidth(), anchor.getHeight(),
                        batchImages.size()
                    );
                    batchImages.add(imgPos);
                }
            }
        }
        
        // 3. æ‰¹é‡å¤„ç†è¿™æ‰¹å¹»ç¯ç‰‡çš„æ‰€æœ‰å›¾ç‰‡
        if (!batchImages.isEmpty()) {
            String imageContent = visionStrategy.extractContentBatchWithPosition(batchImages);
            content.append(imageContent);
        }
        
        processedSlides = endIndex;
    }
    
    return content.toString();
}
```

## ğŸ“Š é…ç½®ç¤ºä¾‹

### application.yml é…ç½®

```yaml
knowledge:
  qa:
    image-processing:
      strategy: vision-llm  # ä½¿ç”¨ Vision LLM
      vision-llm:
        enabled: true
        api-key: ${QW_API_KEY}
        model: qwen-vl-plus
        endpoint: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
        batch:
          enabled: true
          size: 4  # æ¯æ¬¡å¤„ç†4å¼ å¹»ç¯ç‰‡
          compress:
            enabled: true
            quality: 0.8
            max-size-kb: 300
            max-width: 1920
            max-height: 1080
```

## ğŸ¯ å¤„ç†æµç¨‹ç¤ºä¾‹

### ç¤ºä¾‹ï¼š10 å¼ å¹»ç¯ç‰‡çš„ PPTï¼Œbatch.size = 4

**æ‰¹æ¬¡åˆ’åˆ†**ï¼š
- æ‰¹æ¬¡ 1: å¹»ç¯ç‰‡ 1-4ï¼ˆå‡è®¾å…± 8 å¼ å›¾ç‰‡ï¼‰
- æ‰¹æ¬¡ 2: å¹»ç¯ç‰‡ 5-8ï¼ˆå‡è®¾å…± 6 å¼ å›¾ç‰‡ï¼‰
- æ‰¹æ¬¡ 3: å¹»ç¯ç‰‡ 9-10ï¼ˆå‡è®¾å…± 4 å¼ å›¾ç‰‡ï¼‰

**å¤„ç†è¿‡ç¨‹**ï¼š
```
ğŸ“¦ æ‰¹é‡å¤„ç†å¹»ç¯ç‰‡ 1-4/10
   æ”¶é›†å›¾ç‰‡: slide1_image1.png (ä½ç½®: 100,50, å¤§å°: 300x200)
   æ”¶é›†å›¾ç‰‡: slide1_image2.png (ä½ç½®: 450,50, å¤§å°: 300x200)
   ...
   ğŸ“¸ æœ¬æ‰¹æ¬¡å…± 8 å¼ å›¾ç‰‡ï¼Œå¼€å§‹æ‰¹é‡åˆ†æ...
   âœ… æ‰¹é‡åˆ†æå®Œæˆ: 8 å¼ å›¾ç‰‡ -> 2547 å­—ç¬¦

ğŸ“¦ æ‰¹é‡å¤„ç†å¹»ç¯ç‰‡ 5-8/10
   ğŸ“¸ æœ¬æ‰¹æ¬¡å…± 6 å¼ å›¾ç‰‡ï¼Œå¼€å§‹æ‰¹é‡åˆ†æ...
   âœ… æ‰¹é‡åˆ†æå®Œæˆ: 6 å¼ å›¾ç‰‡ -> 1893 å­—ç¬¦

ğŸ“¦ æ‰¹é‡å¤„ç†å¹»ç¯ç‰‡ 9-10/10
   ğŸ“¸ æœ¬æ‰¹æ¬¡å…± 4 å¼ å›¾ç‰‡ï¼Œå¼€å§‹æ‰¹é‡åˆ†æ...
   âœ… æ‰¹é‡åˆ†æå®Œæˆ: 4 å¼ å›¾ç‰‡ -> 1256 å­—ç¬¦
```

**API è°ƒç”¨æ¬¡æ•°**ï¼š
- åŸæ–¹æ¡ˆï¼š18 æ¬¡ï¼ˆé€ä¸ªå›¾ç‰‡ï¼‰
- æ–°æ–¹æ¡ˆï¼š3 æ¬¡ï¼ˆæ‰¹é‡å¤„ç†ï¼‰
- **èŠ‚çœ**ï¼š83% â†“

## ğŸ’¡ ç‰¹æ€§äº®ç‚¹

### 1. ä»¥å¹»ç¯ç‰‡ä¸ºæœ€å°å•ä½
- âœ… ä¸€å¼ å¹»ç¯ç‰‡çš„æ‰€æœ‰å›¾ç‰‡ä¸€èµ·å¤„ç†
- âœ… ä¿ç•™å›¾ç‰‡åœ¨å¹»ç¯ç‰‡ä¸Šçš„ä½ç½®å…³ç³»
- âœ… Vision LLM èƒ½ç†è§£æ•´å¼ å¹»ç¯ç‰‡çš„å¸ƒå±€

### 2. æ”¯æŒæ‰¹é‡å¤šå¼ å¹»ç¯ç‰‡
- âœ… æ ¹æ® `batch.size` é…ç½®å†³å®šæ¯æ‰¹å¤„ç†å¤šå°‘å¼ 
- âœ… è‡ªåŠ¨åˆ†æ‰¹ï¼Œå¤„ç†ä»»æ„æ•°é‡çš„å¹»ç¯ç‰‡
- âœ… æ¯æ‰¹ç‹¬ç«‹å‘é€ API è¯·æ±‚

### 3. ä½ç½®ä¿¡æ¯ä¿ç•™
- âœ… æå–å›¾ç‰‡çš„ Xã€Y åæ ‡
- âœ… æå–å›¾ç‰‡çš„å®½åº¦å’Œé«˜åº¦
- âœ… è‡ªåŠ¨ç”Ÿæˆä½ç½®æè¿°ï¼ˆä¸Šæ–¹/ä¸‹æ–¹/å·¦ä¾§/å³ä¾§ï¼‰
- âœ… è®¡ç®—å›¾ç‰‡ä¹‹é—´çš„ç›¸å¯¹ä½ç½®å…³ç³»

### 4. æ™ºèƒ½æ¨¡å¼åˆ‡æ¢
- âœ… VisionLLM ä¸” batch.size > 1ï¼šä½¿ç”¨æ‰¹é‡æ¨¡å¼
- âœ… OCR æˆ–å…¶ä»–ç­–ç•¥ï¼šä½¿ç”¨å•å¼ æ¨¡å¼
- âœ… è‡ªåŠ¨æ£€æµ‹ï¼Œæ— ç¼åˆ‡æ¢

### 5. å‘åå…¼å®¹
- âœ… æ—§ä»£ç ä»ç„¶å¯ç”¨ï¼ˆé»˜è®¤ batchSize = 1ï¼‰
- âœ… å…¼å®¹æ‰€æœ‰ç°æœ‰æµ‹è¯•ç”¨ä¾‹
- âœ… æ¸è¿›å¼å‡çº§ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½

## âœ… éªŒè¯ç»“æœ

### ç¼–è¯‘æµ‹è¯•
```bash
mvn compile -DskipTests -q
```
**ç»“æœ**: âœ… BUILD SUCCESS

### ä»£ç æ£€æŸ¥
- âœ… æ‰€æœ‰æ–°å¢æ–¹æ³•å·²å®ç°
- âœ… é…ç½®ç±»ç»“æ„å®Œæ•´
- âœ… æ‰¹é‡å¤§å°æ­£ç¡®ä¼ é€’
- âœ… ä½ç½®ä¿¡æ¯æ­£ç¡®æå–

## ğŸ“ ä½¿ç”¨è¯´æ˜

### é…ç½®æ‰¹é‡å¤§å°

åœ¨ `application.yml` ä¸­ï¼š
```yaml
knowledge.qa.image-processing.vision-llm.batch.size: 4
```

### æ¨èé…ç½®å€¼

- **GPT-4o**: 5-10 å¼ ï¼ˆä¸Šä¸‹æ–‡çª—å£å¤§ï¼‰
- **Qwen-VL Plus**: 3-5 å¼ ï¼ˆæ¨è 4ï¼‰
- **Claude-3**: 5-8 å¼ 
- **æœ¬åœ° Ollama**: 1-3 å¼ ï¼ˆæ€§èƒ½è€ƒè™‘ï¼‰

### è°ƒä¼˜å»ºè®®

**å¦‚æœé‡åˆ°è¶…æ—¶**ï¼š
- å‡å° `batch.size`ï¼ˆå¦‚æ”¹ä¸º 2 æˆ– 3ï¼‰
- å¯ç”¨å›¾ç‰‡å‹ç¼©
- è°ƒä½å‹ç¼©è´¨é‡ï¼ˆå¦‚ 0.6ï¼‰

**å¦‚æœæƒ³æé«˜æ•ˆç‡**ï¼š
- å¢å¤§ `batch.size`ï¼ˆå¦‚æ”¹ä¸º 5 æˆ– 6ï¼‰
- ä½†è¦æ³¨æ„æ¨¡å‹çš„ä¸Šä¸‹æ–‡é™åˆ¶

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… ä»¥å¹»ç¯ç‰‡ä¸ºæœ€å°å•ä½å¤„ç†
- âœ… æ”¯æŒæ‰¹é‡å¤„ç†å¤šå¼ å¹»ç¯ç‰‡
- âœ… æ‰¹é‡å¤§å°å¯é…ç½®
- âœ… ä½ç½®ä¿¡æ¯ä¿ç•™
- âœ… æ™ºèƒ½æ¨¡å¼åˆ‡æ¢
- âœ… ç¼–è¯‘é€šè¿‡
- âœ… å‘åå…¼å®¹

**å®Œæˆæ—¶é—´**: 2025-12-03
**çŠ¶æ€**: âœ… å®Œå…¨å®ç°å¹¶éªŒè¯é€šè¿‡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [20251203-æ¶æ„å›¾ä½ç½®ä¿¡æ¯ä¿ç•™æ–¹æ¡ˆ.md](./20251203-æ¶æ„å›¾ä½ç½®ä¿¡æ¯ä¿ç•™æ–¹æ¡ˆ.md)
- [20251203-VisionLLMStrategyç¼ºå¤±æ–¹æ³•ä¿®å¤æŠ¥å‘Š.md](./20251203-VisionLLMStrategyç¼ºå¤±æ–¹æ³•ä¿®å¤æŠ¥å‘Š.md)
- [20251203-PPTæ‰¹é‡å›¾ç‰‡å¤„ç†å®ç°æ–¹æ¡ˆ.md](./20251203-PPTæ‰¹é‡å›¾ç‰‡å¤„ç†å®ç°æ–¹æ¡ˆ.md)

