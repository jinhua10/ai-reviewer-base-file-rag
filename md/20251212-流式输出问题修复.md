# æµå¼è¾“å‡ºé—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜ç°è±¡

### 1. æ²¡æœ‰å®æ—¶è¾“å‡ºå†…å®¹
- **ç°è±¡**ï¼šæµå¼ç”Ÿæˆæ—¶å†…å®¹ä¸æ˜¾ç¤º
- **åŸå› **ï¼šäº‹ä»¶ç›‘å¬å™¨åç§°ä¸åŒ¹é…

### 2. æ¥å£ç»“æŸæŠ¥é”™
```
âŒ Failed to parse complete message: SyntaxError: Unexpected token 'd', "done" is not valid JSON
âŒ SSE error: Event {type: 'error'}
```
- **åŸå› **ï¼šåç«¯ `complete` äº‹ä»¶å‘é€çº¯æ–‡æœ¬ `"done"`ï¼Œå‰ç«¯å°è¯• `JSON.parse()` å¯¼è‡´é”™è¯¯

## æ ¹æœ¬åŸå› 

### åç«¯æœ‰ä¸¤å¥— SSE æ¥å£

#### 1. `GET /api/qa/stream/{sessionId}`
ä½¿ç”¨ `HybridStreamingService.createSSEStream()`

**äº‹ä»¶æ ¼å¼ï¼š**
```java
// chunk äº‹ä»¶ - çº¯æ–‡æœ¬
emitter.send(SseEmitter.event()
    .name("chunk")
    .data(chunk));  // çº¯æ–‡æœ¬å­—ç¬¦ä¸²

// complete äº‹ä»¶ - çº¯æ–‡æœ¬
emitter.send(SseEmitter.event()
    .name("complete")
    .data("done"));  // çº¯æ–‡æœ¬ "done"
```

#### 2. `GET /api/qa/stream/dual-track`
ä½¿ç”¨ `StreamingQAController.dualTrackStreaming()`

**äº‹ä»¶æ ¼å¼ï¼š**
```java
// hope äº‹ä»¶ - JSON
emitter.send(SseEmitter.event()
    .name("hope")
    .data(StreamMessage.hopeAnswer(...)));

// llm äº‹ä»¶ - JSON
emitter.send(SseEmitter.event()
    .name("llm")
    .data(StreamMessage.llmChunk(...)));

// complete äº‹ä»¶ - JSON
emitter.send(SseEmitter.event()
    .name("complete")
    .data(StreamMessage.llmComplete(...)));
```

### å‰ç«¯é—®é¢˜

**ä¹‹å‰çš„ä»£ç åªç›‘å¬ `'llm'` äº‹ä»¶ï¼š**
```javascript
eventSource.addEventListener('llm', (event) => {
  const message = JSON.parse(event.data)  // æœŸæœ› JSON
  // ...
})

eventSource.addEventListener('complete', (event) => {
  const message = JSON.parse(event.data)  // æœŸæœ› JSONï¼Œä½†æ”¶åˆ° "done"
  // ...
})
```

**å®é™…è°ƒç”¨çš„æ¥å£å‘é€çš„æ˜¯ `'chunk'` äº‹ä»¶ï¼š**
```
POST /api/qa/stream â†’ {sessionId, sseUrl}
GET /api/qa/stream/{sessionId} â†’ 
  - event: chunk, data: "æ–‡æœ¬å—"
  - event: complete, data: "done"
```

**ç»“æœï¼š**
- âŒ `'chunk'` äº‹ä»¶æ²¡æœ‰ç›‘å¬å™¨ â†’ å†…å®¹ä¸æ˜¾ç¤º
- âŒ `'complete'` äº‹ä»¶å°è¯•è§£æ `"done"` ä¸º JSON â†’ æŠ¥é”™

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ  `'chunk'` äº‹ä»¶ç›‘å¬å™¨

```javascript
// ç›‘å¬ chunk äº‹ä»¶ï¼ˆHybridStreamingService ä½¿ç”¨ï¼‰
eventSource.addEventListener('chunk', (event) => {
  const chunk = event.data  // çº¯æ–‡æœ¬å—

  fullLLMAnswer += chunk
  chunkCount++

  console.log(`ğŸ“¦ Received chunk #${chunkCount}:`, chunk.substring(0, 50))

  if (onChunk) {
    onChunk({
      content: chunk,
      done: false,
      type: 'llm',
      chunkIndex: chunkCount
    })
  }
})
```

### 2. ä¿ç•™ `'llm'` äº‹ä»¶ç›‘å¬å™¨ï¼ˆå…¼å®¹ dualTrackStreamingï¼‰

```javascript
// ç›‘å¬ LLM äº‹ä»¶ï¼ˆdualTrackStreaming ä½¿ç”¨ï¼‰
eventSource.addEventListener('llm', (event) => {
  const message = JSON.parse(event.data)  // JSON æ ¼å¼
  const chunk = message.content
  
  // å¤„ç†é€»è¾‘...
})
```

### 3. ä¿®å¤ `'complete'` äº‹ä»¶å¤„ç†

```javascript
eventSource.addEventListener('complete', (event) => {
  console.log('ğŸ“¢ Received complete event:', event.data)

  eventSource.close()

  // å…¼å®¹ä¸¤ç§æ ¼å¼ï¼šçº¯æ–‡æœ¬ "done" æˆ– JSON
  let totalChunks = chunkCount
  let totalTime = 0

  if (event.data !== 'done') {
    try {
      const message = JSON.parse(event.data)
      totalChunks = message.totalChunks || chunkCount
      totalTime = message.totalTime || 0
    } catch (error) {
      console.warn('âš ï¸ Complete message is not JSON, using fallback values')
    }
  }

  console.log(`âœ… LLM generation completed: ${totalChunks} chunks`)

  if (onChunk) {
    onChunk({
      content: '',
      done: true,
      type: 'complete',
      sessionId,
      hopeAnswer: hopeAnswer?.answer || null,
      llmAnswer: fullLLMAnswer,
      totalChunks,
      totalTime
    })
  }
})
```

### 4. ä¼˜åŒ–é”™è¯¯å¤„ç†

```javascript
eventSource.addEventListener('error', (event) => {
  console.error('âŒ SSE error:', event)
  
  // åªåœ¨éæ­£å¸¸å…³é—­æ—¶æŠ¥é”™
  if (eventSource.readyState === EventSource.CLOSED) {
    console.log('ğŸ”Œ EventSource closed')
  } else if (eventSource.readyState === EventSource.CONNECTING) {
    console.log('ğŸ”„ EventSource reconnecting...')
  } else {
    eventSource.close()
    
    if (onChunk) {
      onChunk({
        content: '',
        done: true,
        type: 'error',
        error: 'SSE connection failed'
      })
    }
  }
})
```

### 5. æ·»åŠ è°ƒè¯•æ—¥å¿—

```javascript
// è¿æ¥æ‰“å¼€
eventSource.addEventListener('open', () => {
  console.log('âœ… SSE connection opened:', eventSourceUrl)
})

// chunk åˆ°è¾¾
console.log(`ğŸ“¦ Received chunk #${chunkCount}:`, chunk.substring(0, 50))

// å®Œæˆ
console.log(`âœ… LLM generation completed: ${totalChunks} chunks, ${totalTime}ms`)
```

## ä¿®å¤åçš„å®Œæ•´æµç¨‹

```
ç”¨æˆ·æé—®
    â†“
POST /api/qa/stream
    â†“
è¿”å› {sessionId, hopeAnswer, sseUrl}
    â†“
HOPE ç­”æ¡ˆç«‹å³æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
    â†“
EventSource è¿æ¥ sseUrl
    â†“
âœ… SSE connection opened
    â†“
event: chunk, data: "æ ¹æ®"
    â†“ ğŸ“¦ Received chunk #1
    â†“ å®æ—¶æ˜¾ç¤º
event: chunk, data: "æ‚¨çš„"
    â†“ ğŸ“¦ Received chunk #2
    â†“ å®æ—¶è¿½åŠ 
event: chunk, data: "é—®é¢˜"
    â†“ ğŸ“¦ Received chunk #3
    â†“ å®æ—¶è¿½åŠ 
    ... (æŒç»­æµå¼)
    â†“
event: complete, data: "done"
    â†“ ğŸ“¢ Received complete event
    â†“ å…¼å®¹å¤„ç†ï¼ˆä¸è§£æä¸º JSONï¼‰
    â†“
âœ… LLM generation completed
    â†“
EventSource closed
```

## æ”¯æŒçš„æ¥å£æ¨¡å¼

### æ¨¡å¼ 1ï¼šç®€å•æµå¼ï¼ˆå½“å‰ä½¿ç”¨ï¼‰
```
POST /api/qa/stream
  â†’ {sessionId, hopeAnswer, sseUrl: "/api/qa/stream/{sessionId}"}

GET /api/qa/stream/{sessionId}
  â†’ event: chunk (çº¯æ–‡æœ¬)
  â†’ event: complete ("done")
```

### æ¨¡å¼ 2ï¼šåŒè½¨æµå¼ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
```
GET /api/qa/stream/dual-track?question=xxx&sessionId=xxx
  â†’ event: hope (JSON)
  â†’ event: llm (JSON)
  â†’ event: complete (JSON)
```

**å‰ç«¯ç°å·²åŒæ—¶æ”¯æŒä¸¤ç§æ¨¡å¼ï¼**

## æµ‹è¯•æ£€æŸ¥æ¸…å•

### åç«¯æµ‹è¯•
- [ ] åç«¯æœåŠ¡å·²å¯åŠ¨
- [ ] `POST /api/qa/stream` è¿”å› sessionId å’Œ sseUrl
- [ ] `GET /api/qa/stream/{sessionId}` è¿”å› SSE æµ
- [ ] chunk äº‹ä»¶æ­£å¸¸å‘é€
- [ ] complete äº‹ä»¶æ­£å¸¸å‘é€

### å‰ç«¯æµ‹è¯•
- [ ] æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—
- [ ] çœ‹åˆ° "ğŸš€ Starting streaming Q&A"
- [ ] çœ‹åˆ° "ğŸ“¥ Received initial response"
- [ ] çœ‹åˆ° "âœ… SSE connection opened"
- [ ] çœ‹åˆ° "ğŸ“¦ Received chunk #1, #2, #3..."
- [ ] çœ‹åˆ° "ğŸ“¢ Received complete event"
- [ ] çœ‹åˆ° "âœ… LLM generation completed"
- [ ] UI å®æ—¶æ˜¾ç¤ºå†…å®¹
- [ ] æ— é”™è¯¯ä¿¡æ¯

### é”™è¯¯æ’æŸ¥
å¦‚æœä»ç„¶æ²¡æœ‰è¾“å‡ºï¼š

1. **æ£€æŸ¥ç½‘ç»œ**
   ```javascript
   // æµè§ˆå™¨æ§åˆ¶å°
   fetch('http://localhost:8080/api/qa/stream', {
     method: 'POST',
     headers: {'Content-Type': 'application/json'},
     body: JSON.stringify({question: 'test', userId: 'user1'})
   }).then(r => r.json()).then(console.log)
   ```

2. **æ£€æŸ¥ EventSource è¿æ¥**
   ```javascript
   const es = new EventSource('http://localhost:5173/api/qa/stream/xxx')
   es.addEventListener('chunk', e => console.log('chunk:', e.data))
   es.addEventListener('complete', e => console.log('complete:', e.data))
   ```

3. **æ£€æŸ¥åç«¯æ—¥å¿—**
   - æŸ¥çœ‹æ˜¯å¦æœ‰ "æ”¶åˆ°æµå¼é—®ç­”è¯·æ±‚"
   - æŸ¥çœ‹æ˜¯å¦æœ‰ "å®¢æˆ·ç«¯è®¢é˜…æµå¼è¾“å‡º"
   - æŸ¥çœ‹æ˜¯å¦æœ‰ LLM ç”Ÿæˆæ—¥å¿—

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä¿®å¤
1. âœ… `UI/src/api/modules/qa.js`
   - æ·»åŠ  `'chunk'` äº‹ä»¶ç›‘å¬å™¨
   - ä¿®å¤ `'complete'` äº‹ä»¶è§£æ
   - ä¼˜åŒ–é”™è¯¯å¤„ç†
   - æ·»åŠ è°ƒè¯•æ—¥å¿—

2. âœ… `UI/src/components/qa/QAPanel.jsx`
   - æ·»åŠ è°ƒè¯•æ—¥å¿—

### å®Œæ•´çš„äº‹ä»¶ç›‘å¬å™¨åˆ—è¡¨

```javascript
eventSource.addEventListener('open', handler)       // è¿æ¥æ‰“å¼€
eventSource.addEventListener('chunk', handler)      // æ–‡æœ¬å—ï¼ˆçº¯æ–‡æœ¬ï¼‰
eventSource.addEventListener('llm', handler)        // LLM å—ï¼ˆJSONï¼‰
eventSource.addEventListener('hope', handler)       // HOPE ç­”æ¡ˆï¼ˆJSONï¼‰
eventSource.addEventListener('complete', handler)   // å®Œæˆï¼ˆçº¯æ–‡æœ¬æˆ– JSONï¼‰
eventSource.addEventListener('error', handler)      // é”™è¯¯
```

## æ€»ç»“

### é—®é¢˜æ ¹æº
åç«¯æœ‰ä¸¤å¥— SSE æ¥å£ï¼Œå‰ç«¯åªç›‘å¬äº†ä¸€å¥—çš„äº‹ä»¶åç§°ï¼Œå¯¼è‡´ï¼š
- âŒ æ”¶ä¸åˆ° `'chunk'` äº‹ä»¶ â†’ å†…å®¹ä¸æ˜¾ç¤º
- âŒ è§£æ `"done"` ä¸º JSON â†’ æŠ¥é”™

### è§£å†³æ–¹æ¡ˆ
å‰ç«¯åŒæ—¶ç›‘å¬ä¸¤å¥—æ¥å£çš„äº‹ä»¶ï¼Œå¹¶å…¼å®¹å¤„ç†çº¯æ–‡æœ¬å’Œ JSON æ ¼å¼ã€‚

### ä¿®å¤æ•ˆæœ
- âœ… å®æ—¶æ˜¾ç¤ºæµå¼å†…å®¹
- âœ… æ—  JSON è§£æé”™è¯¯
- âœ… å…¼å®¹ä¸¤ç§æ¥å£æ¨¡å¼
- âœ… å®Œå–„çš„è°ƒè¯•æ—¥å¿—

---

**ä¿®å¤æ—¶é—´**: 2025-12-12  
**ä¿®å¤å·¥ç¨‹å¸ˆ**: AI Reviewer Team  
**æµ‹è¯•çŠ¶æ€**: å¾…åç«¯å¯åŠ¨æµ‹è¯• â³
