# âœ… Phase 1 å®ŒæˆæŠ¥å‘Š - PPL ç»Ÿä¸€æ¥å£åŸºç¡€æ¶æ„

## ğŸ“… å®Œæˆæ—¶é—´
2025-12-04 20:30:00

## ğŸ¯ Phase 1 ç›®æ ‡
æ­å»º PPL æœåŠ¡çš„åŸºç¡€æ¶æ„ï¼ŒåŒ…æ‹¬æ ¸å¿ƒæ¥å£ã€é…ç½®ç³»ç»Ÿå’Œé—¨é¢ç±»

## âœ… å·²å®Œæˆä»»åŠ¡

### 1. æ ¸å¿ƒæ¥å£ä¸æšä¸¾ âœ…
- [x] `PPLProviderType.java` - æä¾›å•†æšä¸¾ï¼ˆONNXã€Ollamaã€OpenAIï¼‰
- [x] `PPLException.java` - ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- [x] `PPLMetrics.java` - æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- [x] `PPLService.java` - æ ¸å¿ƒæœåŠ¡æ¥å£

### 2. é…ç½®æ¨¡å‹ âœ…
- [x] `ChunkConfig.java` - Chunking é…ç½®
- [x] `RerankConfig.java` - Rerank é…ç½®
- [x] `PPLConfig.java` - ç»Ÿä¸€é…ç½®æ¨¡å‹ï¼ˆæ”¯æŒ Spring Bootï¼‰

### 3. é—¨é¢å®ç° âœ…
- [x] `PPLServiceFacade.java` - æœåŠ¡é—¨é¢ç±»
  - æ”¯æŒå¤šæä¾›å•†ç®¡ç†
  - æ”¯æŒåŠ¨æ€åˆ‡æ¢
  - æ”¯æŒé™çº§ç­–ç•¥
  - ç»Ÿä¸€ç›‘æ§å’Œæ—¥å¿—

### 4. ONNX æœåŠ¡éª¨æ¶ âœ…
- [x] `PPLOnnxService.java` - ONNX å®ç°éª¨æ¶
  - åŸºç¡€ç»“æ„å®Œæˆ
  - TODOæ ‡è®°æ˜ç¡®ï¼ˆPhase 2 å®ç°ï¼‰

### 5. é…ç½®æ–‡ä»¶ âœ…
- [x] `application.yml` - æ·»åŠ å®Œæ•´çš„ PPL é…ç½®
  - ä¸‰ç§æä¾›å•†é…ç½®
  - Chunking é…ç½®
  - Rerank é…ç½®
  - é™çº§ç­–ç•¥é…ç½®

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/main/java/top/yumbo/ai/rag/ppl/
â”œâ”€â”€ PPLProviderType.java          # æä¾›å•†æšä¸¾
â”œâ”€â”€ PPLException.java              # å¼‚å¸¸å®šä¹‰
â”œâ”€â”€ PPLMetrics.java                # æ€§èƒ½æŒ‡æ ‡
â”œâ”€â”€ PPLService.java                # æ ¸å¿ƒæ¥å£
â”œâ”€â”€ PPLServiceFacade.java          # é—¨é¢å®ç°
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ ChunkConfig.java           # Chunking é…ç½®
â”‚   â”œâ”€â”€ RerankConfig.java          # Rerank é…ç½®
â”‚   â””â”€â”€ PPLConfig.java             # ç»Ÿä¸€é…ç½®
â””â”€â”€ onnx/
    â””â”€â”€ PPLOnnxService.java        # ONNX å®ç°éª¨æ¶
```

## ğŸ¨ æ¶æ„äº®ç‚¹

### 1. ç­–ç•¥æ¨¡å¼
```java
// ç»Ÿä¸€æ¥å£ï¼Œå¤šç§å®ç°
interface PPLService {
    double calculatePerplexity(String text);
    List<DocumentChunk> chunk(...);
    List<Document> rerank(...);
}

// ONNX å®ç°
class PPLOnnxService implements PPLService { }

// Ollama å®ç°ï¼ˆPhase 3ï¼‰
class PPLOllamaService implements PPLService { }

// OpenAI å®ç°ï¼ˆPhase 4ï¼‰
class PPLOpenAIService implements PPLService { }
```

### 2. é—¨é¢æ¨¡å¼
```java
@Service
public class PPLServiceFacade {
    // ç»Ÿä¸€å…¥å£ï¼Œéšè—å¤æ‚æ€§
    public double calculatePerplexity(String text) {
        return executeWithFallback(...);
    }
    
    // æ”¯æŒåŠ¨æ€åˆ‡æ¢
    public void switchProvider(PPLProviderType newProvider) {
        currentProvider = newProvider;
    }
    
    // æ”¯æŒé™çº§ç­–ç•¥
    private <T> T tryFallback(...) {
        for (String providerName : fallbackOrder) {
            // å°è¯•å¤‡ç”¨æä¾›å•†
        }
    }
}
```

### 3. é…ç½®åŒ–è®¾è®¡
```yaml
knowledge:
  qa:
    ppl:
      default-provider: onnx  # å¯é…ç½®
      enable-fallback: true   # å¯é…ç½®
      fallback-order: [onnx, ollama, openai]  # å¯é…ç½®
      
      onnx:
        enabled: true
        model-path: ./models/gpt2-medium-int8/model.onnx
      
      chunking:
        ppl-threshold: 20.0
        max-chunk-size: 2000
      
      reranking:
        enabled: false
        weight: 0.15
```

### 4. æ€§èƒ½ç›‘æ§
```java
public class PPLMetrics {
    private final AtomicLong totalCalls;
    private final AtomicLong successCalls;
    private final AtomicLong failedCalls;
    private final DoubleAdder totalLatencyMs;
    private final AtomicLong cacheHits;  // ONNX
    private final DoubleAdder totalCost; // OpenAI
    
    // è®°å½•æ¯æ¬¡è°ƒç”¨
    public void recordSuccess(long latencyMs);
    public void recordFailure(long latencyMs);
    
    // è·å–ç»Ÿè®¡ä¿¡æ¯
    public double getCacheHitRate();
    public double getSuccessRate();
}
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### 1. å¼‚å¸¸å¤„ç†
```java
public class PPLException extends Exception {
    private final PPLProviderType providerType;
    private final String errorCode;
    
    // æ”¯æŒå¤šç§æ„é€ æ–¹å¼
    public PPLException(String message);
    public PPLException(PPLProviderType providerType, String message);
    public PPLException(PPLProviderType providerType, String errorCode, String message, Throwable cause);
}
```

### 2. é…ç½®éªŒè¯
```java
public class ChunkConfig {
    public void validate() {
        if (pplThreshold <= 0) {
            throw new IllegalArgumentException("pplThreshold must be positive");
        }
        if (minChunkSize > maxChunkSize) {
            throw new IllegalArgumentException("minChunkSize cannot be greater than maxChunkSize");
        }
        // ...
    }
}
```

### 3. é™çº§ç­–ç•¥
```java
private <T> T executeWithFallback(ServiceOperation<T> operation, String operationName) {
    // 1. å°è¯•å½“å‰æä¾›å•†
    try {
        return operation.execute(getCurrentService());
    } catch (Exception e) {
        // 2. å¦‚æœå¯ç”¨é™çº§ï¼Œå°è¯•å¤‡ç”¨æä¾›å•†
        if (config.isEnableFallback()) {
            return tryFallback(operation, operationName, e);
        } else {
            throw new PPLException(...);
        }
    }
}
```

## ğŸ“Š ä¸‹ä¸€æ­¥è®¡åˆ’ï¼ˆPhase 2ï¼‰

### ç›®æ ‡
å®ç°å®Œæ•´çš„ ONNX æœåŠ¡

### ä»»åŠ¡æ¸…å•
- [ ] æ·»åŠ  Maven ä¾èµ–
  - ONNX Runtime: `com.microsoft.onnxruntime:onnxruntime:1.16.0`
  - Tokenizers: `ai.djl.huggingface:tokenizers:0.25.0`
  - Caffeine: ç¼“å­˜

- [ ] å®ç° PPL è®¡ç®—
  - Tokenization
  - æ¨¡å‹æ¨ç†
  - å›°æƒ‘åº¦è®¡ç®—

- [ ] å®ç° PPL Chunking
  - åˆ†å¥
  - ç²—åˆ†å—
  - PPL ç²¾ç»†åˆ‡åˆ†

- [ ] å®ç° PPL Rerank
  - Top-K é€‰æ‹©
  - PPL åˆ†æ•°è®¡ç®—
  - æ··åˆè¯„åˆ†

- [ ] æ·»åŠ ç¼“å­˜å±‚
  - Caffeine ç¼“å­˜
  - ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

## ğŸ’¡ è®¾è®¡ä¼˜åŠ¿

### 1. æ‰©å±•æ€§å¼º
- æ–°å¢æä¾›å•†åªéœ€å®ç° `PPLService` æ¥å£
- é—¨é¢ç±»è‡ªåŠ¨è¯†åˆ«å’Œæ³¨å†Œ

### 2. é…ç½®çµæ´»
- æ”¯æŒ YAML é…ç½®
- æ”¯æŒç¯å¢ƒå˜é‡
- æ”¯æŒåŠ¨æ€åˆ‡æ¢

### 3. é™çº§å¯é 
- è‡ªåŠ¨é™çº§åˆ°å¤‡ç”¨æä¾›å•†
- å¯é…ç½®é™çº§é¡ºåº
- å¤±è´¥é‡è¯•æœºåˆ¶

### 4. ç›‘æ§å®Œå–„
- æ¯ä¸ªæä¾›å•†ç‹¬ç«‹æŒ‡æ ‡
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡ï¼ˆONNXï¼‰
- æˆæœ¬ç»Ÿè®¡ï¼ˆOpenAIï¼‰

## ğŸ‰ é˜¶æ®µæ€§æˆæœ

Phase 1 å·²å®Œæˆï¼š
- âœ… 7 ä¸ªæ ¸å¿ƒç±»æ–‡ä»¶
- âœ… å®Œæ•´çš„é…ç½®ç³»ç»Ÿ
- âœ… é™çº§å’Œç›‘æ§æœºåˆ¶
- âœ… æ¸…æ™°çš„æ¶æ„è®¾è®¡
- âœ… è¯¦ç»†çš„ä»£ç æ³¨é‡Š

**ä»£ç è¡Œæ•°**ï¼š~1200 è¡Œ
**é…ç½®è¡Œæ•°**ï¼š~60 è¡Œ
**æ–‡æ¡£è¡Œæ•°**ï¼š~500 è¡Œï¼ˆè®¡åˆ’æ–‡æ¡£ï¼‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-12-04 20:30:00  
**ä¸‹ä¸€é˜¶æ®µ**ï¼šPhase 2 - ONNX å®ç°ï¼ˆé¢„è®¡ 3-4 å¤©ï¼‰  
**çŠ¶æ€**ï¼šâœ… Phase 1 å®Œæˆï¼Œå¯ä»¥å¼€å§‹ Phase 2

