<!DOCTYPE html>
<html lang="zh-CN" id="html-root">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿ - Knowledge Base QA System</title>
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">

    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="assets/css/github.min.css">
    <link rel="stylesheet" href="assets/css/reset.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/datepicker.css">
    <link rel="stylesheet" href="assets/css/qa-tab.css">
    <link rel="stylesheet" href="assets/css/documents-tab.css">
    <link rel="stylesheet" href="assets/css/statistics-tab.css">
    <link rel="stylesheet" href="assets/css/ai-analysis.css">
    <link rel="stylesheet" href="assets/css/llm-results-tab.css">

    <!-- React åº“ (ä½¿ç”¨ CDN æˆ–æœ¬åœ°æ–‡ä»¶) -->
    <script crossorigin src="js/lib/react.production.min.js"></script>
    <script crossorigin src="js/lib/react-dom.production.min.js"></script>

    <!-- Babel Standalone (ç”¨äºè½¬è¯‘ JSX) -->
    <script src="js/lib/babel.min.js"></script>

    <!-- Axios åº“ (ç”¨äº API è°ƒç”¨) -->
    <script src="js/lib/axios.min.js"></script>

    <!-- Marked.js (ç”¨äº Markdown æ¸²æŸ“) -->
    <script src="js/lib/marked.min.js"></script>

    <!-- Highlight.js (ç”¨äºä»£ç é«˜äº®) -->
    <link rel="stylesheet" href="assets/css/github.min.css">
    <script src="js/lib/highlight.min.js"></script>
</head>

<body>
    <div id="root"></div>

    <!-- åŠ è½½é¡ºåºï¼šä¾èµ– -> å·¥å…· -> ç»„ä»¶ -> ä¸»åº”ç”¨ -->

    <!-- 1. ç¿»è¯‘å­—å…¸ -->
    <script src="js/lang/lang.js"></script>

    <!-- 2. API æ¥å£ -->
    <script src="js/api/api.js"></script>

    <!-- 3. æ ·å¼å¸¸é‡ -->
    <script src="js/styles/constants.js"></script>

    <!-- 4. å…¬å…±ç»„ä»¶ -->
    <script src="js/components/common/LanguageContext.js"></script>
    <script src="js/components/common/DatePicker.js"></script>
    <script src="js/components/EmbeddedAIAnalysisPanel.js"></script>

    <!-- 4.1 åˆ†å±‚åé¦ˆå’Œä¸»åŠ¨å­¦ä¹ ç»„ä»¶ -->
    <script src="js/components/HierarchicalFeedbackPanel.js"></script>
    <script src="js/components/ActiveLearningPanel.js"></script>

    <!-- 5. UIç»„ä»¶åº“ -->
    <script type="text/babel" src="js/components/tabs/DocumentsTabComponents.jsx"></script>

    <!-- 6. æ ‡ç­¾é¡µç»„ä»¶ (JSXç‰ˆæœ¬) -->
    <script type="text/babel" src="js/components/tabs/QATab.jsx"></script>
    <script type="text/babel" src="js/components/tabs/DocumentsTab.jsx"></script>
    <script type="text/babel" src="js/components/tabs/StatisticsTab.jsx"></script>
    <script type="text/babel" src="js/components/tabs/LLMResultsTab.jsx"></script>

    <!-- 7. ä¸»åº”ç”¨ - ç®€åŒ–ç‰ˆ -->
    <!-- ä½¿ç”¨ type="text/babel" ç¡®ä¿åœ¨æ‰€æœ‰JSXè½¬è¯‘å®Œæˆåæ‰§è¡Œ -->
    <script type="text/babel">
        (function () {
            console.log('ğŸš€ Starting application initialization...');

            // ç­‰å¾…æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæˆ
            const checkComponentsLoaded = () => {
                const deps = {
                    React: !!window.React,
                    ReactDOM: !!window.ReactDOM,
                    axios: !!window.axios,
                    marked: !!window.marked,
                    hljs: !!window.hljs,
                    translations: !!window.translations,
                    api: !!window.api,
                    StyleConstants: !!window.StyleConstants,
                    LanguageModule: !!window.LanguageModule,
                    QATab: !!window.QATab,
                    DocumentsTab: !!window.DocumentsTab,
                    StatisticsTab: !!window.StatisticsTab,
                    LLMResultsTab: !!window.LLMResultsTab,
                    DocumentsTabComponents: !!window.DocumentsTabComponents
                };

                console.log('Checking dependencies:', deps);

                // æ£€æŸ¥å…³é”®ä¾èµ–
                if (!window.LanguageModule || !window.api || !window.StyleConstants || !window.translations) {
                    console.error('âŒ Required modules not loaded:', {
                        LanguageModule: !!window.LanguageModule,
                        api: !!window.api,
                        StyleConstants: !!window.StyleConstants,
                        translations: !!window.translations
                    });
                    return false;
                }

                // æ£€æŸ¥Tabç»„ä»¶
                if (!window.QATab || !window.DocumentsTab || !window.StatisticsTab) {
                    console.warn('âš ï¸ Tab components not ready yet:', {
                        QATab: !!window.QATab,
                        DocumentsTab: !!window.DocumentsTab,
                        StatisticsTab: !!window.StatisticsTab
                    });
                    return false;
                }

                return true;
            };

            // å°è¯•åŠ è½½ï¼Œå¦‚æœç»„ä»¶æœªå°±ç»ªåˆ™ç­‰å¾…
            let attempts = 0;
            const maxAttempts = 20;

            const tryInitialize = () => {
                attempts++;

                if (checkComponentsLoaded()) {
                    console.log('âœ… All dependencies loaded successfully');
                    initializeApp();
                } else if (attempts < maxAttempts) {
                    console.log(`â³ Waiting for components... (attempt ${attempts}/${maxAttempts})`);
                    setTimeout(tryInitialize, 100);
                } else {
                    console.error('âŒ Failed to load all components after', maxAttempts, 'attempts');
                    document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">âŒ ç»„ä»¶åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•<br/>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</div>';
                }
            };

            const initializeApp = () => {

                // ä»å…¨å±€å¯¹è±¡ä¸­è§£æ„éœ€è¦çš„æ¨¡å—
                const { LanguageProvider, useTranslation } = window.LanguageModule;
                const { useState, useEffect } = React;

                // ä¸»åº”ç”¨ç»„ä»¶
                function App() {
                    const { t, toggleLanguage, language } = useTranslation();
                    const [activeTab, setActiveTab] = useState('qa');
                    const [health, setHealth] = useState(null);

                    // AIåˆ†æé¢æ¿çŠ¶æ€
                    const [showAIAnalysis, setShowAIAnalysis] = useState(false);
                    const [selectedDocs, setSelectedDocs] = useState(new Set());
                    const [selectedDocsData, setSelectedDocsData] = useState([]); // å­˜å‚¨å®Œæ•´çš„æ–‡æ¡£å¯¹è±¡
                    const [splitPosition, setSplitPosition] = useState(() => {
                        const saved = localStorage.getItem('aiAnalysisSplitPosition');
                        return saved ? parseFloat(saved) : 50;
                    });
                    const [isDragging, setIsDragging] = useState(false);

                    useEffect(() => {
                        console.log('ğŸ“¡ App mounted, checking health...');
                        checkHealth();

                        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æœåŠ¡çŠ¶æ€
                        const intervalId = setInterval(() => {
                            console.log('ğŸ”„ Auto checking health status...');
                            checkHealth();
                        }, 30000); // 30ç§’ = 30000æ¯«ç§’

                        // æ¸…ç†å®šæ—¶å™¨
                        return () => {
                            console.log('ğŸ§¹ Cleaning up health check interval');
                            clearInterval(intervalId);
                        };
                    }, []);

                    // å¤„ç†åˆ†éš”çº¿æ‹–æ‹½
                    useEffect(() => {
                        if (!isDragging) return;

                        const handleMouseMove = (e) => {
                            const newPosition = (e.clientX / window.innerWidth) * 100;
                            if (newPosition > 20 && newPosition < 80) {
                                setSplitPosition(newPosition);
                                localStorage.setItem('aiAnalysisSplitPosition', newPosition.toString());
                            }
                        };

                        const handleMouseUp = () => {
                            setIsDragging(false);
                        };

                        document.addEventListener('mousemove', handleMouseMove);
                        document.addEventListener('mouseup', handleMouseUp);

                        return () => {
                            document.removeEventListener('mousemove', handleMouseMove);
                            document.removeEventListener('mouseup', handleMouseUp);
                        };
                    }, [isDragging]);

                    const checkHealth = async () => {
                        try {
                            console.log('ğŸ” Calling health API...');
                            const result = await window.api.health();
                            console.log('âœ… Health check result:', result);
                            setHealth(result);
                        } catch (err) {
                            console.error('âŒ Health check error:', err);
                            setHealth({ status: t('statusOffline'), message: 'Service connection failed' });
                        }
                    };

                    // åˆ¤æ–­çŠ¶æ€å¹¶æ·»åŠ å›¾æ ‡
                    const getStatusWithIcon = (status) => {
                        if (!status) return '';
                        // å¦‚æœçŠ¶æ€æ–‡æœ¬ä¸­å·²ç»æœ‰emojiå›¾æ ‡ï¼Œç›´æ¥è¿”å›
                        if (/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(status)) {
                            return status;
                        }
                        // æ ¹æ®çŠ¶æ€æ–‡æœ¬æ·»åŠ å¯¹åº”å›¾æ ‡
                        const isOnline = status === 'UP' || status === 'è¿è¡Œä¸­' || status.toLowerCase().includes('online') || status.includes('è¿è¡Œ');
                        return isOnline ? `âœ… ${status}` : `âŒ ${status}`;
                    };

                    return (
                        <div style={{ position: 'relative', width: '100%', minHeight: '100vh' }}>
                            {/* å·¦ä¾§ä¸»å†…å®¹åŒºåŸŸ */}
                            <div style={{
                                width: showAIAnalysis ? `${splitPosition}%` : '100%',
                                minHeight: '100vh',
                                overflow: 'auto',
                                transition: showAIAnalysis ? 'none' : 'width 0.3s',
                                display: 'flex',
                                justifyContent: 'center'
                            }}>
                                <div style={{
                                    width: '100%',
                                    maxWidth: showAIAnalysis ? '100%' : '1200px',
                                    padding: showAIAnalysis ? '0 10px' : '0'
                                }}>
                                    <div className="app-container">
                                        <div className="language-toggle">
                                            <button onClick={toggleLanguage}>{t('langToggle')}</button>
                                        </div>

                                        <header className="header">
                                            <h1>{t('title')}</h1>
                                            <p className="subtitle">{t('subtitle')}</p>
                                            {health && (
                                                <div style={{ marginTop: '10px', fontSize: '14px' }}>
                                                    {t('status')}: {getStatusWithIcon(health.status)}
                                                </div>
                                            )}
                                        </header>

                                        <main className="main-content">
                                            <div className="tabs">
                                                <button
                                                    className={`tab ${activeTab === 'qa' ? 'active' : ''}`}
                                                    onClick={() => setActiveTab('qa')}
                                                >
                                                    ğŸ’¬ {t('tabQA')}
                                                </button>
                                                <button
                                                    className={`tab ${activeTab === 'documents' ? 'active' : ''}`}
                                                    onClick={() => setActiveTab('documents')}
                                                >
                                                    ğŸ”ğŸ“ {t('tabDocumentsSearch')}
                                                </button>
                                                <button
                                                    className={`tab ${activeTab === 'llm-results' ? 'active' : ''}`}
                                                    onClick={() => setActiveTab('llm-results')}
                                                >
                                                    ğŸ“š {t('tabLLMResults') || 'AIåˆ†æå†å²'}
                                                </button>
                                                <button
                                                    className={`tab ${activeTab === 'stats' ? 'active' : ''}`}
                                                    onClick={() => setActiveTab('stats')}
                                                >
                                                    ğŸ“Š {t('tabStats')}
                                                </button>
                                            </div>

                                            <div className="tab-content">
                                                <div style={{ display: activeTab === 'qa' ? 'block' : 'none' }}>
                                                    <QATab />
                                                </div>
                                                <div style={{ display: activeTab === 'documents' ? 'block' : 'none' }}>
                                                    <DocumentsTab
                                                        showAIAnalysis={showAIAnalysis}
                                                        setShowAIAnalysis={setShowAIAnalysis}
                                                        selectedDocs={selectedDocs}
                                                        setSelectedDocs={setSelectedDocs}
                                                        selectedDocsData={selectedDocsData}
                                                        setSelectedDocsData={setSelectedDocsData}
                                                    />
                                                </div>
                                                <div style={{ display: activeTab === 'llm-results' ? 'block' : 'none' }}>
                                                    {window.LLMResultsTab && <LLMResultsTab />}
                                                </div>
                                                <div style={{ display: activeTab === 'stats' ? 'block' : 'none' }}>
                                                    <StatisticsTab />
                                                </div>
                                            </div>
                                        </main>

                                        <footer className="footer">
                                            <p>{t('footerText')}</p>
                                        </footer>
                                    </div>
                                </div>
                            </div>

                            {/* æ‹–æ‹½åˆ†éš”çº¿ */}
                            {showAIAnalysis && (
                                <div
                                    style={{
                                        position: 'fixed',
                                        left: `${splitPosition}%`,
                                        top: 0,
                                        bottom: 0,
                                        width: '6px',
                                        backgroundColor: isDragging ? '#2196F3' : '#e0e0e0',
                                        cursor: 'ew-resize',
                                        zIndex: 1000,
                                        transition: isDragging ? 'none' : 'background-color 0.2s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                    onMouseDown={() => setIsDragging(true)}
                                >
                                    <div style={{
                                        width: '20px',
                                        height: '60px',
                                        backgroundColor: isDragging ? '#2196F3' : '#999',
                                        borderRadius: '4px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontSize: '16px',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                                    }}>
                                        â‹®
                                    </div>
                                </div>
                            )}

                            {/* AIåˆ†æå³ä¾§é¢æ¿ */}
                            {showAIAnalysis && (
                                <div style={{
                                    position: 'fixed',
                                    left: `calc(${splitPosition}% + 6px)`,
                                    top: 0,
                                    right: 0,
                                    bottom: 0,
                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    overflowY: 'auto',
                                    boxShadow: '-2px 0 12px rgba(0,0,0,0.3)',
                                    zIndex: 999,
                                    padding: '20px'
                                }}>
                                    <div style={{
                                        marginBottom: '20px',
                                        paddingBottom: '15px',
                                        borderBottom: '2px solid rgba(255,255,255,0.3)'
                                    }}>
                                        <h2 style={{
                                            margin: 0,
                                            color: '#ffffff',
                                            fontSize: '24px',
                                            textShadow: '0 2px 4px rgba(0,0,0,0.2)'
                                        }}>
                                            ğŸ¤– {t('aiAnalysis') || 'AIåˆ†æ'}
                                        </h2>
                                        <p style={{
                                            margin: '8px 0 0 0',
                                            color: 'rgba(255,255,255,0.9)',
                                            fontSize: '14px'
                                        }}>
                                            {selectedDocs.size > 0
                                                ? t('selectedDocumentsCount').replace('{0}', selectedDocs.size)
                                                : t('pleaseCheckDocumentsOnLeft')}
                                        </p>
                                    </div>

                                    {window.EmbeddedAIAnalysisPanel && React.createElement(window.EmbeddedAIAnalysisPanel, {
                                        selectedDocuments: selectedDocsData,
                                        onClose: () => setShowAIAnalysis(false)
                                    })}
                                </div>
                            )}
                        </div>
                    );
                }

                // æ¸²æŸ“åº”ç”¨
                console.log('ğŸ¨ Rendering application...');
                try {
                    ReactDOM.render(
                        <LanguageProvider>
                            <App />
                        </LanguageProvider>,
                        document.getElementById('root')
                    );
                    console.log('âœ… Application rendered successfully');
                } catch (error) {
                    console.error('âŒ Rendering error:', error);
                    document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">âŒ æ¸²æŸ“å¤±è´¥: ' + error.message + '<br/>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</div>';
                }
            };

            // å¼€å§‹å°è¯•åˆå§‹åŒ–
            tryInitialize();
        })(); // ç»“æŸç«‹å³æ‰§è¡Œå‡½æ•°
    </script>
</body>

</html>

