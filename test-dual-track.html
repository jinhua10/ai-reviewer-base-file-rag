<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒè½¨æµå¼æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .output {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            min-height: 200px;
            background: #f9f9f9;
        }
        .hope {
            background: #e6f7ff;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #1890ff;
        }
        .llm {
            background: #f6ffed;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #52c41a;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        input {
            width: 400px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ åŒè½¨æµå¼æ¥å£æµ‹è¯•</h1>

    <div>
        <input type="text" id="question" value="ä½ å¥½" placeholder="è¾“å…¥é—®é¢˜">
        <button onclick="startStreaming()">å¼€å§‹åŒè½¨æµå¼</button>
        <button onclick="stopStreaming()">åœæ­¢</button>
    </div>

    <div class="output" id="output">
        <p>ç­‰å¾…è¾“å…¥...</p>
    </div>

    <script>
        let eventSource = null;

        function startStreaming() {
            const question = document.getElementById('question').value;
            const output = document.getElementById('output');
            output.innerHTML = '<p>ğŸ”„ è¿æ¥ä¸­...</p>';

            // å…³é—­ä¹‹å‰çš„è¿æ¥
            if (eventSource) {
                eventSource.close();
            }

            // æ„å»º URL
            const url = `http://localhost:8080/api/qa/stream/dual-track?question=${encodeURIComponent(question)}`;
            console.log('ğŸ“¡ Connecting to:', url);

            eventSource = new EventSource(url);

            // ç›‘å¬ HOPE ç­”æ¡ˆ
            eventSource.addEventListener('hope', (event) => {
                console.log('ğŸ’¡ HOPE event:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    output.innerHTML += `<div class="hope">
                        <strong>ğŸ’¡ HOPE å¿«é€Ÿç­”æ¡ˆ (${data.responseTime}ms)</strong><br>
                        ${data.content}<br>
                        <small>æ¥æº: ${data.hopeSource}, ç½®ä¿¡åº¦: ${data.confidence}</small>
                    </div>`;
                } catch (e) {
                    console.error('è§£æ HOPE å¤±è´¥:', e);
                    output.innerHTML += `<div class="hope">HOPE: ${event.data}</div>`;
                }
            });

            // ç›‘å¬ LLM æµå¼å—
            eventSource.addEventListener('llm', (event) => {
                console.log('ğŸ“¦ LLM event:', event.data);
                try {
                    const data = JSON.parse(event.data);

                    // æŸ¥æ‰¾æˆ–åˆ›å»º LLM è¾“å‡ºå®¹å™¨
                    let llmDiv = document.getElementById('llm-output');
                    if (!llmDiv) {
                        llmDiv = document.createElement('div');
                        llmDiv.id = 'llm-output';
                        llmDiv.className = 'llm';
                        llmDiv.innerHTML = '<strong>ğŸ¤– LLM è¯¦ç»†ç­”æ¡ˆ</strong><br><div id="llm-content"></div>';
                        output.appendChild(llmDiv);
                    }

                    // è¿½åŠ å†…å®¹
                    document.getElementById('llm-content').innerHTML += data.content;
                } catch (e) {
                    console.error('è§£æ LLM å¤±è´¥:', e);
                    output.innerHTML += `<div class="llm">LLM: ${event.data}</div>`;
                }
            });

            // ç›‘å¬å®Œæˆäº‹ä»¶
            eventSource.addEventListener('complete', (event) => {
                console.log('âœ… Complete event:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    output.innerHTML += `<p>âœ… å®Œæˆï¼æ€»è®¡ ${data.totalChunks} å—ï¼Œè€—æ—¶ ${data.totalTime}ms</p>`;
                } catch (e) {
                    output.innerHTML += '<p>âœ… å®Œæˆï¼</p>';
                }
                eventSource.close();
            });

            // ç›‘å¬é”™è¯¯
            eventSource.onerror = (event) => {
                console.error('âŒ SSE Error:', event);
                output.innerHTML += '<p>âŒ è¿æ¥é”™è¯¯</p>';
                eventSource.close();
            };

            // ç›‘å¬æ‰“å¼€
            eventSource.onopen = () => {
                console.log('âœ… SSE Connected');
                output.innerHTML = '<p>âœ… å·²è¿æ¥ï¼Œç­‰å¾…å“åº”...</p>';
            };
        }

        function stopStreaming() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                document.getElementById('output').innerHTML += '<p>ğŸ›‘ å·²åœæ­¢</p>';
            }
        }
    </script>
</body>
</html>

