# ⚙️ 检索和问答配置指南

## 📋 配置说明

所有配置项都在 `src/main/resources/application.yml` 中。

---

## 🎯 核心配置项

### 1. 检索精度控制

```yaml
knowledge:
  qa:
    vector-search:
      # 向量相似度阈值 (0.0-1.0)
      # 越高越严格，建议 0.4-0.6
      # 只有相似度高于此阈值的文档才会被返回
      similarity-threshold: 0.5
      
      # 文档相关性评分阈值（Lucene 检索）
      # 低于此分数的文档会被过滤
      # 建议值：0.1-0.3
      min-score-threshold: 0.15
      
      # 检索返回的文档数量上限
      # 注意：实际返回数量会受相似度阈值和质量过滤影响
      top-k: 20
```

**调整建议**：
- **精度优先**：提高 `similarity-threshold`（0.6-0.7）和 `min-score-threshold`（0.2-0.3）
- **召回优先**：降低阈值（0.3-0.4 和 0.1-0.15）
- **平衡模式**：默认值（0.5 和 0.15）

---

### 2. 问答性能控制

```yaml
knowledge:
  qa:
    llm:
      # 单次问答最大处理文档数
      # 用于防止内存溢出和控制响应时间
      # 如果检索到的文档超过此数量，会分批处理
      # 建议值：5-15
      max-documents-per-query: 10
      
      # 是否启用分批处理模式
      # 启用后，如果文档数超过 max-documents-per-query，
      # 会在答案中提示用户还有未处理的文档，支持继续提问
      enable-batch-processing: true
      
      # 最大上下文长度（字符数）
      # 建议值：
      #   - DeepSeek: 20000-32000 (32K tokens)
      #   - GPT-4o: 50000-100000 (128K tokens)
      #   - Claude-3: 100000-200000 (200K tokens)
      max-context-length: 20000
      
      # 单文档最大长度（字符数）
      # 建议值：max-context-length 的 1/4 到 1/2
      max-doc-length: 5000
```

**调整建议**：
- **内存充足** (8GB+)：设置 `max-documents-per-query: 15`
- **内存有限** (4GB)：设置 `max-documents-per-query: 5-8`
- **追求速度**：减少 `max-documents-per-query` 和 `max-doc-length`
- **追求完整性**：增加值，但要注意内存

---

## 📊 典型场景配置

### 场景 1: 高精度场景（法律、医疗）

```yaml
vector-search:
  similarity-threshold: 0.7      # 高阈值
  min-score-threshold: 0.25      # 高阈值
  top-k: 10                      # 少量文档

llm:
  max-documents-per-query: 5     # 精选文档
  max-context-length: 15000
```

**特点**：只返回最相关的文档，宁缺勿滥

---

### 场景 2: 高召回场景（知识探索、研究）

```yaml
vector-search:
  similarity-threshold: 0.3      # 低阈值
  min-score-threshold: 0.1       # 低阈值
  top-k: 30                      # 多量文档

llm:
  max-documents-per-query: 15    # 大量文档
  enable-batch-processing: true  # 启用分批
  max-context-length: 30000
```

**特点**：尽可能多地返回相关文档，支持多轮对话

---

### 场景 3: 平衡模式（通用场景）- **推荐**

```yaml
vector-search:
  similarity-threshold: 0.5      # 中等阈值
  min-score-threshold: 0.15      # 中等阈值
  top-k: 20                      # 适中

llm:
  max-documents-per-query: 10    # 适中
  enable-batch-processing: true  # 启用
  max-context-length: 20000
```

**特点**：平衡精度和召回，适合大多数场景

---

## 🔍 效果示例

### 配置前（默认）
```
用户提问："为什么要节约用水"
检索结果：70 个文档命中
实际相关：约 10 个
问题：大量无关文档，内存溢出
```

### 配置后（推荐）
```
用户提问："为什么要节约用水"
检索结果：15 个文档命中（过滤了 55 个低分）
本次使用：10 个文档
剩余：5 个文档（可继续提问）
效果：✅ 精准、快速、无内存问题
```

---

## 🎛️ 调优流程

### 1. 观察日志

系统会输出详细的检索日志：

```
🔍 提取关键词: 为什么要节约用水
📚 Lucene检索找到 40 个文档 (总命中: 70)
⚠️ 过滤了 25 个低分文档（评分 < 0.15）
🎯 向量检索找到 15 个文档
🎲 混合评分 Top-20
⚠️ 检索到 15 个文档，本次处理前 10 个
📋 剩余 5 个文档未处理
```

### 2. 根据日志调整

**如果过滤太多**：
- 降低 `min-score-threshold`（0.15 → 0.10）
- 降低 `similarity-threshold`（0.5 → 0.4）

**如果仍有无关文档**：
- 提高 `min-score-threshold`（0.15 → 0.20）
- 提高 `similarity-threshold`（0.5 → 0.6）

**如果内存溢出**：
- 减少 `max-documents-per-query`（10 → 8 或 5）
- 减少 `max-doc-length`（5000 → 3000）

**如果响应太慢**：
- 减少 `max-documents-per-query`
- 减少 `top-k`

---

## 📈 性能指标参考

| 配置 | 内存占用 | 响应时间 | 精度 | 召回 |
|------|---------|---------|------|------|
| **高精度** | 400MB | 1-2s | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| **平衡** | 600MB | 2-4s | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **高召回** | 1GB | 4-6s | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 🚀 快速开始

### 1. 使用默认配置

直接运行，适合大多数场景。

### 2. 根据需求调整

编辑 `application.yml`，重启服务即可生效。

### 3. 观察效果

查看日志，了解检索和过滤情况。

### 4. 持续优化

根据实际使用效果微调参数。

---

**配置文件位置**: `src/main/resources/application.yml`  
**修改后**: 重启服务生效  
**建议**: 先使用默认配置，根据实际情况调整

